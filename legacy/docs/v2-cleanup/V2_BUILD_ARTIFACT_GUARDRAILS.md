# V2 Build Artifact Guardrails

## Overview

This document describes the guardrails in place to prevent build artifacts from being committed to the `architecture/v2-bootstrap` branch and any future v2 development branches.

## Why This Matters

Build artifacts (compiled code, generated files, build outputs) should **never** be committed to version control because:

- They bloat repository size
- They create merge conflicts
- They can become stale and inconsistent with source code
- They are environment-specific and non-portable
- They can be regenerated from source at any time

## Protected Artifact Types

The following artifact types are **blocked** from being committed:

### 1. Gradle / Android Build Outputs
- `**/build/` directories (all build outputs)
- `.gradle/` caches
- `*.class` compiled Java/Kotlin files
- `.externalNativeBuild` native build artifacts
- `.cxx` C++ build artifacts

### 2. ObjectBox Generated Code
- `MyObjectBox.java` - Generated by ObjectBox annotation processor
- `MyObjectBox.kt` - Generated by ObjectBox annotation processor
- `**/objectbox-models/*.json` - **EXCEPT** `default.json` which is canonical

### 3. Allowed Exceptions
- `objectbox-models/default.json` - This is the **only** ObjectBox model file that should be committed (canonical schema definition)

## Enforcement Mechanisms

### 1. Root `.gitignore`

The root `.gitignore` file contains comprehensive patterns:

```gitignore
# Gradle / Android build outputs - prevent ALL build artifacts
**/build/
.gradle/
*.class
.externalNativeBuild
.cxx
local.properties
/captures

# ObjectBox generated artifacts - allow only canonical model file
**/objectbox-models/
!**/objectbox-models/default.json
**/MyObjectBox.java
**/MyObjectBox.kt
```

These patterns ensure that Git ignores build artifacts by default.

### 2. PR Guard Workflow

The workflow `.github/workflows/v2_pr_guard_build_artifacts.yml` runs automatically on every PR to `architecture/v2-bootstrap`:

- Scans all changed files in the PR
- Detects build artifacts using pattern matching
- **Fails the PR immediately** if artifacts are found
- Posts a helpful comment with remediation steps

#### What the Guard Detects:
- Any file in a `build/` directory
- `.class` files
- `MyObjectBox.java` or `MyObjectBox.kt`
- Extra `objectbox-models/*.json` files (except `default.json`)

## Best Practices for Contributors

### Before Creating a PR

1. **Always run `git status`** before committing:
   ```bash
   git status
   ```
   
2. **Check for build artifacts** in staged files:
   ```bash
   git ls-files | grep "/build/" || echo "OK"
   git ls-files | grep "MyObjectBox" || echo "OK"
   git ls-files | grep "\.class$" || echo "OK"
   ```

3. **Clean build artifacts** regularly:
   ```bash
   ./gradlew clean
   ```

### If You Accidentally Commit Artifacts

1. **Remove from tracking** (without deleting local file):
   ```bash
   git rm --cached path/to/artifact
   ```

2. **Commit the removal**:
   ```bash
   git commit -m "Remove build artifacts from tracking"
   ```

3. **Push the fix**:
   ```bash
   git push
   ```

### If PR Guard Fails

The PR guard will fail with a clear message listing the problematic files. Follow these steps:

1. **Review the failed check** output to see which files are problematic
2. **Remove artifacts from tracking**:
   ```bash
   git rm --cached <file1> <file2> ...
   ```
3. **Verify .gitignore** patterns are correct
4. **Commit and push** the fix
5. The PR guard will re-run automatically

## Verification Commands

Run these commands to verify no artifacts are tracked:

```bash
# Check for build directories
git ls-files | grep "/build/" || echo "✅ No build paths tracked"

# Check for MyObjectBox generated files
git ls-files | grep "MyObjectBox" || echo "✅ No MyObjectBox files tracked"

# Check for .class files
git ls-files | grep "\.class$" || echo "✅ No .class files tracked"

# Check ObjectBox models (should only show default.json)
git ls-files | grep "objectbox-models"
```

Expected output: Only `app/objectbox-models/default.json` should be listed.

## Maintenance

### Updating Ignore Patterns

If new artifact types need to be blocked:

1. Update `.gitignore` with new patterns
2. Update the PR guard workflow regex in `v2_pr_guard_build_artifacts.yml`
3. Update this documentation
4. Test with a sample PR

### Testing the PR Guard

To test the PR guard locally:

```bash
# Simulate the PR guard check
CHANGED=$(git diff --name-only origin/architecture/v2-bootstrap...HEAD)
echo "$CHANGED" | grep -E '(^|/)build/|\.class$|MyObjectBox\.(java|kt)|objectbox-models/.*\.json' \
  | grep -v '/objectbox-models/default\.json$' && echo "FAIL: Artifacts found" || echo "PASS: No artifacts"
```

## Related Documentation

- Root `.gitignore` - Comprehensive ignore patterns
- `.github/workflows/v2_pr_guard_build_artifacts.yml` - PR guard workflow
- `AGENTS_V2.md` - V2 architecture agent instructions
- `v2-docs/ARCHITECTURE_OVERVIEW_V2.md` - V2 architecture overview
- `docs/v2-cleanup/PHASE_2_IMPLEMENTATION_STATUS.md` - Phase 2 core persistence implementation status

## Recent Updates

### 2025-12-05: Phase 2 Core Persistence Implementation

- ✅ Successfully implemented ObjectBox persistence layer for v2
- ✅ Zero build artifacts committed (verified with `git ls-files | grep "/build/"`)
- ✅ `.gitignore` patterns working correctly
- ✅ 19 ObjectBox entities with proper code generation
- ✅ All generated code remains in ignored `build/` directories
- ✅ Only source files and tests committed to repository

The Phase 2 implementation serves as validation that the build artifact guardrails are working as intended.

## Questions?

If you have questions about build artifacts or these guardrails, please:
1. Review this document carefully
2. Check the `.gitignore` patterns
3. Ask in the PR or issue comments
