# AGENTS â€“ FishIT-Player v2 (architecture/v2-bootstrap)

> **âš ï¸ GENERATED FILE - DO NOT EDIT MANUALLY**
> 
> This file is automatically generated from `docs/meta/AGENT_RULES_CANONICAL.md`.
> To make changes, edit the canonical source and regenerate this file.
> CI checks ensure files remain synchronized.


> **Branch:** `architecture/v2-bootstrap` | **Namespace:** `com.fishit.player.*`

---

## ðŸš¨ HARD RULES (NON-NEGOTIABLE)

```yaml
MUST_READ_BEFORE_ANY_CHANGE:
  - /contracts/GLOSSARY_v2_naming_and_modules.md
  - Relevant scope file from /.scope/
  - Module README.md if modifying that module

NEVER_DO:
  - Merge to main from v2 branches
  - Edit files under /legacy/** or /app/**
  - Use namespace com.chris.m3usuite outside legacy/
  - Reintroduce TdlibClientProvider (v1 pattern)
  - Add Obx* imports in UI/ViewModel/feature modules
  - Call pipelines directly from Workers (use CatalogSyncWorkScheduler)
  - Import pipeline/** or data/** from player/** modules

ALWAYS_DO:
  - Check /.scope/*.scope.json before editing covered files
  - Read module README.md before modifying files
  - Follow @Multibinds + @IntoSet pattern for playback sources
  - Use NxWorkRepository for UI (not Obx* repositories)
```

---

## Layer Boundaries

```
UI â†’ Domain â†’ Data â†’ Pipeline â†’ Transport â†’ core:model
```

| Layer | ALLOWED Imports | FORBIDDEN Imports |
|-------|-----------------|-------------------|
| **UI/Feature** | Domain, core:model | Obx*, Pipeline DTOs, Transport |
| **Domain** | Data repos, core:model | Pipeline, Transport, TDLib |
| **Data** | core:model, RawMediaMetadata | Pipeline DTOs (TelegramMediaItem, XtreamVodItem) |
| **Pipeline** | Transport wrappers (TgMessage), core:model | Persistence, Data, Playback, UI |
| **Transport** | core:model, TDLib/HTTP | Pipeline, Data, UI, Persistence |
| **Playback** | Transport interfaces, core:model | Pipeline DTOs |
| **Player** | PlaybackContext, PlaybackSourceFactory | Pipeline, Data, Transport impl |

---

## Path Rules

```yaml
ALLOWED_PATHS:  # May create/edit
  - /app-v2/**
  - /core/**
  - /infra/**
  - /feature/**
  - /player/**
  - /playback/**
  - /pipeline/**
  - /docs/v2/**
  - /docs/meta/**
  - /scripts/**
  - Root: AGENTS.md, V2_PORTAL.md, CHANGELOG.md, ROADMAP.md

READ_ONLY_PATHS:  # Reference only
  - /legacy/**
  - /app/**
  - /docs/legacy/**
  - /docs/archive/**
```

---

## Naming Contract

| Where | Pattern | Example |
|-------|---------|---------|
| Pipeline capability | `*CapabilityProvider` | `TelegramCapabilityProvider` |
| App feature | `*FeatureProvider` | `HomeFeatureProvider` |
| Transport | `*Client`, `*Adapter` | `XtreamApiClient` |
| Data | `*Repository`, `Obx*Entity`, `NX_*` | `NxWorkRepository` |
| Pipeline mapper | `*Mapper`, `*Extensions` | `TelegramMediaMapper` |

**FORBIDDEN:** `*FeatureProvider` in pipeline/* | `feature/` package in pipeline/* | `com.chris.m3usuite` outside legacy/

---

## SSOT Entities

```yaml
UI_SSOT:  # ONLY these for UI consumption
  entity: NX_Work
  relations: NX_WorkSourceRef, NX_WorkVariant, NX_WorkRelation, NX_WorkUserState
  repository: NxWorkRepository
  FORBIDDEN_IN_UI: Obx*, ObxCanonicalMedia*, ObxXtream*, ObxTelegram*

TRANSPORT_SSOT:
  telegram: DefaultTelegramClient (ONE instance)
  interfaces: TelegramAuthClient, TelegramHistoryClient, TelegramFileClient
  FORBIDDEN: Multiple TdlClient instances, TdlibClientProvider

SYNC_SSOT:
  orchestrator: core/catalog-sync
  scheduler: CatalogSyncWorkScheduler
  FORBIDDEN: Direct pipeline.sync() from workers
```

---

## Contract References

| Area | Contract |
|------|----------|
| Any change | `/contracts/GLOSSARY_v2_naming_and_modules.md` |
| Pipeline | `docs/v2/MEDIA_NORMALIZATION_CONTRACT.md` |
| Logging | `/contracts/LOGGING_CONTRACT_V2.md` |
| Player | `/contracts/INTERNAL_PLAYER_*.md` (all) |
| Telegram | `/contracts/TELEGRAM_PARSER_CONTRACT.md` |
| NX SSOT | `/contracts/NX_SSOT_CONTRACT.md` |
| Xtream Onboarding | `/contracts/XTREAM_ONBOARDING_CATEGORY_SELECTION_CONTRACT.md` |
| Xtream Sync | `/contracts/CATALOG_SYNC_WORKERS_CONTRACT_V2.md` |

---

## Scope Guard System

Before editing files in these modules, **READ the scope file first**:

| Module Path | Scope File |
|------------|------------|
| `core/catalog-sync/**` | `.scope/catalog-sync.scope.json` |
| `core/persistence/**` | `.scope/persistence.scope.json` |

Each scope file contains: `mandatoryReadBeforeEdit`, `globalInvariants`, `criticalFiles`, `forbiddenPatterns`

---

## Path-Scoped Instructions

Auto-applied rules in `.github/instructions/*.md`:

| Pattern | Instruction File |
|---------|------------------|
| `core/model/**` | `core-model.instructions.md` |
| `core/persistence/**` | `core-persistence.instructions.md` |
| `core/catalog-sync/**` | `core-catalog-sync.instructions.md` |
| `pipeline/**` | `pipeline.instructions.md` |
| `infra/transport-*/**` | `infra-transport.instructions.md` |
| `infra/data-*/**` | `infra-data.instructions.md` |
| `player/**` | `player.instructions.md` |
| `playback/**` | `playback.instructions.md` |
| `feature/**` | `feature-common.instructions.md` |

Full index: `.github/instructions/_index.instructions.md`

---

## Quick Checklists

### Pre-Change (MANDATORY)

- [ ] Read GLOSSARY contract
- [ ] Check if file has scope in `.scope/`
- [ ] Read module README.md
- [ ] Verify change is under allowed paths
- [ ] No forbidden imports in plan

### Post-Change (MANDATORY)

- [ ] No edits in /legacy/** or /app/**
- [ ] No com.chris.m3usuite outside legacy/
- [ ] Code compiles
- [ ] Naming follows Glossary patterns

---

## Detailed Rules (External Files)

| Topic | Location |
|-------|----------|
| Full checklists | `.scope/agent-checklists.rules.json` |
| Player migration phases | `docs/v2/internal-player/PLAYER_MIGRATION_STATUS.md` |
| Pipeline migration | `legacy/gold/EXTRACTION_SUMMARY.md` |
| MCP configuration | `.vscode/mcp.json`, `.devcontainer/devcontainer.json` |

---

> **Canonical Source:** `docs/meta/AGENT_RULES_CANONICAL.md`  
> **Sync:** `scripts/sync-agent-rules.sh`  
> **Full Archive:** `docs/meta/AGENT_RULES_CANONICAL_FULL_BACKUP.md`  
> **Scope Files:** `.scope/layer-boundaries.rules.json`, `.scope/naming-rules.yaml`, `.scope/agent-checklists.rules.json`
