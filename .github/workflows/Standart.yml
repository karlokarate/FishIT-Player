name: TDLib - Android Java (prebuilt BoringSSL, validated, doc-conform)

on:
  workflow_dispatch:
    inputs:
      rebuild_boringssl:
        description: "Fallback: build BoringSSL from source if prebuilt asset is missing (true/false)"
        required: false
        default: "false"

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 1 }
      - name: actionlint
        uses: reviewdog/action-actionlint@v1
        with:
          actionlint_flags: "--color always"

  tdlib:
    needs: lint
    runs-on: ubuntu-24.04

    env:
      ANDROID_PLATFORM: android-24
      # Hinweis: Wenn du auf r27d/r28/r29 gehst, bitte Prebuilts neu erzeugen & Tag/Suffix anpassen.
      NDK_VERSION: r27c
      TD_SRC_DIR: td
      REPO: karlokarate/FishIT-Player
      BORINGSSL_TAG: boringssl-28efc83e86dc-android24-ndk-r27c

    strategy:
      fail-fast: false
      matrix:
        include:
          - abi: arm64-v8a
            asset: boringssl-28efc83e86dc-android24-ndk-r27c-arm64-v8a.tar.zst
            sha:   boringssl-28efc83e86dc-android24-ndk-r27c-arm64-v8a.sha256
            expect_machine: "AArch64"
            expect_class: "ELF64"
          - abi: armeabi-v7a
            asset: boringssl-28efc83e86dc-android24-ndk-r27c-armeabi-v7a.tar.zst
            sha:   boringssl-28efc83e86dc-android24-ndk-r27c-armeabi-v7a.sha256
            expect_machine: "ARM"
            expect_class: "ELF32"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Install build deps
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y ninja-build cmake git curl unzip tar zstd openjdk-17-jdk gperf file
          echo "JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))" >> $GITHUB_ENV

      # Cache NDK
      - name: Cache NDK ${{ env.NDK_VERSION }}
        uses: actions/cache@v4
        with:
          key: ndk-${{ runner.os }}-${{ env.NDK_VERSION }}
          path: .ndk/android-ndk-${{ env.NDK_VERSION }}

      - name: Prepare Android NDK ${{ env.NDK_VERSION }}
        run: |
          set -euo pipefail
          mkdir -p .ndk && cd .ndk
          if [ ! -d "android-ndk-${NDK_VERSION}" ]; then
            curl -fsSLO "https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
            unzip -q "android-ndk-${NDK_VERSION}-linux.zip"
          fi
          echo "NDK_PATH=$PWD/android-ndk-${NDK_VERSION}" >> $GITHUB_ENV

      - name: Clone TDLib (official)
        run: |
          set -euo pipefail
          git clone --depth=1 https://github.com/tdlib/td.git "${TD_SRC_DIR}"

      # --- Download + Stage prebuilt BoringSSL ---
      - name: Download + stage prebuilt BoringSSL (${{ matrix.abi }})
        id: stage_bssl
        run: |
          set -euo pipefail
          mkdir -p .third_party && cd .third_party
          BASE_URL="https://github.com/${REPO}/releases/download/${BORINGSSL_TAG}"
          ASSET="${{ matrix.asset }}"
          SHA_FILE="${{ matrix.sha }}"
          TMPDIR=".boringssl_tmp"
          mkdir -p "$TMPDIR" && cd "$TMPDIR"

          # PrÃ¼fen, ob Asset erreichbar
          CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "${BASE_URL}/${ASSET}")
          if [ "$CODE" != "200" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            echo "::warning ::Prebuilt asset missing (${BASE_URL}/${ASSET}, HTTP $CODE)"
            exit 0
          fi
          echo "found=true" >> $GITHUB_OUTPUT

          curl -fL "${BASE_URL}/${ASSET}" -o "${ASSET}"
          CODE_SHA=$(curl -s -o /dev/null -w "%{http_code}" -L "${BASE_URL}/${SHA_FILE}")
          if [ "$CODE_SHA" = "200" ]; then
            curl -fL "${BASE_URL}/${SHA_FILE}" -o "${SHA_FILE}"
            EXPECTED=$(sed -E 's/^([0-9a-fA-F]{64}).*$/\1/' "${SHA_FILE}" | head -n1)
            if [ -n "$EXPECTED" ]; then
              ACTUAL=$(sha256sum "${ASSET}" | awk '{print $1}')
              test "$EXPECTED" = "$ACTUAL" || { echo "::error ::SHA256 mismatch"; exit 10; }
            fi
          fi

          NAME="${ASSET%.tar.zst}"
          mkdir -p "${NAME}"
          tar --use-compress-program=unzstd -xf "${ASSET}" -C "${NAME}"

          ABI_DIR="$GITHUB_WORKSPACE/.third_party/boringssl/${{ matrix.abi }}"
          rm -rf "$ABI_DIR" && mkdir -p "$ABI_DIR" "$ABI_DIR/lib"

          INC_DIR="$(find "${NAME}" -type d -name include -print -quit)"
          SSL_LIB="$(find "${NAME}" -type f -name 'libssl.a' -print -quit)"
          CRYPTO_LIB="$(find "${NAME}" -type f -name 'libcrypto.a' -print -quit)"
          if [ -z "$INC_DIR" ] || [ -z "$SSL_LIB" ] || [ -z "$CRYPTO_LIB" ]; then
            echo "::group::Extracted tree"; ls -R "${NAME}"; echo "::endgroup::"
            echo "::error ::Missing include/ or libssl.a/libcrypto.a in prebuilt asset"
            exit 11
          fi

          mkdir -p "$ABI_DIR/include"
          cp -a "$INC_DIR/." "$ABI_DIR/include/"
          cp -f "$SSL_LIB" "$ABI_DIR/libssl.a"
          cp -f "$CRYPTO_LIB" "$ABI_DIR/libcrypto.a"
          ln -sf ../libssl.a    "$ABI_DIR/lib/libssl.a"
          ln -sf ../libcrypto.a "$ABI_DIR/lib/libcrypto.a"

          echo "BORINGSSL_DIR=$ABI_DIR" >> $GITHUB_ENV
          echo "BORINGSSL_ASSET=$ASSET" >> $GITHUB_ENV
          echo "::group::Staged BoringSSL"; ls -R "$ABI_DIR"; echo "::endgroup::"

      # --- Optionaler Fallback: BoringSSL aus Source bauen ---
      - name: Fallback: build BoringSSL from source (${{ matrix.abi }})
        if: steps.stage_bssl.outputs.found != 'true' && inputs.rebuild_boringssl == 'true'
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          git clone --depth=1 https://boringssl.googlesource.com/boringssl bssl-src
          mkdir -p bssl-build-${{ matrix.abi }} && cd bssl-build-${{ matrix.abi }}
          cmake -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE="$NDK_PATH/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI="${{ matrix.abi }}" \
            -DANDROID_PLATFORM="${ANDROID_PLATFORM}" \
            -DCMAKE_BUILD_TYPE=Release ../bssl-src
          ninja ssl crypto
          ABI_DIR="$GITHUB_WORKSPACE/.third_party/boringssl/${{ matrix.abi }}"
          rm -rf "$ABI_DIR" && mkdir -p "$ABI_DIR/include" "$ABI_DIR/lib"
          cp -a "$GITHUB_WORKSPACE/bssl-src/include/." "$ABI_DIR/include/"
          cp -f "crypto/libcrypto.a" "$ABI_DIR/libcrypto.a"
          cp -f "ssl/libssl.a" "$ABI_DIR/libssl.a"
          ln -sf ../libssl.a    "$ABI_DIR/lib/libssl.a"
          ln -sf ../libcrypto.a "$ABI_DIR/lib/libcrypto.a"
          echo "BORINGSSL_DIR=$ABI_DIR" >> $GITHUB_ENV
          echo "BORINGSSL_ASSET=(built-from-source)" >> $GITHUB_ENV

      - name: Dump tool versions
        run: |
          cmake --version || true
          ninja --version || true
          "$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++" --version || true

      # --- Preflight: jetzt mit clang++ und C++-Runtimes ---
      - name: Preflight link check (${{ matrix.abi }})
        run: |
          set -euo pipefail
          ABI="${{ matrix.abi }}"
          SSL_DIR="${BORINGSSL_DIR}"
          API_LEVEL="${ANDROID_PLATFORM#android-}"
          if [ "$ABI" = "arm64-v8a" ]; then
            TRIPLE="aarch64-linux-android"
          else
            TRIPLE="armv7a-linux-androideabi"
          fi
          CXX="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/${TRIPLE}${API_LEVEL}-clang++"

          CXXFLAGS="-fPIC"
          LDFLAGS="-Wl,--start-group ${SSL_DIR}/libssl.a ${SSL_DIR}/libcrypto.a -Wl,--end-group -llog -landroid -ldl -latomic -lz -lc++_static -lc++abi"
          if [ "$ABI" = "armeabi-v7a" ]; then
            CXXFLAGS="$CXXFLAGS -march=armv7-a -mfpu=neon -mfloat-abi=softfp"
            LDFLAGS="$LDFLAGS -Wl,--fix-cortex-a8"
          fi

          cat > preflight.cc <<'EOF'
          #include <openssl/ssl.h>
          int main(){ return 0; }
          EOF
          "$CXX" -shared preflight.cc -o libpreflight.so $CXXFLAGS $LDFLAGS
          echo "Preflight link passed for ${ABI}"

      - name: Validate prebuilt BoringSSL ABI (${{ matrix.abi }})
        run: |
          set -Eeuo pipefail
          SSL_DIR="${BORINGSSL_DIR}"
          test -d "$SSL_DIR/include" && test -f "$SSL_DIR/libssl.a" && test -f "$SSL_DIR/libcrypto.a"
          AR="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          READELF="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-readelf"
          check() {
            local A="$1" M="$2" C="$3" L="$4"
            local T="$(mktemp -d)"
            (cd "$T" && "$AR" x "$A")
            local F="$(find "$T" -type f -name '*.o' -print -quit)"
            "$READELF" -h "$F" | grep -Eq "Machine: *$M"
            "$READELF" -h "$F" | grep -Eq "Class: *$C"
            rm -rf "$T"
          }
          check "$SSL_DIR/libssl.a"    "${{ matrix.expect_machine }}" "${{ matrix.expect_class }}" "libssl.a"
          check "$SSL_DIR/libcrypto.a" "${{ matrix.expect_machine }}" "${{ matrix.expect_class }}" "libcrypto.a"

      - name: Build TDLib (${{ matrix.abi }})
        run: |
          set -euo pipefail
          ABI="${{ matrix.abi }}"
          BUILD_DIR="build-${ABI}"
          SSL_DIR="${BORINGSSL_DIR}"

          EXTRA_CFLAGS="-fPIC"
          EXTRA_LDFLAGS_BASE="-Wl,--start-group ${SSL_DIR}/libssl.a ${SSL_DIR}/libcrypto.a -Wl,--end-group -llog -landroid -ldl -latomic -lz"
          EXTRA_LDFLAGS=""
          EXTRA_CMAKE="-DCMAKE_EXPORT_COMPILE_COMMANDS=ON"
          if [ "$ABI" = "armeabi-v7a" ]; then
            EXTRA_CFLAGS="${EXTRA_CFLAGS} -march=armv7-a -mfpu=neon -mfloat-abi=softfp"
            EXTRA_LDFLAGS="${EXTRA_LDFLAGS} -Wl,--fix-cortex-a8"
            EXTRA_CMAKE="${EXTRA_CMAKE} -DANDROID_ARM_NEON=ON"
          fi

          mkdir -p "$BUILD_DIR" && cd "$BUILD_DIR"
          cmake -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE="$NDK_PATH/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI="${ABI}" \
            -DANDROID_PLATFORM="${ANDROID_PLATFORM}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_INSTALL_PREFIX="$PWD/install" \
            -DTD_ENABLE_JNI=ON \
            -DTD_ENABLE_JAVA=ON \
            -DOPENSSL_ROOT_DIR="$SSL_DIR" \
            -DOPENSSL_INCLUDE_DIR="$SSL_DIR/include" \
            -DOPENSSL_SSL_LIBRARY="$SSL_DIR/libssl.a" \
            -DOPENSSL_CRYPTO_LIBRARY="$SSL_DIR/libcrypto.a" \
            -DOPENSSL_USE_STATIC_LIBS=ON \
            ${EXTRA_CMAKE} \
            -DCMAKE_C_FLAGS="${EXTRA_CFLAGS}" \
            -DCMAKE_CXX_FLAGS="${EXTRA_CFLAGS}" \
            -DCMAKE_SHARED_LINKER_FLAGS="${EXTRA_LDFLAGS_BASE} ${EXTRA_LDFLAGS}" \
            -DCMAKE_EXE_LINKER_FLAGS="${EXTRA_LDFLAGS_BASE} ${EXTRA_LDFLAGS}" \
            -DCMAKE_FIND_DEBUG_MODE=ON \
            "../${TD_SRC_DIR}"

          ninja -v 2>&1 | tee build-${ABI}.log
          ninja install
          echo "TDLib ${ABI} install -> $(pwd)/install"

      - name: Upload BoringSSL staging (${{ matrix.abi }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: boringssl-staged-${{ matrix.abi }}
          path: .third_party/boringssl/${{ matrix.abi }}/
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload CMake & Ninja logs (${{ matrix.abi }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.abi }}
          path: |
            build-${{ matrix.abi }}/CMakeFiles/CMakeError.log
            build-${{ matrix.abi }}/CMakeFiles/CMakeOutput.log
            build-${{ matrix.abi }}/build-${{ matrix.abi }}.log
            build-${{ matrix.abi }}/compile_commands.json
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload TDLib artifacts (${{ matrix.abi }})
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-android-${{ matrix.abi }}-boringssl-prebuilt
          path: build-${{ matrix.abi }}/install/
          if-no-files-found: error
          retention-days: 14