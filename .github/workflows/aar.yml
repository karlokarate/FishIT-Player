name: Pack TDLib AAR from artifacts (run 19267929354)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "AAR Version (z.B. 1.8.56-<shortsha>)"
        required: true
        default: "1.8.56-local"

permissions:
  contents: read
  packages: write

jobs:
  pack-aar:
    runs-on: ubuntu-24.04
    env:
      TDLIB_VERSION: ${{ github.event.inputs.version }}
      PRODUCER_RUN_ID: "19267929354"   # exakt dein Run

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 1 }

      # --- Exakte Artefakt-Namen/Run-ID ---
      - name: Download tdlib-java-bindings
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ env.PRODUCER_RUN_ID }}
          name: tdlib-java-bindings
          path: .artifacts/java
          if_no_artifact_found: fail

      - name: Download tdlib-android-arm64-v8a-boringssl
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ env.PRODUCER_RUN_ID }}
          name: tdlib-android-arm64-v8a-boringssl
          path: .artifacts/arm64
          if_no_artifact_found: fail

      - name: Download tdlib-android-armeabi-v7a-boringssl
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ env.PRODUCER_RUN_ID }}
          name: tdlib-android-armeabi-v7a-boringssl
          path: .artifacts/armeabi-v7a
          if_no_artifact_found: fail

      # --- AAR-Modul befÃ¼llen ---
      - name: Prepare tdlib-android module layout
        run: |
          set -euo pipefail
          mkdir -p tdlib-android/src/main/jniLibs/arm64-v8a
          mkdir -p tdlib-android/src/main/jniLibs/armeabi-v7a
          mkdir -p tdlib-android/src/main/java

          # Entpacke native Bundles (.tar.zst/.tar.gz/.zip)
          for f in .artifacts/arm64/*; do
            case "$f" in
              *.tar.zst|*.tar.gz|*.tar) tar -xf "$f" -C /tmp/a64 ;;
              *.zip) unzip -q "$f" -d /tmp/a64 ;;
            esac
          done
          for f in .artifacts/armeabi-v7a/*; do
            case "$f" in
              *.tar.zst|*.tar.gz|*.tar) tar -xf "$f" -C /tmp/v7a ;;
              *.zip) unzip -q "$f" -d /tmp/v7a ;;
            esac
          done

          # libtdjni.so herausziehen
          A64=$(fd -a -H -t f "^libtdjni\.so$" /tmp/a64 | head -n1)
          V7A=$(fd -a -H -t f "^libtdjni\.so$" /tmp/v7a | head -n1)
          cp -v "$A64" tdlib-android/src/main/jniLibs/arm64-v8a/libtdjni.so
          cp -v "$V7A" tdlib-android/src/main/jniLibs/armeabi-v7a/libtdjni.so

          # Java-Bindings extrahieren
          if ls .artifacts/java/*.zip >/dev/null 2>&1; then
            unzip -q .artifacts/java/*.zip -d /tmp/tdjava
            rsync -a /tmp/tdjava/org tdlib-android/src/main/java/
          else
            rsync -a .artifacts/java/org tdlib-android/src/main/java/ || true
          fi

          # Sanity-Checks
          test -s tdlib-android/src/main/jniLibs/arm64-v8a/libtdjni.so
          test -s tdlib-android/src/main/jniLibs/armeabi-v7a/libtdjni.so
          test -s tdlib-android/src/main/java/org/drinkless/tdlib/TdApi.java

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Gradle opts
        run: |
          echo "org.gradle.jvmargs=-Xmx2g -Dfile.encoding=UTF-8" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          echo "android.nonTransitiveRClass=true" >> gradle.properties

      - name: Build AAR
        run: ./gradlew :tdlib-android:assembleRelease

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-android-aar
          path: tdlib-android/build/outputs/aar/tdlib-android-release.aar

      - name: Publish to GitHub Packages
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew :tdlib-android:publish
