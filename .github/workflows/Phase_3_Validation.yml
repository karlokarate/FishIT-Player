name: Phase 3 Validation

on:
  workflow_dispatch: 
    inputs:
      branch:
        description: 'Branch to test'
        required: false
        default: 'copilot/implement-phase-3-ui-gating'

jobs:
  validate-phase3:
    name: Validate Debug Tools Isolation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'copilot/implement-phase-3-ui-gating' }}
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools:  34.0.0
          ndk-version: 26.1.10909125
      
      - name: Install bc (required for APK size calculation)
        run: sudo apt-get update && sudo apt-get install -y bc
      
      - name: Grant execute permission to validation script
        run: chmod +x test_phase3_validation.sh
      
      - name: Run Phase 3 Validation
        id: validation
        run: |
          set +e  # Don't exit on error, we want to capture output
          ./test_phase3_validation.sh > validation_output.txt 2>&1
          EXIT_CODE=$?
          cat validation_output.txt
          exit $EXIT_CODE
      
      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: validation_output.txt
          retention-days: 30
      
      - name: Upload Debug APK
        if: always()
        uses: actions/upload-artifact@v4
        with: 
          name: debug-apk
          path: app-v2/build/outputs/apk/debug/*.apk
          retention-days: 7
      
      - name: Upload Release APK
        if: always()
        uses: actions/upload-artifact@v4
        with: 
          name: release-apk
          path: app-v2/build/outputs/apk/release/*.apk
          retention-days: 7
      
      - name: Comment on PR (if applicable)
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with: 
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('validation_output.txt', 'utf8');
            const passed = ! output.includes('‚ùå FAIL');
            
            const comment = `## üß™ Phase 3 Validation Results
            
            ${passed ? '‚úÖ **ALL TESTS PASSED**' : '‚ùå **TESTS FAILED**'}
            
            <details>
            <summary>Full Test Output</summary>
            
            \`\`\`
            ${output}
            \`\`\`
            
            </details>
            
            **Artifacts:**
            - üìÑ [Validation Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - üì¶ [Debug APK](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - üì¶ [Release APK](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
      
      - name: Set workflow status
        if: always()
        run: |
          if [ -f validation_output.txt ]; then
            if grep -q "ALL TESTS PASSED" validation_output.txt; then
              echo "‚úÖ Validation successful"
              exit 0
            else
              echo "‚ùå Validation failed"
              exit 1
            fi
          else
            echo "‚ùå Validation output not found"
            exit 1
          fi