name: TDLib Cluster B - Sync/Worker/Repository

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (just analyze, no implementation)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  cluster-sync-worker:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle
      
      - name: Display Cluster Information
        run: |
          echo "=================================================="
          echo "TDLib Cluster B: Sync / Worker / Repository"
          echo "=================================================="
          echo ""
          echo "üìã CLUSTER SCOPE:"
          echo "  Package: telegram/work, data/repo, telegram/parser"
          echo "  Focus: Background synchronization, content parsing, and data persistence"
          echo ""
          echo "üì¶ AFFECTED MODULES:"
          echo "  - app/src/main/java/com/chris/m3usuite/telegram/work/"
          echo "  - app/src/main/java/com/chris/m3usuite/data/repo/TelegramContentRepository.kt"
          echo "  - app/src/main/java/com/chris/m3usuite/telegram/parser/"
          echo ""
          echo "üéØ TASKS IN THIS CLUSTER (from docs/TDLIB_TASK_GROUPING.md):"
          echo ""
          echo "  Migration & New Files (6, 9):"
          echo "    ‚úì Move TelegramSyncWorker to telegram/work"
          echo "    ‚úì Create telegram/parser/TgContentHeuristics.kt"
          echo ""
          echo "  TelegramSyncWorker Turbo-Sync (37-48):"
          echo "    ‚úì Implement doWork() with SettingsStore loading"
          echo "    ‚úì Call T_TelegramServiceClient.ensureStarted"
          echo "    ‚úì Determine relevant chat IDs (VOD/Series/Feed)"
          echo "    ‚úì Implement parallel sync with Dispatchers.IO.limitedParallelism(n)"
          echo "    ‚úì Derive parallelism from device profile"
          echo "    ‚úì Load messages via T_ChatBrowser.loadMessagesPaged"
          echo "    ‚úì Apply MediaParser.parseMessage"
          echo "    ‚úì Use TgContentHeuristics for classification"
          echo "    ‚úì Update TelegramContentRepository"
          echo "    ‚úì Implement modes: MODE_ALL, MODE_SELECTION_CHANGED, MODE_BACKFILL_SERIES"
          echo "    ‚úì Use TelegramLogRepository for progress logging"
          echo "    ‚úì Update T_TelegramServiceClient.syncState"
          echo ""
          echo "  TelegramContentRepository Refinement (57-60):"
          echo "    ‚úì Ensure encodeTelegramId/isTelegramItem are stable"
          echo "    ‚úì Ensure Play URL format: tg://file/<fileId>?..."
          echo "    ‚úì Provide Flow APIs: getTelegramVod, getTelegramSeries, getTelegramFeedItems, searchTelegramContent"
          echo "    ‚úì Integrate SettingsStore for chat filtering"
          echo ""
          echo "  Unit Tests (92-94):"
          echo "    ‚úì MediaParser: episode heuristics (SxxEyy, language tags)"
          echo "    ‚úì TgContentHeuristics: classification/score tests"
          echo "    ‚úì TelegramContentRepository: ID mapping and URL generation"
          echo ""
          echo "üìê IMPLEMENTATION ORDER:"
          echo "  1. Create TgContentHeuristics with classification logic"
          echo "  2. Refine TelegramContentRepository with new Flow APIs"
          echo "  3. Move TelegramSyncWorker to telegram/work"
          echo "  4. Implement Turbo-Sync with parallel processing"
          echo "  5. Add unit tests for parser and repository"
          echo ""
          echo "‚ö†Ô∏è  DEPENDENCIES:"
          echo "  - Requires Cluster A (Core) APIs to be stable"
          echo "  - Uses: T_TelegramServiceClient, T_ChatBrowser"
          echo "  - Can work in parallel with: Clusters C, D, E"
          echo ""
          echo "=================================================="
      
      - name: Verify Documentation
        run: |
          echo "üìÑ Verifying required documentation..."
          if [ ! -f .github/tdlibAgent.md ]; then
            echo "‚ùå ERROR: .github/tdlibAgent.md not found!"
            exit 1
          fi
          if [ ! -f docs/TDLIB_TASK_GROUPING.md ]; then
            echo "‚ùå ERROR: docs/TDLIB_TASK_GROUPING.md not found!"
            exit 1
          fi
          echo "‚úÖ All documentation found"
          echo ""
          echo "üìä Cluster B details:"
          grep -A 30 "### Cluster B: Sync / Worker / Repository" docs/TDLIB_TASK_GROUPING.md || echo "Section not found"
      
      - name: Check Current File Structure
        run: |
          echo "üìÅ Current Worker & Repository files:"
          echo ""
          echo "Worker:"
          find app/src/main/java/com/chris/m3usuite/work -name "*Telegram*" 2>/dev/null || echo "  (none found)"
          echo ""
          echo "Repository:"
          find app/src/main/java/com/chris/m3usuite/data/repo -name "*Telegram*" 2>/dev/null || echo "  (none found)"
          echo ""
          echo "Parser:"
          find app/src/main/java/com/chris/m3usuite/telegram/parser -name "*.kt" 2>/dev/null || echo "  (none found)"
          echo ""
          echo "üìÅ Target structure:"
          echo "  telegram/work/TelegramSyncWorker.kt"
          echo "  telegram/parser/TgContentHeuristics.kt (new)"
          echo "  data/repo/TelegramContentRepository.kt (enhanced)"
      
      - name: Validate Build Before Changes
        run: |
          echo "üî® Testing current build state..."
          ./gradlew assembleDebug --no-daemon --stacktrace || echo "‚ö†Ô∏è Build has pre-existing issues"
      
      - name: Implementation Placeholder
        if: ${{ github.event.inputs.dry_run == 'false' }}
        run: |
          echo "üöß IMPLEMENTATION MODE ENABLED"
          echo ""
          echo "This workflow would now:"
          echo "  1. Create TgContentHeuristics for advanced content classification"
          echo "  2. Enhance TelegramContentRepository with Flow-based APIs"
          echo "  3. Implement adaptive parallel sync in TelegramSyncWorker"
          echo "  4. Add comprehensive unit tests"
          echo "  5. Integrate with Cluster A APIs"
          echo ""
          echo "‚ö†Ô∏è  This is a placeholder - actual implementation will be triggered by Copilot agent"
      
      - name: Summary
        run: |
          echo ""
          echo "=================================================="
          echo "‚úÖ Cluster B Analysis Complete"
          echo "=================================================="
          echo ""
          echo "Key Features to Implement:"
          echo "  ‚Ä¢ Turbo-Sync: Parallel processing with adaptive parallelism"
          echo "  ‚Ä¢ TgContentHeuristics: Intelligent content classification"
          echo "  ‚Ä¢ Enhanced Repository: Flow-based APIs for VOD/Series/Feed"
          echo "  ‚Ä¢ Comprehensive unit testing"
          echo ""
          echo "Integration Points:"
          echo "  ‚Ä¢ Depends on Cluster A: T_TelegramServiceClient, T_ChatBrowser"
          echo "  ‚Ä¢ Can be developed in parallel with Clusters C, D, E"
