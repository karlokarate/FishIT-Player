name: "Copilot Setup Steps"

on:
  # Manuell zum Testen
  workflow_dispatch:
  # Lint/Validierung, wenn du das Setup änderst
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # WICHTIG: Name darf NICHT geändert werden
  copilot-setup-steps:
    # Wenn du größere Runner konfiguriert hast, z.B. ubuntu-4-core verwenden
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Minimal nötige Rechte – Copilot bekommt später seinen eigenen Token
    permissions:
      contents: write

    steps:
      - name: Checkout repo (inkl. Submodules)
        uses: actions/checkout@v5
        with:
          # fetch-depth wird von Copilot intern überschrieben
          submodules: recursive

      - name: Set up Android Environment (JDK, SDK, NDK mit Caching)
        uses: ./.github/actions/android-env
        with:
          java-version: '21'
          ndk-version: 'r27c'

      - name: Verify toolchain (Gradle, Java, Android SDK/NDK)
        run: |
          java -version || true
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-not-set}"
          echo "ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-not-set}"
          chmod +x ./gradlew
          ./gradlew --version

      - name: Warm up Gradle wrapper & dependencies
        run: |
          # minimaler „Warmstart“, damit Copilot später schneller Builds,
          # Tests, Lint, Detekt, ktlint, etc. ausführen kann.
          ./gradlew --no-daemon -q help

      - name: Document quality & diagnostics tasks for Copilot
        run: |
          echo "Available Gradle quality tasks Copilot should use, e.g.:"           >  COPILOT_TASK_HINTS.md
          echo ""                                                                   >> COPILOT_TASK_HINTS.md
          echo "## Build Tasks"                                                     >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew :app:assembleDebug          # Build debug APK"         >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew :app:assembleRelease        # Build release APK"       >> COPILOT_TASK_HINTS.md
          echo ""                                                                   >> COPILOT_TASK_HINTS.md
          echo "## Quality & Linting Tasks"                                         >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew lintDebug                   # Android Lint (TV checks)">> COPILOT_TASK_HINTS.md
          echo "- ./gradlew detekt                      # Kotlin code smells"      >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew ktlintCheck                 # Kotlin code style"       >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew ktlintFormat                # Auto-format Kotlin"      >> COPILOT_TASK_HINTS.md
          echo ""                                                                   >> COPILOT_TASK_HINTS.md
          echo "## Testing Tasks"                                                   >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew testDebugUnitTest           # Unit tests"              >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew connectedDebugAndroidTest   # Instrumented tests"      >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew :app:compileDebugAndroidTestSources  # Compile tests"  >> COPILOT_TASK_HINTS.md
          echo ""                                                                   >> COPILOT_TASK_HINTS.md
          echo "## Notes"                                                           >> COPILOT_TASK_HINTS.md
          echo "- For TDLib builds use the existing TDLib workflows/scripts."      >> COPILOT_TASK_HINTS.md
          echo "- See DEVELOPER_GUIDE.md for detailed usage and best practices."   >> COPILOT_TASK_HINTS.md
          cat COPILOT_TASK_HINTS.md