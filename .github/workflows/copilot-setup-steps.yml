name: "Copilot Setup Steps"

on:
  # Manuell zum Testen
  workflow_dispatch:
  # Lint/Validierung, wenn du das Setup änderst
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # WICHTIG: Name darf NICHT geändert werden
  copilot-setup-steps:
    # Ubuntu 24.04 für stabilen, schnellen Build
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    # Minimal nötige Rechte – Copilot bekommt später seinen eigenen Token
    permissions:
      contents: write

    env:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"
      COPILOT_MCP_TOKEN: ${{ secrets.COPILOT_MCP_TOKEN }}

    steps:
      - name: Checkout repo (inkl. Submodules)
        uses: actions/checkout@v5
        with:
          # fetch-depth wird von Copilot intern überschrieben
          submodules: recursive

      - name: Set up JDK (für AGP 8.x / moderne Gradle-Versionen)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          # Für AGP >= 8.6 ist Java 21 empfohlen; falls dein Build
          # noch strikt auf 17 besteht, kannst du hier auf '17' zurückstellen.
          java-version: '21'
          cache: gradle

      - name: Set up Android SDK (Tools + Plattformen)
        uses: android-actions/setup-android@v3.2.2

      - name: Cache Android SDK packages
        id: sdk-cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ANDROID_SDK_ROOT }}/platforms
            ${{ env.ANDROID_SDK_ROOT }}/build-tools
            ${{ env.ANDROID_SDK_ROOT }}/platform-tools
          key: sdk-${{ runner.os }}-android-24-34-35-bt35

      - name: Install Android SDK packages
        if: steps.sdk-cache.outputs.cache-hit != 'true'
        run: |
          set -euxo pipefail
          echo ">>> Accepting SDK licenses..."
          yes | sdkmanager --licenses >/dev/null 2>&1 || true
          echo ">>> Installing SDK packages..."
          sdkmanager --install \
            "platform-tools" \
            "platforms;android-24" \
            "platforms;android-34" \
            "platforms;android-35" \
            "build-tools;35.0.0" || true
          echo "SDK installation completed."

      - name: Set up Android NDK r27c (für TDLib- und native Builds)
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27c
          link-to-sdk: true
          local-cache: true

      - name: Export ANDROID_NDK_* environment variables
        run: |
          echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> "$GITHUB_ENV"
          echo "ANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }}" >> "$GITHUB_ENV"

      - name: Verify toolchain (Gradle, Java, Android SDK/NDK)
        run: |
          java -version || true
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-not-set}"
          echo "ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-not-set}"
          chmod +x ./gradlew
          ./gradlew --version

      - name: Warm up Gradle wrapper & dependencies
        run: |
          # minimaler „Warmstart“, damit Copilot später schneller Builds,
          # Tests, Lint, Detekt, ktlint, etc. ausführen kann.
          ./gradlew --no-daemon -q help

      # ===== MCP Server Setup =====
      - name: Set up Docker Buildx (for GitHub MCP Server)
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: Cache Docker images for MCP
        uses: actions/cache@v4
        with:
          path: /tmp/.docker-cache
          key: docker-mcp-${{ runner.os }}-v1
          restore-keys: |
            docker-mcp-${{ runner.os }}-

      - name: Pull GitHub MCP Server image
        run: |
          echo ">>> Pulling GitHub MCP Server Docker image..."
          docker pull ghcr.io/github/github-mcp-server:latest || echo "Image pull failed, will retry on demand"

      - name: Set up Node.js (for Sequential Thinking MCP)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Sequential Thinking MCP package
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-mcp-${{ runner.os }}-v1
          restore-keys: |
            npm-mcp-${{ runner.os }}-

      - name: Pre-install Sequential Thinking MCP Server
        run: |
          echo ">>> Installing Sequential Thinking MCP Server..."
          npx -y @modelcontextprotocol/server-sequential-thinking --version 2>/dev/null || echo "Will install on demand"

      - name: Cache custom FishIT MCP server JAR
        uses: actions/cache@v4
        with:
          path: tools/mcp-server/build/libs/*.jar
          key: mcp-jar-${{ runner.os }}-${{ hashFiles('tools/mcp-server/**/*.kt', 'tools/mcp-server/**/*.gradle*') }}
          restore-keys: |
            mcp-jar-${{ runner.os }}-

      - name: Create MCP configuration for Copilot
        run: |
          mkdir -p ~/.config/copilot
          cat > ~/.config/copilot/mcp.json << 'MCPEOF'
          {
            "mcpServers": {
              "github": {
                "command": "docker",
                "args": ["run", "-i", "--rm", "-e", "GITHUB_PERSONAL_ACCESS_TOKEN", "ghcr.io/github/github-mcp-server"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${COPILOT_MCP_TOKEN}"
                }
              },
              "sequential-thinking": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-sequential-thinking"]
              }
            }
          }
          MCPEOF
          echo "MCP configuration created for cloud Copilot agents"

      - name: Verify MCP setup
        run: |
          echo "=== MCP Server Setup Verification ==="
          echo "Docker: $(docker --version)"
          echo "Node.js: $(node --version)"
          echo "NPM: $(npm --version)"
          echo "MCP Config: $(test -f ~/.config/copilot/mcp.json && echo '✓ exists' || echo '✗ missing')"
          echo ""
          echo "✓ MCP servers ready for cloud Copilot agents"
          echo "  - GitHub MCP: Full GitHub integration"
          echo "  - Sequential Thinking: Long-term context"
          echo "  - Custom Pipeline: Domain-specific access (if built)"

      - name: Document quality & diagnostics tasks for Copilot
        run: |
          echo "Available Gradle quality tasks Copilot should use, e.g.:"           >  COPILOT_TASK_HINTS.md
          echo ""                                                                   >> COPILOT_TASK_HINTS.md
          echo "## Build Tasks"                                                     >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew :app:assembleDebug          # Build debug APK"         >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew :app:assembleRelease        # Build release APK"       >> COPILOT_TASK_HINTS.md
          echo ""                                                                   >> COPILOT_TASK_HINTS.md
          echo "## Quality & Linting Tasks"                                         >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew lintDebug                   # Android Lint (TV checks)">> COPILOT_TASK_HINTS.md
          echo "- ./gradlew detekt                      # Kotlin code smells"      >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew ktlintCheck                 # Kotlin code style"       >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew ktlintFormat                # Auto-format Kotlin"      >> COPILOT_TASK_HINTS.md
          echo ""                                                                   >> COPILOT_TASK_HINTS.md
          echo "## Testing Tasks"                                                   >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew testDebugUnitTest           # Unit tests"              >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew connectedDebugAndroidTest   # Instrumented tests"      >> COPILOT_TASK_HINTS.md
          echo "- ./gradlew :app:compileDebugAndroidTestSources  # Compile tests"  >> COPILOT_TASK_HINTS.md
          echo ""                                                                   >> COPILOT_TASK_HINTS.md
          echo "## Notes"                                                           >> COPILOT_TASK_HINTS.md
          echo "- For TDLib builds use the existing TDLib workflows/scripts."      >> COPILOT_TASK_HINTS.md
          echo "- See DEVELOPER_GUIDE.md for detailed usage and best practices."   >> COPILOT_TASK_HINTS.md
          cat COPILOT_TASK_HINTS.md