name: TDLib – SDK-free Build (Soft-Fail, ccache, BoringSSL static)

on:
  workflow_dispatch:
    inputs:
      abis:
        description: "ABIs (Komma-separiert)"
        required: true
        default: "arm64-v8a,armeabi-v7a"
      api_level:
        description: "Android API-Level"
        required: true
        default: "21"
      td_ref:
        description: "TDLib Ref (leer = master HEAD)"
        required: false
        default: ""
      soft_fail:
        description: "Soft-Fail: weiterbauen trotz Fehler (1/0)"
        required: true
        default: "1"
      final_exit:
        description: "Exitcode 1 bei Fehlern (1=rot, 0=grün)"
        required: true
        default: "1"
      ndk_version:
        description: "NDK Version (r27c empfohlen)"
        required: true
        default: "r27c"

jobs:
  tdlib:
    runs-on: ubuntu-24.04
    env:
      NDK_VERSION: ${{ inputs.ndk_version }}
      ANDROID_PLATFORM: android-${{ inputs.api_level }}
      BORINGSSL_DIR: .third_party/boringssl
      TD_BUILD_SCRIPT: scripts/build-tdlib-android2.sh
      OUT_DIR: out
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_MAXSIZE: 2G

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Base tools
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl git unzip

      - name: Resolve TDLib ref (if empty, use master HEAD)
        id: tdref
        shell: bash
        run: |
          set -euo pipefail
          REF="${{ github.event.inputs.td_ref }}"
          if [[ -z "${REF}" ]]; then
            feed_url="https://github.com/tdlib/td/commits/master.atom"
            html="$(curl -fsSL "$feed_url")"
            REF="$(printf '%s' "$html" | grep -oE 'https://github.com/tdlib/td/commit/[0-9a-f]+' | head -n1 | awk -F/ '{print $NF}')"
            [[ -n "$REF" ]] || REF="master"
          fi
          echo "ref=$REF" >> "$GITHUB_OUTPUT"

      - name: Setup Java (JDK 21)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Install build deps (CMake, Ninja, PHP, gperf, rsync, OpenSSL, zlib, ccache)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y gpg lsb-release software-properties-common php build-essential gperf rsync libssl-dev zlib1g-dev ccache
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://apt.kitware.com/keys/kitware-archive-latest.asc             | sudo gpg --dearmor -o /etc/apt/keyrings/kitware-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ $(lsb_release -cs) main"             | sudo tee /etc/apt/sources.list.d/kitware.list
          sudo apt-get update -y
          sudo apt-get install -y cmake ninja-build
          cmake --version; ninja --version; php -v; gperf --version; ccache -V || true

      # ---- Cache-Key-Teile sanitisieren (keine Kommas) ----
      - name: Sanitize cache-key parts
        id: ckey
        shell: bash
        env:
          ABIS: ${{ inputs.abis }}
        run: |
          set -euo pipefail
          ABIS_SAN="$(printf '%s' "$ABIS" | tr -d '[:space:]' | tr ',' '-')"
          echo "abis=${ABIS_SAN}" >> "$GITHUB_OUTPUT"

      - name: Restore ccache
        id: restore-ccache
        uses: actions/cache/restore@v4
        with:
          path: .ccache
          key: >
            ccache-${{ runner.os }}-${{ env.NDK_VERSION }}-${{ inputs.api_level }}-${{ steps.ckey.outputs.abis }}-${{ steps.tdref.outputs.ref }}-v3

      - name: Restore NDK
        id: cache-ndk
        uses: actions/cache/restore@v4
        with:
          path: .ndk/android-ndk-${{ env.NDK_VERSION }}
          key: ndk-${{ runner.os }}-${{ env.NDK_VERSION }}

      - name: Download NDK (if cache miss)
        if: ${{ steps.cache-ndk.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ndk
          url="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
          curl -fSLo .ndk/ndk.zip "$url"
          unzip -q .ndk/ndk.zip -d .ndk
          rm .ndk/ndk.zip

      - name: Set NDK path
        id: ndk
        shell: bash
        run: |
          set -euo pipefail
          echo "dir=$(pwd)/.ndk/android-ndk-${NDK_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Fetch TDLib sources
        shell: bash
        run: |
          set -euo pipefail
          rm -rf td && mkdir -p td
          git init td
          cd td
          git remote add origin https://github.com/tdlib/td.git
          git fetch --depth=1 origin "${{ steps.tdref.outputs.ref }}"
          git checkout -qf FETCH_HEAD
          git rev-parse HEAD | tee .TDLIB_COMMIT.txt
          git describe --tags --always --long --dirty=+ | tee .TDLIB_DESCRIBE.txt

      # ---------- BoringSSL Cache ----------
      - name: Restore BoringSSL installs
        id: restore-bssl
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.BORINGSSL_DIR }}/arm64-v8a
            ${{ env.BORINGSSL_DIR }}/armeabi-v7a
          key: >
            bssl-install-${{ runner.os }}-${{ env.NDK_VERSION }}-${{ inputs.api_level }}-${{ steps.ckey.outputs.abis }}-v2

      - name: Check BoringSSL stamp & purge if stale
        id: check-bssl
        shell: bash
        run: |
          set -euo pipefail
          mismatch=0
          ABIS="${{ inputs.abis }}"
          ANDROID_PLATFORM="${{ env.ANDROID_PLATFORM }}"
          NDK_DIR="${{ steps.ndk.outputs.dir }}"
          ndk_base="$(basename "$NDK_DIR")"
          IFS=',' read -ra arr <<< "$ABIS"
          for abi in "${arr[@]}"; do
            abi="$(echo "$abi" | xargs)"
            inst="${BORINGSSL_DIR}/${abi}"
            if [[ -d "$inst" ]]; then
              stamp="$inst/stamp.json"
              if [[ -f "$stamp" ]]; then
                ap="$(grep -o '"android_platform"[[:space:]]*:[[:space:]]*"[^"]*"' "$stamp" | awk -F '"' '{print $4}' || true)"
                ndk="$(grep -o '"ndk"[[:space:]]*:[[:space:]]*"[^"]*"' "$stamp" | awk -F '"' '{print $4}' || true)"
                if [[ "$ap" != "$ANDROID_PLATFORM" || "$ndk" != "$ndk_base" ]]; then
                  echo "Stale BoringSSL for $abi (want $ANDROID_PLATFORM/$ndk_base, have ${ap:-?}/${ndk:-?})"
                  rm -rf "$inst"
                  mismatch=1
                fi
              else
                echo "Missing stamp for $abi → purge"
                rm -rf "$inst"
                mismatch=1
              fi
            fi
          done
          echo "rebuild=$mismatch" >> "$GITHUB_OUTPUT"

      - name: Build BoringSSL (static) if missing or stale
        if: ${{ steps.restore-bssl.outputs.cache-hit != 'true' || steps.check-bssl.outputs.rebuild == '1' }}
        shell: bash
        run: |
          set -euo pipefail
          NDK="${{ steps.ndk.outputs.dir }}"
          rm -rf boringssl-src
          git clone --depth=1 https://boringssl.googlesource.com/boringssl boringssl-src
          mkdir -p "${BORINGSSL_DIR}"
          for ABI in arm64-v8a armeabi-v7a; do
            case "$ABI" in
              arm64-v8a)  TRIPLE=aarch64-linux-android ;;
              armeabi-v7a) TRIPLE=armv7a-linux-androideabi ;;
            esac
            BLD="boringssl-build-$ABI"
            INST="${BORINGSSL_DIR}/$ABI"
            rm -rf "$BLD" "$INST"; mkdir -p "$BLD" "$INST/lib" "$INST/include"
            cmake -G Ninja -S boringssl-src -B "$BLD"               -DCMAKE_TOOLCHAIN_FILE="$NDK/build/cmake/android.toolchain.cmake"               -DANDROID_ABI="$ABI"               -DANDROID_PLATFORM="${ANDROID_PLATFORM}"               -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF               -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
            cmake --build "$BLD" --target crypto ssl -- -k 0
            cp -f "$(find "$BLD" -name libcrypto.a | head -n1)" "$INST/lib/libcrypto.a"
            cp -f "$(find "$BLD" -name libssl.a | head -n1)" "$INST/lib/libssl.a"
            rsync -a boringssl-src/include/ "$INST/include/"
            printf '{"abi":"%s","android_platform":"%s","ndk":"%s"}
' "$ABI" "${ANDROID_PLATFORM}" "$(basename "$NDK")" > "$INST/stamp.json"
          done

      - name: Save BoringSSL installs
        if: ${{ steps.restore-bssl.outputs.cache-hit != 'true' || steps.check-bssl.outputs.rebuild == '1' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.BORINGSSL_DIR }}/arm64-v8a
            ${{ env.BORINGSSL_DIR }}/armeabi-v7a
          key: >
            bssl-install-${{ runner.os }}-${{ env.NDK_VERSION }}-${{ inputs.api_level }}-${{ steps.ckey.outputs.abis }}-v2

      - name: Make build script executable
        run: chmod +x "${{ env.TD_BUILD_SCRIPT }}"

      - name: Build TDLib (Soft-Fail, logs, summary)
        shell: bash
        env:
          TD_REF: ${{ steps.tdref.outputs.ref }}
          ABIS: ${{ inputs.abis }}
          API_LEVEL: ${{ inputs.api_level }}
          SOFT_FAIL: ${{ inputs.soft_fail }}
          FINAL_EXIT: ${{ inputs.final_exit }}
        run: |
          set -uo pipefail
          NDK_DIR="${{ steps.ndk.outputs.dir }}"
          export ANDROID_NDK_ROOT="$NDK_DIR"
          export NDK="$NDK_DIR"
          bash "${TD_BUILD_SCRIPT}"             --ref "${TD_REF:-}"             --abis "${ABIS}"             --api-level "${API_LEVEL}"             --boringssl-dir "${BORINGSSL_DIR}"             --ndk "${NDK_DIR}"

      - name: Upload logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-logs
          path: |
            out/logs/build.log
            out/logs/summary.txt
            out/logs/summary.json
          if-no-files-found: warn
          retention-days: 14

      - name: Upload outputs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-outputs
          path: |
            out/TDLIB_VERSION.txt
            out/*.jar
            out/libs/**/libtdjni.so
          if-no-files-found: warn
          retention-days: 14

      - name: Save ccache (always)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .ccache
          key: >
            ccache-${{ runner.os }}-${{ env.NDK_VERSION }}-${{ inputs.api_level }}-${{ steps.ckey.outputs.abis }}-${{ steps.tdref.outputs.ref }}-v3

      - name: ccache stats (always)
        if: always()
        shell: bash
        run: ccache -s || true
