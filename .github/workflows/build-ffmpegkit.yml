name: Build FishIT FFmpegKit Slim AAR

on:
  workflow_dispatch:
    inputs:
      ffmpeg_kit_version:
        description: "FFmpegKit version/tag to build (e.g., v6.0, v6.0.1)"
        required: false
        default: "v6.0"
        type: string
      create_release:
        description: "Create GitHub Release with built AAR"
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: ffmpegkit-build-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  build-ffmpegkit:
    runs-on: ubuntu-24.04
    timeout-minutes: 240

    env:
      FFMPEG_KIT_VERSION: ${{ github.event.inputs.ffmpeg_kit_version || 'v6.0' }}
      ANDROID_NDK_VERSION: "27.2.12479018"
      # LTS/FireTV freundlich: API-Level 21; kann bei Bedarf angepasst werden
      FFMPEGKIT_API_LEVEL: "21"

    steps:
      - name: Checkout FishIT-Player repository
        uses: actions/checkout@v5
        with:
          path: fishit-player

      - name: Setup Java 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.2

      - name: Install Android SDK & NDK
        run: |
          set -eo pipefail
          echo ">>> Accepting SDK licenses..."
          yes | sdkmanager --licenses >/dev/null 2>&1 || true

          echo ">>> Installing SDK packages..."
          sdkmanager --update || true
          sdkmanager --install \
            "platform-tools" \
            "platforms;android-24" \
            "build-tools;35.0.0" \
            "ndk;${ANDROID_NDK_VERSION}" || true

          echo ">>> SDK installation completed"

          echo "ANDROID_SDK_ROOT=${ANDROID_HOME}" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=${ANDROID_HOME}/ndk/${ANDROID_NDK_VERSION}" >> $GITHUB_ENV

      - name: Verify SDK & NDK installation
        run: |
          set -eo pipefail
          echo "=== Android SDK Root ==="
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-}"
          ls -la "${ANDROID_SDK_ROOT}" || true

          echo -e "\n=== Android NDK Root ==="
          echo "ANDROID_NDK_ROOT=${ANDROID_NDK_ROOT:-}"
          ls -la "${ANDROID_NDK_ROOT}" || true

          if [[ -z "${ANDROID_NDK_ROOT:-}" ]]; then
            echo "::error::ANDROID_NDK_ROOT is not set"
            exit 1
          fi
          if [[ ! -d "${ANDROID_NDK_ROOT}" ]]; then
            echo "::error::Android NDK not found at ${ANDROID_NDK_ROOT}"
            exit 1
          fi

          if [[ -f "${ANDROID_NDK_ROOT}/source.properties" ]]; then
            echo -e "\n=== NDK Version ==="
            grep "Pkg.Revision" "${ANDROID_NDK_ROOT}/source.properties" || true
          fi

      - name: Clone FFmpegKit repository
        run: |
          set -eo pipefail
          echo ">>> Cloning FFmpegKit from arthenica/ffmpeg-kit (${FFMPEG_KIT_VERSION})..."

          if [[ "${FFMPEG_KIT_VERSION}" == "main" ]]; then
            git clone --depth 1 https://github.com/arthenica/ffmpeg-kit.git ffmpeg-kit
          else
            git clone --depth 1 --branch "${FFMPEG_KIT_VERSION}" https://github.com/arthenica/ffmpeg-kit.git ffmpeg-kit
          fi

          cd ffmpeg-kit
          echo ">>> FFmpegKit repository cloned successfully"
          echo ">>> Current commit:"
          git log -1 --oneline || true

      - name: Build FFmpegKit AAR (FishIT custom kit)
        working-directory: ffmpeg-kit
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_NDK_ROOT: ${{ env.ANDROID_NDK_ROOT }}
          FFMPEGKIT_API_LEVEL: ${{ env.FFMPEGKIT_API_LEVEL }}
        run: |
          set -eo pipefail
          echo "=== Starting FishIT-Player FFmpegKit build ==="

          # Copy custom kit script from the FishIT-Player repo
          cp ../fishit-player/tools/fishit_ffmpeg_customkit.sh .

          chmod +x fishit_ffmpeg_customkit.sh

          ./fishit_ffmpeg_customkit.sh

          echo "=== Build completed ==="

      - name: Locate and verify AAR
        id: aar
        working-directory: ffmpeg-kit
        run: |
          set -eo pipefail
          echo "=== Searching for built AAR ==="
          find prebuilt -name "*.aar" -type f

          AAR_PATH=$(find prebuilt -name "ffmpeg-kit-*.aar" -type f | head -1)

          if [[ -z "${AAR_PATH}" ]]; then
            echo "::error::No AAR file found in prebuilt directory"
            exit 1
          fi

          echo "=== AAR found at: ${AAR_PATH} ==="
          ls -lh "${AAR_PATH}"

          AAR_SHA256=$(sha256sum "${AAR_PATH}" | cut -d' ' -f1)
          AAR_SIZE=$(du -h "${AAR_PATH}" | cut -f1)

          echo "aar_path=${AAR_PATH}" >> $GITHUB_OUTPUT
          echo "aar_sha256=${AAR_SHA256}" >> $GITHUB_OUTPUT
          echo "aar_size=${AAR_SIZE}" >> $GITHUB_OUTPUT
          echo "aar_filename=$(basename "${AAR_PATH}")" >> $GITHUB_OUTPUT

      - name: Prepare release artifacts
        working-directory: ffmpeg-kit
        run: |
          set -eo pipefail
          mkdir -p ../release-artifacts

          cp "${{ steps.aar.outputs.aar_path }}" "../release-artifacts/fishit-ffmpegkit-slim-lts.aar"

          cd ../release-artifacts
          sha256sum fishit-ffmpegkit-slim-lts.aar > checksums.txt

          cat > build-info.txt <<EOFINFO
          FishIT-Player FFmpegKit Slim LTS Build
          ======================================

          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          FFmpegKit Version: ${FFMPEG_KIT_VERSION}
          Repository: https://github.com/arthenica/ffmpeg-kit
          Commit: $(cd ../ffmpeg-kit && git rev-parse HEAD)

          AAR Details:
          ------------
          Filename: $(basename fishit-ffmpegkit-slim-lts.aar)
          Size: ${{ steps.aar.outputs.aar_size }}
          SHA256: ${{ steps.aar.outputs.aar_sha256 }}

          NDK Version: ${ANDROID_NDK_VERSION}
          API Level (FFMPEGKIT_API_LEVEL): ${FFMPEGKIT_API_LEVEL}
          EOFINFO

          cat build-info.txt

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: fishit-ffmpegkit-slim-lts
          path: |
            release-artifacts/fishit-ffmpegkit-slim-lts.aar
            release-artifacts/checksums.txt
            release-artifacts/build-info.txt
          retention-days: 90
          if-no-files-found: error

      - name: Create GitHub Release
        if: ${{ github.event.inputs.create_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fishit-ffmpegkit-slim-lts-${{ github.run_number }}
          name: FishIT FFmpegKit Slim LTS Build ${{ github.run_number }}
          body_path: release-artifacts/build-info.txt
          files: |
            release-artifacts/fishit-ffmpegkit-slim-lts.aar
            release-artifacts/checksums.txt
            release-artifacts/build-info.txt
          draft: false
          prerelease: false
          fail_on_unmatched_files: true

      - name: Build summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## FishIT FFmpegKit Slim LTS Build Summary

          ### Configuration
          - **FFmpegKit Version:** ${FFMPEG_KIT_VERSION}
          - **API Level (FFMPEGKIT_API_LEVEL):** ${FFMPEGKIT_API_LEVEL}
          - **NDK:** ${ANDROID_NDK_VERSION}

          ### Output
          - **AAR Filename:** \`fishit-ffmpegkit-slim-lts.aar\`
          - **Size:** ${{ steps.aar.outputs.aar_size }}
          - **SHA256:** \`${{ steps.aar.outputs.aar_sha256 }}\`

          ### Next Steps
          1. Download the AAR artifact from this workflow run.
          2. Drop it into \`app/libs/\` as \`fishit-ffmpegkit-slim-lts.aar\`.
          3. Add this to \`app/build.gradle.kts\` when you're ready to integrate:
             \`\`\`kotlin
             dependencies {
                 implementation(files("libs/fishit-ffmpegkit-slim-lts.aar"))
             }
             \`\`\`
          EOF
