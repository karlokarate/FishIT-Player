name: Codex – Solver (Bot 2)

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      comment:
        description: "Optional: Hinweis / Debug für manuellen Start"
        required: false
        default: ""

permissions:
  contents: write
  pull-requests: write
  actions: write
  issues: write

jobs:
  solve:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && github.event.label.name == 'contextmap-ready')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade openai requests unidiff

      - name: Export GH_EVENT_NAME
        run: echo "GH_EVENT_NAME=${{ github.event_name }}" >> $GITHUB_ENV

      - name: Run Solver Bot (high)
        env:
          OPENAI_API_KEY: ${{ secrets.OPEN_API_KEY }}          # mapping
          OPENAI_MODEL_DEFAULT: ${{ vars.OPENAI_MODEL_DEFAULT }}  # gpt-5
          OPENAI_REASONING_EFFORT: high

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}

          # Optional: eigener Build-Workflow-Name/ID für den Dispatch nach PR
          SOLVER_BUILD_WORKFLOW: release-apk.yml
        run: python .github/codex/bot_solver.py
