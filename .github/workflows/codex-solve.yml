name: Codex – Solver (Bot 2)

on:
  workflow_run:
    workflows: ["Codex – ContextMap (Bot 1)"]
    types: [completed]
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue:
        description: "Issue-Nummer (optional; überschreibt Kontext)"
        required: false
        default: ""
      build_type:
        description: "Optional: Build-Dispatch (debug|release)"
        required: false
        default: ""

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  solve:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies (solver)
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/codex/requirements-solver.txt

      - name: Determine ISSUE_NUMBER
        id: issue
        shell: bash
        run: |
          set -euo pipefail
          case "${{ github.event_name }}" in
            workflow_run)
              # Best effort: try to get issue number from context artifact
              if [[ -f ".github/codex/context/solver_input.json" ]]; then
                num=$(jq -r '.issue_number // empty' ".github/codex/context/solver_input.json" || true)
                [[ -n "$num" ]] && echo "num=$num" >> "$GITHUB_OUTPUT" || true
              fi
              ;;
            issues)
              echo "num=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
              ;;
            issue_comment)
              echo "num=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "num=${{ github.event.inputs.issue }}" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Run Bot 2 (Solver)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL }}
          OPENAI_MODEL_DEFAULT: ${{ vars.OPENAI_MODEL_DEFAULT }}
          OPENAI_REASONING_EFFORT: high

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GH_EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.num }}
        run: |
          python .github/codex/bot_solver.py

      - name: Upload rejects (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: solver-rejects
          path: |
            **/*.rej
            **/*.orig
            .github/codex/context/**
          if-no-files-found: ignore
