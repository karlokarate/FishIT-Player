name: codex-solve

on:
  repository_dispatch:
    types: [codex-solver-context-ready]
  workflow_dispatch:
    inputs:
      issue:
        description: "Issue number (optional manual run)"
        required: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write   # <- wichtig: Bot 2 dispatcht Triage

jobs:
  solve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true   # <- sicher für Pushes

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requirements
        shell: bash
        run: |
          set -e
          pip install -U pip
          if [ -f .github/codex/requirements.txt ]; then
            pip install -r .github/codex/requirements.txt
          else
            pip install 'requests>=2.32.3,<3' 'chardet>=5.2.0,<6' 'openai>=1.40.0,<2' 'unidiff>=0.7.5,<1'
          fi

      # Robust: kein Heredoc, einfach unzip nutzen, falls ZIP existiert
      - name: Unpack shared-lib (optional)
        shell: bash
        run: |
          set -e
          if [ ! -d .github/codex/lib ] && [ -f .github/codex/codex-shared-lib.zip ]; then
            mkdir -p .github/codex/lib
            unzip -q -o .github/codex/codex-shared-lib.zip -d .github/codex/lib
            echo "unzipped shared lib"
          else
            echo "shared lib present or zip missing — skipping"
          fi

      - name: Run Solver (Bot 2)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          # Repo-dispatch liefert issue_number unter client_payload; beim manuellen Lauf 'inputs.issue'
          ISSUE_NUMBER: ${{ github.event.client_payload.issue_number || inputs.issue }}
          SOLVER_SEPARATE_PRS: 'false'
          SOLVER_RUN_TESTS: 'false'
        run: python -u .github/codex/bot_solver.py
