# V2 PR Guard - Build Artifacts Check
# Prevents build artifacts from being committed in PRs to v2-bootstrap
# Runs on every PR against architecture/v2-bootstrap branch

name: V2 PR Guard - Build Artifacts

on:
  pull_request:
    branches:
      - architecture/v2-bootstrap

permissions:
  contents: read
  pull-requests: write

jobs:
  check-build-artifacts:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}

      - name: Check for build artifacts
        run: |
          echo "üîç Checking PR for build artifacts..."

          # Get list of changed files
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          echo "Changed files:"
          echo "$CHANGED"
          echo ""

          # Check for build artifacts (excluding allowed default.json)
          PATTERN='(^|/)build/|\.class$|MyObjectBox\.(java|kt)|objectbox-models/.*\.json'
          ARTIFACTS=$(echo "$CHANGED" | grep -E "$PATTERN" | \
            grep -v '/objectbox-models/default\.json$' || true)

          if [ -n "$ARTIFACTS" ]; then
            echo "‚ùå ERROR: PR contains build artifacts that should not be committed:"
            echo "$ARTIFACTS"
            echo ""
            echo "Build artifacts must never be committed."
            echo "Please remove these files:"
            echo "1. Run: git rm --cached <file>"
            echo "2. Verify .gitignore patterns are correct"
            echo "3. Re-push your changes"
            exit 1
          fi

          echo "‚úÖ OK: No build artifacts detected in PR"

      - name: Comment on PR if artifacts found
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              '## ‚ùå Build Artifacts Detected',
              '',
              'This PR contains build artifacts that should not be committed:',
              '',
              '- Files in `build/` directories',
              '- `.class` files',
              '- Generated ObjectBox files (`MyObjectBox.java`, `MyObjectBox.kt`)',
              '- Extra `objectbox-models/*.json` files (only `default.json` is allowed)',
              '',
              '**To fix:**',
              '1. Remove artifacts: `git rm --cached <file>`',
              '2. Verify `.gitignore` patterns',
              '3. Re-push changes',
              '',
              'See `docs/v2-cleanup/V2_BUILD_ARTIFACT_GUARDRAILS.md` for more info.'
            ].join('\n');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
