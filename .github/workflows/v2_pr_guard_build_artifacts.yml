# V2 PR Guard - Build Artifacts Check
# Prevents build artifacts from being committed in PRs to v2-bootstrap
# Runs on every PR against architecture/v2-bootstrap branch

name: V2 PR Guard - Build Artifacts

on:
  pull_request:
    branches:
      - architecture/v2-bootstrap

permissions:
  contents: read
  pull-requests: write

jobs:
  check-build-artifacts:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}

      - name: Check for build artifacts
        run: |
          echo "üîç Checking PR for build artifacts..."
          
          # Get list of changed files
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          echo "Changed files:"
          echo "$CHANGED"
          echo ""
          
          # Check for build artifacts (excluding allowed default.json)
          ARTIFACTS=$(echo "$CHANGED" | grep -E '(^|/)build/|\.class$|MyObjectBox\.(java|kt)|objectbox-models/.*\.json' | grep -v 'objectbox-models/default\.json' || true)
          
          if [ -n "$ARTIFACTS" ]; then
            echo "‚ùå ERROR: PR contains build artifacts that should not be committed:"
            echo "$ARTIFACTS"
            echo ""
            echo "Build artifacts must never be committed. Please remove these files:"
            echo "1. Run: git rm --cached <file>"
            echo "2. Verify .gitignore patterns are correct"
            echo "3. Re-push your changes"
            exit 1
          fi
          
          echo "‚úÖ OK: No build artifacts detected in PR"

      - name: Comment on PR if artifacts found
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ‚ùå Build Artifacts Detected\n\nThis PR contains build artifacts that should not be committed:\n\n- Files in `build/` directories\n- `.class` files\n- Generated ObjectBox files (`MyObjectBox.java`, `MyObjectBox.kt`)\n- Extra `objectbox-models/*.json` files (only `default.json` is allowed)\n\n**To fix:**\n1. Remove artifacts: `git rm --cached <file>`\n2. Verify `.gitignore` patterns\n3. Re-push changes\n\nSee `docs/v2-cleanup/V2_BUILD_ARTIFACT_GUARDRAILS.md` for more info.'
            })
