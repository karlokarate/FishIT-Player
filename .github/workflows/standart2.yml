name: aaaTDLib - Android Java (prebuilt BoringSSL, validated, doc-conform)

on:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: "tdlib-${{ github.workflow }}-${{ github.ref_name }}"
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: actionlint
        uses: reviewdog/action-actionlint@v1
        with:
          actionlint_flags: "--color always"

  java_bindings:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    permissions:
      contents: read
      packages: write
      id-token: write
    env:
      TD_SRC_DIR: td
      TD_REF: ""
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Host toolchain (cmake/ninja/php)
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y ninja-build cmake git curl unzip zstd openjdk-17-jdk gperf file python3 php-cli build-essential

      - name: Fetch TDLib sources
        run: |
          set -euo pipefail
          git clone --depth=1 https://github.com/tdlib/td.git "$TD_SRC_DIR"
          if [ -n "${TD_REF:-}" ] && [ "${TD_REF}" != "master" ]; then
            cd "$TD_SRC_DIR"
            git fetch origin "$TD_REF" --depth 1 || true
            git checkout "$TD_REF" || true
          fi

      - name: Build generator (host)
        id: gen
        run: |
          set -euo pipefail
          cmake -G Ninja -S "$TD_SRC_DIR" -B build-host \
            -DCMAKE_BUILD_TYPE=Release -DTD_ENABLE_TESTS=OFF -DTD_ENABLE_JNI=OFF -DTD_ENABLE_JAVA=OFF
          cmake --build build-host --target td_generate_java_api -- -j 2

          GEN_BIN=""
          for p in build-host/td/bin/td_generate_java_api build-host/td/generate/td_generate_java_api; do
            [ -x "$p" ] && GEN_BIN="$p" && break
          done
          [ -z "$GEN_BIN" ] && GEN_BIN="$(find build-host -type f -perm -111 -name td_generate_java_api -print -quit || true)"
          if [ -z "$GEN_BIN" ]; then
            echo "::group::targets"; ninja -C build-host -t targets all || true; echo "::endgroup::"
            echo "::group::tree"; ls -R build-host | sed 's/^/  /'; echo "::endgroup::"
            echo "::error ::td_generate_java_api not found after build"
            exit 60
          fi
          ninja -C build-host -t targets all | sed 's/^/  /' || true
          if ninja -C build-host -t targets | grep -q '^tl_generate_c:'; then
            cmake --build build-host --target tl_generate_c -- -j 2 || true
          elif ninja -C build-host -t targets | grep -q '^generate_c:'; then
            cmake --build build-host --target generate_c -- -j 2 || true
          elif ninja -C build-host -t targets | grep -q '^prepare_cross_compiling:'; then
            cmake --build build-host --target prepare_cross_compiling -- -j 2 || true
          fi
          echo "gen_bin=$GEN_BIN" >> "$GITHUB_OUTPUT"

      - name: Generate TdApi.java
        run: |
          set -euo pipefail
          GEN_BIN="${{ steps.gen.outputs.gen_bin }}"
          PACKAGE="org/drinkless/tdlib"
          OUT_ROOT="build-host/java-bindings"
          OUT_DIR="$OUT_ROOT/$PACKAGE"
          mkdir -p "$OUT_DIR"

          TLO_FILE="$(find build-host -maxdepth 6 -type f -name 'td_api.tlo' -print -quit || true)"
          [ -z "$TLO_FILE" ] && TLO_FILE="$(find "$TD_SRC_DIR" -maxdepth 6 -type f -name 'td_api.tlo' -print -quit || true)"
          TL_FILE="$(find "$TD_SRC_DIR" -type f -path '*/td/generate/scheme/td_api.tl' -print -quit || true)"

          SCHEMA=""
          if [ -n "$TLO_FILE" ]; then SCHEMA="$TLO_FILE"; elif [ -n "$TL_FILE" ]; then SCHEMA="$TL_FILE"; fi
          if [ -z "$SCHEMA" ]; then
            echo "::group::debug-locate-schema"
            find build-host -maxdepth 6 -type f -name 'td_api.*' -print || true
            find "$TD_SRC_DIR" -maxdepth 6 -type f -name 'td_api.*' -print || true
            echo "::endgroup::"
            echo "::error ::No td_api.tlo/.tl schema found"
            exit 61
          fi

          set +e
          "$GEN_BIN" TdApi "$SCHEMA" "$OUT_ROOT" "$PACKAGE"
          rc=$?
          if [ $rc -ne 0 ] && [ "$SCHEMA" = "$TL_FILE" ] && [ -n "$TLO_FILE" ]; then
            "$GEN_BIN" TdApi "$TLO_FILE" "$OUT_ROOT" "$PACKAGE"
            rc=$?
          fi
          set -e
          if [ $rc -ne 0 ]; then
            echo "::error ::td_generate_java_api failed (schema=$SCHEMA)"
            exit 63
          fi

          JAVA_FILE="$OUT_DIR/TdApi.java"
          JDOC_PHP="$(find "$TD_SRC_DIR" -type f -name 'JavadocTlDocumentationGenerator.php' -print -quit || true)"
          if command -v php >/dev/null 2>&1 && [ -n "$TL_FILE" ] && [ -f "$JAVA_FILE" ] && [ -f "$JDOC_PHP" ]; then
            php "$JDOC_PHP" "$TL_FILE" "$JAVA_FILE" || echo "::notice ::Javadoc generation skipped (php error)"
          else
            echo "::notice ::Skipping TdApi Javadoc (php or script missing)"
          fi

          test -s "$JAVA_FILE" || { echo "::error ::TdApi.java not created"; exit 62; }
          echo "Generated $JAVA_FILE"

      - name: Upload TdApi.java
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-java-bindings
          path: build-host/java-bindings/org/drinkless/tdlib/TdApi.java
          if-no-files-found: error
          retention-days: 14

  tdlib:
    needs: [lint, java_bindings]
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    permissions:
      contents: write
      packages: write
      id-token: write
    env:
      ANDROID_PLATFORM: android-24
      NDK_VERSION: r27c
      TD_SRC_DIR: td
      REPO: karlokarate/FishIT-Player
      BORINGSSL_TAG: boringssl-28efc83e86dc-android24-ndk-r27c

    strategy:
      fail-fast: false
      matrix:
        include:
          - abi: arm64-v8a
            asset: boringssl-28efc83e86dc-android24-ndk-r27c-arm64-v8a.tar.zst
            sha:   boringssl-28efc83e86dc-android24-ndk-r27c-arm64-v8a.sha256
            expect_machine: "AArch64"
            expect_class: "ELF64"
          - abi: armeabi-v7a
            asset: boringssl-28efc83e86dc-android24-ndk-r27c-armeabi-v7a.tar.zst
            sha:   boringssl-28efc83e86dc-android24-ndk-r27c-armeabi-v7a.sha256
            expect_machine: "ARM"
            expect_class: "ELF32"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install build deps
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update -qq
          sudo apt-get install -y ninja-build cmake git curl unzip tar zstd openjdk-17-jdk gperf file python3 php-cli build-essential
          echo "JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))" >> $GITHUB_ENV

      - name: Cache NDK ${{ env.NDK_VERSION }}
        uses: actions/cache@v4
        with:
          key: ndk-${{ runner.os }}-${{ env.NDK_VERSION }}
          restore-keys: |
            ndk-${{ runner.os }}-
          path: .ndk/android-ndk-${{ env.NDK_VERSION }}

      - name: Prepare Android NDK ${{ env.NDK_VERSION }}
        run: |
          set -euo pipefail
          mkdir -p .ndk && cd .ndk
          if [ ! -d "android-ndk-${NDK_VERSION}" ]; then
            curl -fsSLO "https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
            unzip -q "android-ndk-${NDK_VERSION}-linux.zip"
          fi
          export NDK_PATH="$PWD/android-ndk-${NDK_VERSION}"
          echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          test -x "$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++" || { echo "::error ::NDK toolchain clang++ missing"; exit 2; }

      - name: Clone TDLib (official)
        run: |
          set -euo pipefail
          git clone --depth=1 https://github.com/tdlib/td.git "${TD_SRC_DIR}"

      - name: Pre-generate tdutils auto sources (if generator present)
        run: |
          set -euo pipefail
          cd "${TD_SRC_DIR}"
          gen_py="$(git ls-files | grep -E '(^|/)tdutils/.*/generate_mime_types\.py$' | head -n1 || true)"
          gen_cpp="$(git ls-files | grep -E '(^|/)tdutils/generate/generate_mime_types_gperf\.cpp$' | head -n1 || true)"
          gen_dir=""

          if [ -n "$gen_py" ]; then
            gen_dir="$(dirname "$gen_py")"
            echo "Found Python generator: $gen_py"
            mkdir -p "$gen_dir/auto"
            (cd "$gen_dir" && python3 generate_mime_types.py)
          elif [ -n "$gen_cpp" ]; then
            gen_dir="$(dirname "$gen_cpp")"
            echo "Found CMake/gperf generator: $gen_cpp"
            command -v gperf >/dev/null 2>&1 || { echo "::error ::gperf missing for tdutils auto generation"; exit 93; }
            mkdir -p "$gen_dir/auto"
            build_dir="$PWD/.tdmime-host"
            cmake -G Ninja -S "$gen_dir" -B "$build_dir" -DCMAKE_BUILD_TYPE=Release -DTDUTILS_MIME_TYPE=ON
            cmake --build "$build_dir" --target tdmime_auto -- -j 2
          else
            echo "::notice ::No tdutils MIME generator detected; relying on CMake custom commands."
          fi

          if [ -n "$gen_dir" ]; then
            test -f "$gen_dir/auto/mime_type_to_extension.cpp" || { echo "::error ::missing auto/mime_type_to_extension.cpp after generation"; exit 91; }
            test -f "$gen_dir/auto/extension_to_mime_type.cpp" || { echo "::error ::missing auto/extension_to_mime_type.cpp after generation"; exit 92; }
            echo "Generated:"
            ls -l "$gen_dir/auto" | sed 's/^/  /'
          fi

      - name: Prepare logs directory (${{ matrix.abi }})
        run: |
          set -euo pipefail
          mkdir -p "logs-${{ matrix.abi }}"
          {
            echo "runner=$(uname -a)"
            cmake --version || true
            ninja --version || true
            "$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++" --version || true
          } > "logs-${{ matrix.abi }}/tool-versions.txt"

      - name: Download and stage prebuilt BoringSSL (${{ matrix.abi }})
        id: stage_bssl
        run: |
          set -euo pipefail
          mkdir -p .third_party && cd .third_party
          BASE_URL="https://github.com/${REPO}/releases/download/${BORINGSSL_TAG}"
          ASSET="${{ matrix.asset }}"
          SHA_FILE="${{ matrix.sha }}"
          TMPDIR=".boringssl_tmp"
          mkdir -p "$TMPDIR" && cd "$TMPDIR"

          found=false
          valid=false

          CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "${BASE_URL}/${ASSET}")
          if [ "$CODE" = "200" ]; then
            found=true
            curl -fL "${BASE_URL}/${ASSET}" -o "${ASSET}"
            CODE_SHA=$(curl -s -o /dev/null -w "%{http_code}" -L "${BASE_URL}/${SHA_FILE}")
            if [ "$CODE_SHA" = "200" ]; then
              curl -fL "${BASE_URL}/${SHA_FILE}" -o "${SHA_FILE}"
              EXPECTED=$(sed -E 's/^([0-9a-fA-F]{64}).*$/\1/' "${SHA_FILE}" | head -n1 || true)
              if [ -n "$EXPECTED" ]; then
                ACTUAL=$(sha256sum "${ASSET}" | awk '{print $1}')
                if [ "$EXPECTED" != "$ACTUAL" ]; then
                  echo "::warning ::SHA256 mismatch for ${ASSET} expected=$EXPECTED actual=$ACTUAL"
                fi
              fi
            fi

            NAME="${ASSET%.tar.zst}"
            mkdir -p "${NAME}"
            tar --use-compress-program=unzstd -xf "${ASSET}" -C "${NAME}"

            ABI_DIR="$GITHUB_WORKSPACE/.third_party/boringssl/${{ matrix.abi }}"
            rm -rf "$ABI_DIR"
            mkdir -p "$ABI_DIR" "$ABI_DIR/lib"

            INC_DIR="$(find "${NAME}" -type d -name include -print -quit || true)"
            SSL_LIB="$(find "${NAME}" -type f -name 'libssl.a' -print -quit || true)"
            CRYPTO_LIB="$(find "${NAME}" -type f -name 'libcrypto.a' -print -quit || true)"

            if [ -n "$INC_DIR" ] && [ -n "$SSL_LIB" ] && [ -n "$CRYPTO_LIB" ]; then
              mkdir -p "$ABI_DIR/include"
              cp -a "$INC_DIR/." "$ABI_DIR/include/"
              cp -f "$SSL_LIB" "$ABI_DIR/libssl.a"
              cp -f "$CRYPTO_LIB" "$ABI_DIR/libcrypto.a"
              ln -sf ../libssl.a    "$ABI_DIR/lib/libssl.a"
              ln -sf ../libcrypto.a "$ABI_DIR/lib/libcrypto.a"
              if [ -f "$ABI_DIR/include/openssl/ssl.h" ] && [ -f "$ABI_DIR/libssl.a" ] && [ -f "$ABI_DIR/libcrypto.a" ]; then
                valid=true
                echo "BORINGSSL_DIR=$ABI_DIR" >> $GITHUB_ENV
                export BORINGSSL_DIR="$ABI_DIR"
                echo "BORINGSSL_ASSET=$ASSET" >> $GITHUB_ENV
              fi
            else
              echo "::group::Extracted tree"
              ls -R "${NAME}" || true
              echo "::endgroup::"
              echo "::warning ::prebuilt asset structure invalid"
            fi
          else
            echo "::warning ::prebuilt asset not found ${BASE_URL}/${ASSET} (HTTP $CODE)"
          fi

          echo "found=${found}" >> $GITHUB_OUTPUT
          echo "valid=${valid}" >> $GITHUB_OUTPUT

      - name: Configure & build TDLib core (${{ matrix.abi }})
        run: |
          set -euo pipefail
          ABI="${{ matrix.abi }}"
          TD_BUILD_DIR="build-${ABI}"
          TD_INSTALL="$GITHUB_WORKSPACE/build-${ABI}/install"
          cmake -G Ninja -S "${TD_SRC_DIR}" -B "${TD_BUILD_DIR}" \
            -DCMAKE_TOOLCHAIN_FILE="$NDK_PATH/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI="${ABI}" \
            -DANDROID_PLATFORM="${ANDROID_PLATFORM}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DOPENSSL_ROOT_DIR="${BORINGSSL_DIR}" \
            -DOPENSSL_USE_STATIC_LIBS=ON \
            -DTD_ENABLE_JNI=OFF \
            -DTD_ENABLE_TESTS=OFF
          cmake --build "${TD_BUILD_DIR}" --target tdjson_static -- -j 2
          cmake --install "${TD_BUILD_DIR}" --prefix "${TD_INSTALL}"

      - name: Configure tdjni from example/java (${{ matrix.abi }})
        run: |
          set -euo pipefail
          ABI="${{ matrix.abi }}"
          TD_INSTALL="$GITHUB_WORKSPACE/build-${ABI}/install"
          cmake -G Ninja -S "${TD_SRC_DIR}/example/java" -B "build-${ABI}-jni" \
            -DCMAKE_TOOLCHAIN_FILE="$NDK_PATH/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI="${ABI}" \
            -DANDROID_PLATFORM="${ANDROID_PLATFORM}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DTd_DIR="${TD_INSTALL}/lib/cmake/Td" \
            -DOPENSSL_ROOT_DIR="${BORINGSSL_DIR}" \
            -DOPENSSL_USE_STATIC_LIBS=ON

      - name: Build & stage libtdjni.so (${{ matrix.abi }})
        run: |
          set -euo pipefail
          ABI="${{ matrix.abi }}"
          ninja -C "build-${ABI}-jni" -v tdjni
          OUT_DIR="out-jni-${ABI}"
          mkdir -p "$OUT_DIR"
          SO="$(find "build-${ABI}-jni" -type f -name 'libtdjni.so' | head -n1 || true)"
          if [ -z "$SO" ]; then
            echo "::group::jni-search-dump"
            find "build-${ABI}-jni" -maxdepth 5 -type f | sed 's/^/  /' || true
            echo "::endgroup::"
            echo "::error ::libtdjni.so not found after building tdjni"
            exit 71
          fi
          cp -v "$SO" "$OUT_DIR/libtdjni.so"

      - name: Pack tdlib AAR (${{ matrix.abi }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ABI="${{ matrix.abi }}"
          PKG_DIR="aar-${ABI}"
          MOD_DIR="${PKG_DIR}/tdlib-android"
          mkdir -p "${MOD_DIR}/src/main/jniLibs/${ABI}" "${MOD_DIR}/src/main/java"
          cp -v "out-jni-${ABI}/libtdjni.so" "${MOD_DIR}/src/main/jniLibs/${ABI}/libtdjni.so"

      - name: Download tdlib-java-bindings (same run)
        uses: actions/download-artifact@v4
        with:
          name: tdlib-java-bindings
          path: .artifacts/java

      - name: Stage sources into module (${{ matrix.abi }})
        run: |
          set -euo pipefail
          ABI="${{ matrix.abi }}"
          PKG_DIR="aar-${ABI}"
          MOD_DIR="${PKG_DIR}/tdlib-android"

          # 1) Beispiel-Java-Sourcen (Client.java, Log.java, etc.)
          rsync -a "${TD_SRC_DIR}/example/java/org" "${MOD_DIR}/src/main/java/"

          # 2) Generiertes TdApi.java Ã¼berlagern
          if ls .artifacts/java/*.zip >/dev/null 2>&1; then
            unzip -q .artifacts/java/*.zip -d /tmp/tdjava
            rsync -a /tmp/tdjava/org/ "${MOD_DIR}/src/main/java/org/"
          else
            rsync -a .artifacts/java/org/ "${MOD_DIR}/src/main/java/org/" || true
          fi

          cat > "${MOD_DIR}/src/main/AndroidManifest.xml" <<'XML'
          <manifest package="org.drinkless.tdlib.android"/>
          XML

          cat > "${MOD_DIR}/consumer-rules.pro" <<'PRO'
          -keep class org.drinkless.tdlib.** { *; }
          -keepclasseswithmembers,includedescriptorclasses class * { native <methods>; }
          -dontwarn org.drinkless.tdlib.**
          PRO

          cat > "${PKG_DIR}/settings.gradle.kts" <<'KTS'
          rootProject.name = "tdlib-android-root"
          include(":tdlib-android")
          KTS

          cat > "${PKG_DIR}/build.gradle.kts" <<'KTS'
          // root placeholder
          KTS

          cat > "${MOD_DIR}/build.gradle.kts" <<'KTS'
          plugins {
            id("com.android.library")
            id("maven-publish")
          }
          android {
            namespace = "org.drinkless.tdlib.android"
            compileSdk = 35
            defaultConfig {
              minSdk = 21
              consumerProguardFiles("consumer-rules.pro")
            }
            buildTypes {
              release { isMinifyEnabled = false }
              debug   { isMinifyEnabled = false }
            }
            packaging { jniLibs.keepDebugSymbols += listOf("**/libtdjni.so") }
            publishing { singleVariant("release") { withSourcesJar() } }
          }
          publishing {
            publications {
              create<MavenPublication>("release") {
                from(components["release"])
                groupId = "com.fishit.tdlib"
                artifactId = "tdlib-android"
                version = System.getenv("AAR_VERSION") ?: "local-${System.getenv("ABI") ?: "unknown"}"
                pom {
                  name.set("TDLib Android (AAR)")
                  description.set("TDLib JNI + Java bindings packaged for Android")
                  licenses { license { name.set("BSD-like"); url.set("https://github.com/tdlib/td") } }
                }
              }
            }
            repositories {
              maven {
                name = "github"
                url = uri("https://maven.pkg.github.com/${System.getenv("GITHUB_REPOSITORY") ?: "<owner>/<repo>"}")
                credentials {
                  username = System.getenv("GITHUB_ACTOR")
                  password = System.getenv("GITHUB_TOKEN")
                }
              }
            }
          }
          KTS

          cat > "${PKG_DIR}/gradle.properties" <<'PROPS'
          org.gradle.jvmargs=-Xmx2g -Dfile.encoding=UTF-8
          android.useAndroidX=true
          android.nonTransitiveRClass=true
          PROPS

          if [ -f "./gradlew" ] && [ -d "./gradle/wrapper" ]; then
            cp -a ./gradlew ./gradle "${PKG_DIR}/"
            chmod +x "${PKG_DIR}/gradlew"
          fi

          TDLIB_SHA="$(git -C td rev-parse --short=12 HEAD || echo unknown)"
          echo "AAR_VERSION=1.8.${TDLIB_SHA}-${ABI}" >> "${GITHUB_ENV}"
          echo "ABI=${ABI}" >> "${GITHUB_ENV}"

      - name: Build AAR (${{ matrix.abi }})
        if: ${{ hashFiles('gradlew') != '' || hashFiles('**/gradlew') != '' }}
        working-directory: aar-${{ matrix.abi }}
        run: |
          set -euo pipefail
          ./gradlew :tdlib-android:assembleRelease -x lint -x test

      - name: Upload packed AAR artifact (${{ matrix.abi }})
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-android-${{ matrix.abi }}-aar
          path: aar-${{ matrix.abi }}/tdlib-android/build/outputs/aar/tdlib-android-release.aar
          if-no-files-found: warn
          retention-days: 14

      - name: "Fallback: raw AAR zip (${{ matrix.abi }})"
        if: ${{ hashFiles('gradlew') == '' && hashFiles('**/gradlew') == '' }}
        run: |
          set -euo pipefail
          ABI="${{ matrix.abi }}"
          PKG_DIR="aar-${ABI}"
          MOD_DIR="${PKG_DIR}/tdlib-android"
          if command -v javac >/dev/null 2>&1; then
            mkdir -p "${PKG_DIR}/classes"
            find "${MOD_DIR}/src/main/java" -name "*.java" > "${PKG_DIR}/sources.list"
            if [ -s "${PKG_DIR}/sources.list" ]; then
              javac -source 8 -target 8 -d "${PKG_DIR}/classes" @"${PKG_DIR}/sources.list" || true
            fi
            (cd "${PKG_DIR}/classes" && jar cf ../classes.jar .) || true
          fi
          mkdir -p "${PKG_DIR}/aar/jni/${ABI}"
          cp -v "${MOD_DIR}/src/main/jniLibs/${ABI}/libtdjni.so" "${PKG_DIR}/aar/jni/${ABI}/" || true
          cp -v "${MOD_DIR}/src/main/AndroidManifest.xml" "${PKG_DIR}/aar/AndroidManifest.xml"
          [ -f "${PKG_DIR}/classes.jar" ] || touch "${PKG_DIR}/classes.jar"
          cp -v "${PKG_DIR}/classes.jar" "${PKG_DIR}/aar/classes.jar"
          (cd "${PKG_DIR}/aar" && zip -r ../tdlib-android-${ABI}-raw.aar .)
          echo "Raw AAR created at ${PKG_DIR}/tdlib-android-${ABI}-raw.aar"


      - name: Derive base version for Release tag (${{ matrix.abi }})
        run: |
          set -euo pipefail
          if [ -z "${AAR_VERSION_BASE:-}" ]; then
            TDLIB_SHA="$(git -C td rev-parse --short=12 HEAD || echo unknown)"
            echo "AAR_VERSION_BASE=1.8.${TDLIB_SHA}" >> "$GITHUB_ENV"
          fi
          echo "AAR_VERSION_BASE=${AAR_VERSION_BASE:-unset}"

      - name: Upload AAR to GitHub Release (${{ matrix.abi }})
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: tdlib-android-${{ env.AAR_VERSION_BASE }}
          name: TDLib Android ${{ env.AAR_VERSION_BASE }}
          body: |
            TDLib Android AAR (JNI + Java Bindings)
            - ABI: ${{ matrix.abi }}
            - BoringSSL: ${{ env.BORINGSSL_ASSET }}
            - Built from: ${{ github.sha }}
          draft: false
          prerelease: false
          make_latest: true
          files: |
            aar-${{ matrix.abi }}/tdlib-android/build/outputs/aar/tdlib-android-release.aar

      - name: Upload RAW AAR to GitHub Release (fallback) (${{ matrix.abi }})
        if: ${{ github.ref == 'refs/heads/main' && !(hashFiles('gradlew') != '' || hashFiles('**/gradlew') != '') }}
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: tdlib-android-${{ env.AAR_VERSION_BASE }}
          name: TDLib Android ${{ env.AAR_VERSION_BASE }}
          body: |
            TDLib Android AAR (RAW fallback)
            - ABI: ${{ matrix.abi }}
            - BoringSSL: ${{ env.BORINGSSL_ASSET }}
            - Built from: ${{ github.sha }}
          draft: false
          prerelease: false
          make_latest: true
          files: |
            aar-${{ matrix.abi }}/tdlib-android-${{ matrix.abi }}-raw.aar
