name: Android – Quick (cached)

on:
  workflow_dispatch:

concurrency:
  group: android-quick-${{ github.ref }}
  cancel-in-progress: false

env:
  ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
  ANDROID_HOME: ${{ runner.temp }}/android-sdk
  # ⇣⇣⇣ HIER ANPASSEN ⇣⇣⇣
  ANDROID_API_LEVEL: "34"            # z.B. 34 (oder 24/28 je nach Projekt)
  ANDROID_BUILD_TOOLS: "34.0.0"      # passend zum API-Level
  ANDROID_NDK_VERSION: "26.3.11579264"  # z.B. 26.3.x (oder exakt, was du brauchst)
  CMAKE_VERSION: "3.31.1"            # oder 3.22.1/3.30.x – was dein Projekt braucht
  # ⇡⇡⇡ HIER ANPASSEN ⇡⇡⇡

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Gradle Wrapper + Dependency Cache (automatisch, sicher)
      - name: Setup Gradle (caching)
        uses: gradle/actions/setup-gradle@v4

      # SDK/NDK/CMake Cache
      - name: Cache Android SDK/NDK/CMake
        id: cache-android
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ANDROID_SDK_ROOT }}
          key: >
            android-sdk-${{ runner.os }}-sdk${{ env.ANDROID_API_LEVEL }}-bt${{ env.ANDROID_BUILD_TOOLS }}-ndk${{ env.ANDROID_NDK_VERSION }}-cmake${{ env.CMAKE_VERSION }}
          restore-keys: |
            android-sdk-${{ runner.os }}-

      # SDK/NDK/CMake installieren (idempotent; nutzt Cache, wenn vorhanden)
      - name: Install Android cmdline-tools
        run: |
          set -euo pipefail
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          if [ ! -d "$ANDROID_SDK_ROOT/cmdline-tools/latest" ]; then
            TMP=$(mktemp -d)
            cd "$TMP"
            curl -sSLo sdk.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
            unzip -q sdk.zip
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            mv cmdline-tools/* "$ANDROID_SDK_ROOT/cmdline-tools/latest"/
          fi
          yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses

      - name: Install SDK components (platforms, build-tools, NDK, CMake)
        run: |
          set -euo pipefail
          sdk="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          "$sdk" "platforms;android-${ANDROID_API_LEVEL}"
          "$sdk" "platform-tools"
          "$sdk" "build-tools;${ANDROID_BUILD_TOOLS}"
          "$sdk" "ndk;${ANDROID_NDK_VERSION}"
          "$sdk" "cmake;${CMAKE_VERSION}"
          echo "✅ SDK/NDK/CMake bereit"

      # ccache für C/C++
      - name: Enable ccache
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y ccache
          echo "max_size = 2.0G" > "$HOME/.ccache/ccache.conf"
          echo "CC='ccache clang'" >> $GITHUB_ENV
          echo "CXX='ccache clang++'" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=ccache" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=ccache" >> $GITHUB_ENV
          echo "PATH=$PATH:/usr/lib/ccache" >> $GITHUB_ENV
          ccache -s || true

      # Optional: GPerf/ninja/… für native Builds (TDLib etc.)
      - name: Native toolchain helpers
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y ninja-build gperf pkg-config

      # Jetzt dein Build
      - name: Build (Debug)
        run: |
          set -euo pipefail
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          ./gradlew --no-daemon --stacktrace assembleDebug

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: |
            **/build/outputs/apk/debug/*.apk