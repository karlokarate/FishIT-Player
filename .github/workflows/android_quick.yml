name: Android – Quick Debug (fast/no-sign)

on:
  workflow_dispatch:
    inputs:
      abis:
        description: "ABIs (Splits/Universal)"
        type: choice
        required: true
        default: "arm64+v7a"
        options:
          - arm64+v7a
          - arm64
          - v7a
          - universal
      sdk_api:
        description: "SDK Platform (36 = Android 16)"
        required: false
        default: "36"
      build_tools:
        description: "Build-Tools (35.0.0 stabil; 36.x = EXPERIMENTAL, sinnvoll mit AGP ≥ 9)"
        required: false
        default: "35.0.0"
      jdk:
        description: "JDK (21 LTS empfohlen; AGP 8.12+ voll kompatibel)"
        required: false
        default: "21"
      use_gradle_9x:
        description: "Gradle 9.x OVERRIDE (RISKY) – benötigt AGP ≥ 8.13 ODER AGP 9 Preview"
        type: choice
        default: "false"
        options:
          - "false"
          - "true"
      gradle_9x_version:
        description: "Gradle 9.x Version (wirksam nur wenn use_gradle_9x=true)"
        required: false
        default: "9.1.0"
      agp_override:
        description: "AGP Override (z.B. 8.13.0 oder 9.0.0-alphaXX) – bei Gradle 9.x mind. 8.13!"
        required: false
        default: ""
      kotlin_override:
        description: "Kotlin Override (z.B. 2.2.21) – Compose/Media3-Kompat. beachten"
        required: false
        default: ""
      pr_comment:
        description: "PR-Kommentar posten (Artefakte/Run-Link)"
        type: choice
        default: "false"
        options:
          - "false"
          - "true"
      issue_number:
        description: "PR/Issue-Nummer (optional für workflow_dispatch)"
        required: false
        default: ""
      debug_tmate:
        description: "tmate-Debug"
        type: choice
        default: "false"
        options:
          - "false"
          - "true"

permissions:
  contents: read

concurrency:
  group: android-fast-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  assemble-debug:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ github.event.inputs.jdk }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: |
            platform-tools
            platforms;android-${{ github.event.inputs.sdk_api }}
            build-tools;${{ github.event.inputs.build_tools }}

      - name: Setup Gradle (cache+wrapper validation)
        uses: gradle/actions/setup-gradle@v5

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Optional – Gradle 9.x OVERRIDE (Guard prüft AGP)
        if: ${{ github.event.inputs.use_gradle_9x == 'true' }}
        run: |
          set -euo pipefail
          V="${{ github.event.inputs.gradle_9x_version }}"
          if [[ ! -f gradle/wrapper/gradle-wrapper.properties ]]; then
            echo "::error::gradle-wrapper.properties fehlt"
            exit 1
          fi
          sed -i -E "s#distributionUrl=.*#distributionUrl=https://services.gradle.org/distributions/gradle-${V}-bin.zip#g" gradle/wrapper/gradle-wrapper.properties
          echo "Gradle Wrapper → ${V}"
          AGP="$(grep -RhoE 'com\.android\.tools\.build:gradle:([0-9]+\.[0-9]+(\.[0-9]+)?)' -n --include=*.gradle* --exclude-dir=**/build | head -1 | sed -E 's/.*:([0-9.]+).*/\1/')"
          vergte() { [ "$1" = "$2" ] || [ "$(printf '%s' "$1" "$2" | sort -V | tail -n1)" = "$1" ]; }
          if [[ -n "$AGP" ]] && ! vergte "$AGP" "8.13.0"; then
            echo "::error::Gradle 9.x erfordert AGP >= 8.13 ODER AGP 9 Preview. Setze 'agp_override' entsprechend."
            exit 2
          fi

      - name: Optional – AGP/Kotlin Override (In-Place Patch nur für Run)
        if: ${{ github.event.inputs.agp_override != '' || github.event.inputs.kotlin_override != '' }}
        run: |
          python3 - <<'PY'
          import re, pathlib, os
          agp = os.environ.get("AGP_NEW","").strip()
          kt  = os.environ.get("KOTLIN_NEW","").strip()
          files=[p for p in pathlib.Path(".").rglob("*") if p.is_file() and p.suffix in (".gradle",".kts",".toml") and "build" not in p.parts]
          for p in files:
            s=p.read_text(encoding="utf-8",errors="ignore"); o=s
            if agp:
              s=re.sub(r"(com\.android\.tools\.build:gradle:)\d+\.\d+(?:\.\d+)?", rf"\g<1>{agp}", s)
              s=re.sub(r'(id\(["\']com\.android\.(?:application|library|test|dynamic-feature)["\']\)\s+version\s+")[^"]+(")', rf"\g<1>{agp}\g<2>", s)
              s=re.sub(r'(?m)^(agp\s*=\s*")\d+\.\d+(?:\.\d+)?(")', rf"\g<1>{agp}\g<2>", s)
            if kt:
              s=re.sub(r'(org\.jetbrains\.kotlin:(?:kotlin-gradle-plugin|kotlin-stdlib)[^:]*:)\d+\.\d+(?:\.\d+)?', rf"\g<1>{kt}", s)
              s=re.sub(r'(id\(["\']org\.jetbrains\.kotlin\.(?:android|jvm|multiplatform)["\']\)\s+version\s+")[^"]+(")', rf"\g<1>{kt}\g<2>", s)
              s=re.sub(r'(?m)^(kotlin\s*=\s*")\d+\.\d+(?:\.\d+)?(")', rf"\g<1>{kt}\g<2>", s)
            if s!=o: p.write_text(s,encoding="utf-8")
          PY
        env:
          AGP_NEW: ${{ github.event.inputs.agp_override }}
          KOTLIN_NEW: ${{ github.event.inputs.kotlin_override }}

      - name: ABI / Splits konfigurieren
        run: |
          case "${{ github.event.inputs.abis }}" in
            arm64+v7a)
              echo "ORG_GRADLE_PROJECT_abiFilters=arm64-v8a,armeabi-v7a" >> $GITHUB_ENV
              echo "ORG_GRADLE_PROJECT_useSplits=true"  >> $GITHUB_ENV
              echo "ORG_GRADLE_PROJECT_universalApk=false" >> $GITHUB_ENV
              ;;
            arm64)
              echo "ORG_GRADLE_PROJECT_abiFilters=arm64-v8a" >> $GITHUB_ENV
              echo "ORG_GRADLE_PROJECT_useSplits=true"  >> $GITHUB_ENV
              echo "ORG_GRADLE_PROJECT_universalApk=false" >> $GITHUB_ENV
              ;;
            v7a)
              echo "ORG_GRADLE_PROJECT_abiFilters=armeabi-v7a" >> $GITHUB_ENV
              echo "ORG_GRADLE_PROJECT_useSplits=true"  >> $GITHUB_ENV
              echo "ORG_GRADLE_PROJECT_universalApk=false" >> $GITHUB_ENV
              ;;
            universal)
              echo "ORG_GRADLE_PROJECT_abiFilters=" >> $GITHUB_ENV
              echo "ORG_GRADLE_PROJECT_useSplits=false" >> $GITHUB_ENV
              echo "ORG_GRADLE_PROJECT_universalApk=true"  >> $GITHUB_ENV
              ;;
          esac

      - name: Gradle Problem-Matcher
        continue-on-error: true
        run: |
          if [[ -f .github/gradle-problem-matcher.json ]]; then
            echo "::add-matcher::.github/gradle-problem-matcher.json"
          fi

      - name: Assemble Debug (ohne Tests)
        run: |
          ./gradlew :app:assembleDebug             -PabiFilters="${{ env.ORG_GRADLE_PROJECT_abiFilters }}"             -PuniversalApk="${{ env.ORG_GRADLE_PROJECT_universalApk }}"             -PuseSplits="${{ env.ORG_GRADLE_PROJECT_useSplits }}"             --configuration-cache --build-cache --parallel             --stacktrace --warning-mode all -x test

      - name: Artefakt: APKs
        uses: actions/upload-artifact@v4
        with:
          name: debug-${{ github.event.inputs.abis }}
          path: app/build/outputs/apk/**/**/*.apk
          if-no-files-found: error
          retention-days: 7

      - name: Build Summary
        if: always()
        run: |
          {
            echo "## Artefakte – Quick Debug"
            echo ""
            echo "**Run:** https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
            echo ""
            echo "### APKs"
            find app/build/outputs/apk -type f -name "*.apk" | sed 's/^/- /' || echo "- (keine gefunden)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: PR-Kommentar (optional)
        if: ${{ github.event.inputs.pr_comment == 'true' && (github.event_name == 'pull_request' || github.event.inputs.issue_number != '') }}
        uses: actions/github-script@v8
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = ["### ⚙️ Quick Debug fertig", `**Run:** ${runUrl}`, "", "Artefakte: siehe **Artifacts** und **Run Summary**."].join("\n");
            const issue_number = context.payload.pull_request?.number || Number(core.getInput('issue_number'));
            if (issue_number) await github.rest.issues.createComment({ ...context.repo, issue_number, body });

      - name: Start tmate (on failure/explicit)
        if: ${{ failure() || github.event.inputs.debug_tmate == 'true' }}
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
