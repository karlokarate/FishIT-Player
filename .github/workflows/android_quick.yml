name: Android – Build (cached, TDLib, robust)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "Build-Typ"
        type: choice
        required: true
        default: "debug"
        options: [debug, release]
      abis:
        description: "ABIs / Splits"
        type: choice
        required: true
        default: "arm64+v7a"
        options: [arm64+v7a, arm64, v7a, universal]
      mirror_only:
        description: "Mirror-Modus → setzt TG_OBX_ENABLED_DEFAULT (true deaktiviert OBX standardmäßig)"
        type: choice
        required: true
        default: "true"
        options: ["true","false"]
      td_ref:
        description: "TDLib Ref (Tag/Commit/Branch). Leer = neuestes v*-Tag"
        type: string
        required: false
        default: ""
      api_level:
        description: "Android API-Level für TDLib/NDK"
        type: choice
        required: true
        default: "36"
        options: ["24","28","33","34","35","36"]
      build_tools:
        description: "Android Build-Tools Version"
        type: string
        required: true
        default: "36.0.0"
      ndk_version:
        description: "NDK Version (z. B. 26.3.11579264)"
        type: string
        required: true
        default: "26.3.11579264"
      cmake_version:
        description: "CMake Version (z. B. 3.31.1)"
        type: string
        required: true
        default: "3.31.1"
      use_splits:
        description: "APK Splits aktivieren (empfohlen)"
        type: choice
        required: true
        default: "true"
        options: ["true","false"]
      universal_apk:
        description: "Universal-APK zusätzlich bauen (groß)"
        type: choice
        required: true
        default: "false"
        options: ["false","true"]

concurrency:
  group: android-build-cached-${{ github.ref }}
  cancel-in-progress: false

env:
  JAVA_VERSION: "17"
  ANDROID_SDK_ROOT: ${{ github.workspace }}/.android-sdk
  ANDROID_HOME: ${{ github.workspace }}/.android-sdk
  CCACHE_DIR: ${{ github.workspace }}/.ccache

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Gradle (caching)
        uses: gradle/actions/setup-gradle@v4

      # ---------- Cache SDK/NDK/CMake ----------
      - name: Cache Android SDK/NDK/CMake
        id: cache-android
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ANDROID_SDK_ROOT }}
          key: >
            android-sdk-${{ runner.os }}-api${{ inputs.api_level }}-bt${{ inputs.build_tools }}-ndk${{ inputs.ndk_version }}-cmake${{ inputs.cmake_version }}
          restore-keys: |
            android-sdk-${{ runner.os }}-

      # ---------- Install SDK + accept licenses (robust) ----------
      - name: Install Android cmdline-tools
        run: |
          set -euo pipefail
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          if [ ! -d "$ANDROID_SDK_ROOT/cmdline-tools/latest" ]; then
            TMP=$(mktemp -d)
            cd "$TMP"
            curl -sSLo sdk.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
            unzip -q sdk.zip
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            mv cmdline-tools/* "$ANDROID_SDK_ROOT/cmdline-tools/latest"/
          fi
          echo "y" | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" --licenses || true
          "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" --update || true

      - name: Install SDK components
        run: |
          set -euo pipefail
          sdk="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          "$sdk" "platforms;android-${{ inputs.api_level }}"
          "$sdk" "platform-tools"
          "$sdk" "build-tools;${{ inputs.build_tools }}"
          "$sdk" "ndk;${{ inputs.ndk_version }}"
          "$sdk" "cmake;${{ inputs.cmake_version }}"

      # ---------- Cache ccache ----------
      - name: Cache ccache
        id: cache-ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-ndk${{ inputs.ndk_version }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - name: Enable ccache
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y ccache
          mkdir -p "$CCACHE_DIR"
          echo "max_size = 2.0G" > "$CCACHE_DIR/ccache.conf"
          echo "CC=ccache clang" >> $GITHUB_ENV
          echo "CXX=ccache clang++" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=ccache" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=ccache" >> $GITHUB_ENV
          echo "PATH=$PATH:/usr/lib/ccache" >> $GITHUB_ENV
          ccache -s || true

      # ---------- Native helper tools ----------
      - name: Native toolchain helpers
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y ninja-build gperf pkg-config

      # ---------- Prepare build vars ----------
      - name: Prepare build vars
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          case "${{ inputs.abis }}" in
            "arm64+v7a") ABI_FILTERS="arm64-v8a,armeabi-v7a"; TD_FLAGS="";;
            "arm64")     ABI_FILTERS="arm64-v8a"; TD_FLAGS="--only-arm64";;
            "v7a")       ABI_FILTERS="armeabi-v7a"; TD_FLAGS="--only-v7a";;
            "universal") ABI_FILTERS="arm64-v8a,armeabi-v7a"; TD_FLAGS="";;
            *)           ABI_FILTERS="arm64-v8a,armeabi-v7a"; TD_FLAGS="";;
          esac
          if [[ "${{ inputs.universal_apk }}" == "true" ]]; then
            USE_SPLITS="false"
            UNIVERSAL_APK="true"
          else
            USE_SPLITS="${{ inputs.use_splits }}"
            UNIVERSAL_APK="false"
          fi
          if [[ "${{ inputs.build_type }}" == "release" ]]; then
            TD_TYPE="--release"
            GRADLE_TASK="assembleRelease"
          else
            TD_TYPE="--minsize"
            GRADLE_TASK="assembleDebug"
          fi
          echo "ABI_FILTERS=${ABI_FILTERS}" >> $GITHUB_ENV
          echo "TD_FLAGS=${TD_FLAGS}" >> $GITHUB_ENV
          echo "TD_TYPE=${TD_TYPE}" >> $GITHUB_ENV
          echo "GRADLE_TASK=${GRADLE_TASK}" >> $GITHUB_ENV
          echo "USE_SPLITS=${USE_SPLITS}" >> $GITHUB_ENV
          echo "UNIVERSAL_APK=${UNIVERSAL_APK}" >> $GITHUB_ENV

      # ---------- Sanitize parts for cache keys ----------
      - name: Sanitize cache key parts
        shell: bash
        run: |
          set -euo pipefail
          SAFE_ABI="${ABI_FILTERS//,/+}"
          SAFE_REF="${{ inputs.td_ref }}"
          SAFE_REF="${SAFE_REF//,/+}"
          echo "ABI_KEY=$SAFE_ABI" >> $GITHUB_ENV
          echo "REF_KEY=$SAFE_REF" >> $GITHUB_ENV

      # ---------- Include script hash to invalidate cache when script changes ----------
      - name: Compute script hash
        id: hash
        shell: bash
        run: |
          set -euo pipefail
          if [ -f scripts/build_tdlib_android.sh ]; then
            echo "SCRIPT_SHA=$(sha256sum scripts/build_tdlib_android.sh | cut -d' ' -f1)" >> $GITHUB_ENV
          else
            echo "SCRIPT_SHA=noscript" >> $GITHUB_ENV
          fi

      # ---------- Cache TDLib artifacts ----------
      - name: Cache TDLib artifacts
        id: cache-tdlib
        uses: actions/cache@v4
        with:
          path: |
            libtd/src/main/jniLibs/arm64-v8a/libtdjni.so
            libtd/src/main/jniLibs/armeabi-v7a/libtdjni.so
            libtd/src/main/java/org/drinkless/tdlib/TdApi.java
            libtd/src/main/java/org/drinkless/tdlib/Client.java
            libtd/.tdlib_meta
            libtd/TDLIB_VERSION.txt
            .third_party/td
            .third_party/boringssl
            .third_party/openssl-config
          key: >
            tdlib-${{ runner.os }}-ndk${{ inputs.ndk_version }}-cmake${{ inputs.cmake_version }}
            -abi${{ env.ABI_KEY }}-type${{ inputs.build_type }}-api${{ inputs.api_level }}
            -ref${{ env.REF_KEY }}-script${{ env.SCRIPT_SHA }}
          restore-keys: |
            tdlib-${{ runner.os }}-ndk${{ inputs.ndk_version }}-cmake${{ inputs.cmake_version }}-

      # ---------- Validate NDK (robust re-install if missing) ----------
      - name: Validate NDK installation
        run: |
          set -euo pipefail
          NDK_DIR="$ANDROID_SDK_ROOT/ndk/${{ inputs.ndk_version }}"
          if [ ! -f "$NDK_DIR/build/cmake/android.toolchain.cmake" ]; then
            echo "⚠️  NDK missing or incomplete at $NDK_DIR — reinstalling..."
            "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" "ndk;${{ inputs.ndk_version }}"
            if [ ! -f "$NDK_DIR/build/cmake/android.toolchain.cmake" ]; then
              echo "❌ Still no toolchain after reinstall"; exit 1
            fi
          fi
          echo "✅ NDK toolchain OK: $NDK_DIR"
          ls -l "$NDK_DIR/build/cmake/android.toolchain.cmake"

      # ---------- Build TDLib (only if cache miss) ----------
      - name: Build TDLib (JNI + Java bindings)
        if: steps.cache-tdlib.outputs.cache-hit != 'true'
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_NDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}/ndk/${{ inputs.ndk_version }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_SDK_ROOT }}/ndk/${{ inputs.ndk_version }}
          API_LEVEL: ${{ inputs.api_level }}
          TD_REF: ${{ inputs.td_ref }}
        run: |
          set -euo pipefail
          chmod +x scripts/build_tdlib_android.sh
          ARGS="${TD_FLAGS} ${TD_TYPE} --api-level=${{ inputs.api_level }}"
          if [[ -n "${{ inputs.td_ref }}" ]]; then
            ARGS="$ARGS --ref ${{ inputs.td_ref }}"
          fi
          echo ">> tdlib args: $ARGS"
          ./scripts/build_tdlib_android.sh $ARGS

      - name: Verify tdlib JNI deps
        run: ./gradlew --no-daemon verifyTdlib || true

      - name: Write local.properties
        run: |
          echo "sdk.dir=${{ env.ANDROID_SDK_ROOT }}" > local.properties
          cat local.properties

      - name: Inject signing secrets (optional)
        run: |
          set -euo pipefail
          GP="$HOME/.gradle/gradle.properties"
          mkdir -p "$(dirname "$GP")"
          touch "$GP"
          add_prop () { key="$1"; val="$2"; if [[ -n "$val" ]]; then echo "$key=$val" >> "$GP"; fi; }
          add_prop "MYAPP_UPLOAD_STORE_FILE"      "${{ secrets.MYAPP_UPLOAD_STORE_FILE }}"
          add_prop "MYAPP_UPLOAD_STORE_PASSWORD"  "${{ secrets.MYAPP_UPLOAD_STORE_PASSWORD }}"
          add_prop "MYAPP_UPLOAD_KEY_ALIAS"       "${{ secrets.MYAPP_UPLOAD_KEY_ALIAS }}"
          add_prop "MYAPP_UPLOAD_KEY_PASSWORD"    "${{ secrets.MYAPP_UPLOAD_KEY_PASSWORD }}"
          echo "== ~/.gradle/gradle.properties =="
          sed 's/=.*/=<redacted>/' "$GP" || true

      - name: Build app
        run: |
          set -euo pipefail
          EXTRA="-PuseSplits=${USE_SPLITS} -PabiFilters=${ABI_FILTERS} -PuniversalApk=${UNIVERSAL_APK} -PTG_OBX_ENABLED_DEFAULT=${{ inputs.mirror_only }}"
          echo "Gradle task: ${GRADLE_TASK}"
          echo "Extra flags: ${EXTRA}"
          ./gradlew --no-daemon --stacktrace ${GRADLE_TASK} $EXTRA

      - name: Upload APKs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ inputs.build_type }}-${{ inputs.abis }}
          path: |
            **/build/outputs/apk/**/**/*.apk
            **/build/outputs/bundle/**/**/*.aab
