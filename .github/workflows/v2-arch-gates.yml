# V2 Architecture Guardrails - Phase A1
# Enforces layer boundaries and prevents illegal wiring
# See AGENTS.md Section 4.5 for layer hierarchy rules

name: V2 Architecture Gates

on:
  pull_request:
    branches:
      - main
      - architecture/v2-bootstrap
    paths:
      - 'app-v2/**'
      - 'core/**'
      - 'feature/**'
      - 'infra/**'
      - 'pipeline/**'
      - 'playback/**'
      - 'player/**'
      - 'build.gradle.kts'
      - 'settings.gradle.kts'
      - 'detekt-config.yml'
      - '.github/workflows/v2-arch-gates.yml'

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: v2-arch-gates-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  arch_guardrails:
    name: Arch Guardrails
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Detekt (Layer Boundaries + Logging Contract)
        run: ./gradlew detekt --no-daemon --stacktrace
        env:
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2g"

      - name: Run Grep-based Architecture Checks
        run: ./scripts/ci/check-arch-guardrails.sh

      - name: Upload Detekt Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: detekt-architecture-reports
          path: |
            **/build/reports/detekt/
          retention-days: 7

  release_wiring_gates:
    name: Release Wiring Gates
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Compile app-v2 (Release)
        run: ./gradlew :app-v2:compileReleaseKotlin --no-daemon --stacktrace
        # Only use secrets if not from a fork (forks don't have access to secrets)
        # Build defaults to safe values (0 and "") when secrets are missing
        if: github.event.pull_request.head.repo.fork == false
        env:
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=1g"
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}

      - name: Compile app-v2 (Release, Fork-Safe)
        run: ./gradlew :app-v2:compileReleaseKotlin --no-daemon --stacktrace
        # For forks, run without secrets (build.gradle.kts provides safe defaults)
        if: github.event.pull_request.head.repo.fork == true
        env:
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=1g"

      - name: Compile feature:home (Release)
        run: ./gradlew :feature:home:compileReleaseKotlin --no-daemon --stacktrace
        env:
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2g"

      - name: Compile feature:telegram-media (Release)
        run: ./gradlew :feature:telegram-media:compileReleaseKotlin --no-daemon --stacktrace
        env:
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2g"

      - name: Compile playback:domain (Release)
        run: ./gradlew :playback:domain:compileReleaseKotlin --no-daemon --stacktrace
        env:
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2g"

      - name: KSP Wiring Gates - feature:home
        run: ./gradlew :feature:home:kspReleaseKotlin --no-daemon --stacktrace
        env:
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2g"

      - name: KSP Wiring Gates - app-v2
        run: ./gradlew :app-v2:kspReleaseKotlin --no-daemon --stacktrace
        # Only use secrets if not from a fork (forks don't have access to secrets)
        # Build defaults to safe values (0 and "") when secrets are missing
        if: github.event.pull_request.head.repo.fork == false
        env:
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2g"
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}

      - name: KSP Wiring Gates - app-v2 (Fork-Safe)
        run: ./gradlew :app-v2:kspReleaseKotlin --no-daemon --stacktrace
        # For forks, run without secrets (build.gradle.kts provides safe defaults)
        if: github.event.pull_request.head.repo.fork == true
        env:
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2g"

      - name: Upload Build Reports
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: wiring-compile-reports
          path: |
            **/build/reports/
          retention-days: 7

  gate_summary:
    name: Gate Summary
    runs-on: ubuntu-latest
    needs: [arch_guardrails, release_wiring_gates]
    if: always()

    steps:
      - name: Check gate results
        run: |
          echo "==================================="
          echo "V2 Architecture Gate Results"
          echo "==================================="
          echo "Architecture Gates (Detekt): ${{ needs.arch_guardrails.result }}"
          echo "Wiring Compile Gates: ${{ needs.release_wiring_gates.result }}"
          echo ""
          
          if [ "${{ needs.arch_guardrails.result }}" != "success" ]; then
            echo "❌ Architecture gates failed - layer boundary violations detected"
            echo "   See AGENTS.md Section 4.5 for layer hierarchy rules"
            exit 1
          fi
          
          if [ "${{ needs.release_wiring_gates.result }}" != "success" ]; then
            echo "❌ Wiring compile gates failed - illegal module dependencies"
            echo "   Check build reports for details"
            exit 1
          fi
          
          echo "✅ All architecture gates passed"
