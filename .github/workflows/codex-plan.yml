name: codex-plan

on:
  issues:
    types: [opened, edited, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue:
        description: "Issue number (optional for manual run)"
        required: false

permissions:
  contents: read
  issues: write
  actions: write

jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requirements
        shell: bash
        run: |
          set -e
          pip install -U pip
          if [ -f .github/codex/requirements.txt ]; then
            pip install -r .github/codex/requirements.txt
          else
            pip install 'requests>=2.32.3,<3' 'chardet>=5.2.0,<6' 'openai>=1.40.0,<2' 'unidiff>=0.7.5,<1'
          fi

      # Robust: kein Heredoc, einfach unzip nutzen, falls ZIP existiert
      - name: Unpack shared-lib (optional)
        shell: bash
        run: |
          set -e
          if [ ! -d .github/codex/lib ] && [ -f .github/codex/codex-shared-lib.zip ]; then
            mkdir -p .github/codex/lib
            unzip -q -o .github/codex/codex-shared-lib.zip -d .github/codex/lib
            echo "unzipped shared lib"
          else
            echo "shared lib present or zip missing â€” skipping"
          fi

      - name: Run ContextMap (Bot 1)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          CODEX_POST_ISSUE_COMMENT: 'true'
          CODEX_ADD_LABEL: 'true'
          CODEX_NOTIFY_SOLVER: 'true'
          CODEX_DEEP_REASONING: 'true'
          CODEX_ISSUE_NUMBER: ${{ inputs.issue }}
        run: python -u .github/codex/bot_contextmap.py
