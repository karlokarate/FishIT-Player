name: Android â€“ Quality Gate (Picker)

on:
  workflow_dispatch:
    inputs:
      detekt:
        description: "Detekt ausfÃ¼hren"
        type: choice
        default: "true"
        options:
          - "true"
          - "false"
      ktlint:
        description: "Ktlint/Spotless prÃ¼fen"
        type: choice
        default: "true"
        options:
          - "true"
          - "false"
      android_lint:
        description: "Android Lint (Debug + Vital)"
        type: choice
        default: "true"
        options:
          - "true"
          - "false"
      unit_tests:
        description: "Unit-Tests (testDebugUnitTest)"
        type: choice
        default: "true"
        options:
          - "true"
          - "false"
      coverage_kover:
        description: "Coverage (Kover XML)"
        type: choice
        default: "false"
        options:
          - "true"
          - "false"
      dep_check:
        description: "OWASP Dependency-Check"
        type: choice
        default: "false"
        options:
          - "true"
          - "false"
      api_check:
        description: "API Check (metalava)"
        type: choice
        default: "false"
        options:
          - "true"
          - "false"
      config_json:
        description: "JSON-Overrides (sdk_api, build_tools, jdk, use_gradle_9x, gradle_9x_version, agp_override, kotlin_override, pr_comment, issue_number)"
        required: false
        default: "{}"

permissions:
  contents: read

concurrency:
  group: android-quality-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Parse config overrides
        id: cfg
        run: |
          python3 - <<'PY'
          import json, os, sys

          defaults = {
              "sdk_api": "36",
              "build_tools": "35.0.0",
              "jdk": "21",
              "use_gradle_9x": "false",
              "gradle_9x_version": "9.1.0",
              "agp_override": "",
              "kotlin_override": "",
              "pr_comment": "false",
              "issue_number": "",
          }

          raw = os.environ.get("RAW_CONFIG", "").strip()
          if not raw:
              data = {}
          else:
              try:
                  data = json.loads(raw)
              except json.JSONDecodeError as exc:
                  print(f"::error::config_json ist kein gÃ¼ltiges JSON ({exc})")
                  sys.exit(1)

          merged = {}
          for key, default in defaults.items():
              value = data.get(key, default)
              if isinstance(value, bool):
                  value = "true" if value else "false"
              else:
                  value = str(value)
              merged[key] = value

          env_path = os.environ["GITHUB_ENV"]
          out_path = os.environ["GITHUB_OUTPUT"]
          with open(env_path, "a", encoding="utf-8") as envf, open(out_path, "a", encoding="utf-8") as outf:
              for key, value in merged.items():
                  envf.write(f"{key}={value}\n")
                  outf.write(f"{key}={value}\n")
          PY
        env:
          RAW_CONFIG: ${{ github.event.inputs.config_json }}

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ steps.cfg.outputs.jdk }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: |
            platform-tools
            platforms;android-${{ steps.cfg.outputs.sdk_api }}
            build-tools;${{ steps.cfg.outputs.build_tools }}

      - name: Setup Gradle (cache+wrapper validation)
        uses: gradle/actions/setup-gradle@v5

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # Risk Switches
      - name: Optional â€“ Gradle 9.x OVERRIDE (Guard prÃ¼ft AGP)
        if: ${{ steps.cfg.outputs.use_gradle_9x == 'true' }}
        run: |
          set -euo pipefail
          V="${{ steps.cfg.outputs.gradle_9x_version }}"
          if [[ ! -f gradle/wrapper/gradle-wrapper.properties ]]; then
            echo "::error::gradle-wrapper.properties fehlt"
            exit 1
          fi
          sed -i -E "s#distributionUrl=.*#distributionUrl=https://services.gradle.org/distributions/gradle-${V}-bin.zip#g" gradle/wrapper/gradle-wrapper.properties
          echo "Gradle Wrapper â†’ ${V}"
          AGP="$(grep -RhoE 'com\.android\.tools\.build:gradle:([0-9]+\.[0-9]+(\.[0-9]+)?)' -n --include=*.gradle* --exclude-dir=**/build | head -1 | sed -E 's/.*:([0-9.]+).*/\1/')"
          vergte() { [ "$1" = "$2" ] || [ "$(printf '%s\n%s\n' "$1" "$2" | sort -V | tail -n1)" = "$1" ]; }
          if [[ -n "$AGP" ]] && ! vergte "$AGP" "8.13.0"; then
            echo "::error::Gradle 9.x erfordert AGP >= 8.13 ODER AGP 9 Preview. Setze 'agp_override' entsprechend."
            exit 2
          fi

      - name: Optional â€“ AGP/Kotlin Override (In-Place Patch nur fÃ¼r Run)
        if: ${{ steps.cfg.outputs.agp_override != '' || steps.cfg.outputs.kotlin_override != '' }}
        run: |
          python3 - <<'PY'
          import re, pathlib, os
          agp = os.environ.get("AGP_NEW","").strip()
          kt  = os.environ.get("KOTLIN_NEW","").strip()
          files=[p for p in pathlib.Path(".").rglob("*") if p.is_file() and p.suffix in (".gradle",".kts",".toml") and "build" not in p.parts]
          for p in files:
            s=p.read_text(encoding="utf-8",errors="ignore"); o=s
            if agp:
              s=re.sub(r"(com\.android\.tools\.build:gradle:)\d+\.\d+(?:\.\d+)?", rf"\g<1>{agp}", s)
              s=re.sub(r'(id\(["\']com\.android\.(?:application|library|test|dynamic-feature)["\']\)\s+version\s+")[^"]+(")', rf"\g<1>{agp}\g<2>", s)
              s=re.sub(r'(?m)^(agp\s*=\s*")\d+\.\d+(?:\.\d+)?(")', rf"\g<1>{agp}\g<2>", s)
            if kt:
              s=re.sub(r'(org\.jetbrains\.kotlin:(?:kotlin-gradle-plugin|kotlin-stdlib)[^:]*:)\d+\.\d+(?:\.\d+)?', rf"\g<1>{kt}", s)
              s=re.sub(r'(id\(["\']org\.jetbrains\.kotlin\.(?:android|jvm|multiplatform)["\']\)\s+version\s+")[^"]+(")', rf"\g<1>{kt}\g<2>", s)
              s=re.sub(r'(?m)^(kotlin\s*=\s*")\d+\.\d+(?:\.\d+)?(")', rf"\g<1>{kt}\g<2>", s)
            if s!=o: p.write_text(s,encoding="utf-8")
          PY
        env:
          AGP_NEW: ${{ steps.cfg.outputs.agp_override }}
          KOTLIN_NEW: ${{ steps.cfg.outputs.kotlin_override }}

      - name: Problem-Matcher
        continue-on-error: true
        run: |
          if [[ -f .github/gradle-problem-matcher.json ]]; then
            echo "::add-matcher::.github/gradle-problem-matcher.json"
          fi

      # Checks
      - name: Helper â€“ run-if-task-exists
        shell: bash
        run: |
          cat > run-if-task-exists.sh <<'SH'
          #!/usr/bin/env bash
          set -euo pipefail
          TASK="$1"; shift || true
          if ./gradlew -q tasks --all | grep -E "^[[:space:]]*$TASK[[:space:]]" >/dev/null; then
            echo "::group::Run $TASK"
            ./gradlew "$TASK" "$@" --configuration-cache --build-cache --stacktrace
            echo "::endgroup::"
          else
            echo "::notice::Gradle task '$TASK' nicht vorhanden â€“ Ã¼bersprungen."
          fi
          SH
          chmod +x run-if-task-exists.sh

      - name: Detekt
        if: ${{ github.event.inputs.detekt == 'true' }}
        run: ./run-if-task-exists.sh detekt

      - name: Ktlint/Spotless
        if: ${{ github.event.inputs.ktlint == 'true' }}
        run: ./run-if-task-exists.sh ktlintCheck || ./run-if-task-exists.sh spotlessCheck

      - name: Android Lint
        if: ${{ github.event.inputs.android_lint == 'true' }}
        run: |
          ./run-if-task-exists.sh lintDebug
          ./run-if-task-exists.sh lintVitalRelease

      - name: Unit-Tests
        if: ${{ github.event.inputs.unit_tests == 'true' }}
        run: ./run-if-task-exists.sh testDebugUnitTest --parallel

      - name: Coverage (Kover XML)
        if: ${{ github.event.inputs.coverage_kover == 'true' }}
        run: ./run-if-task-exists.sh koverXmlReport

      - name: Dependency-Check
        if: ${{ github.event.inputs.dep_check == 'true' }}
        run: ./run-if-task-exists.sh dependencyCheckAnalyze

      - name: API Check (metalava)
        if: ${{ github.event.inputs.api_check == 'true' }}
        run: ./run-if-task-exists.sh checkApi

      - name: Reports hochladen
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports
          path: |
            **/build/reports/**
            **/build/test-results/**
            **/build/kover/**
          if-no-files-found: warn
          retention-days: 7

      - name: Build Summary
        if: always()
        run: |
          {
            echo "## Quality Gate â€“ Zusammenfassung"
            echo ""
            echo "**Run:** https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
            echo ""
            echo "### Reports"
            find . -type f -path "**/build/reports/*" | sed 's/^/- /' || echo "- (keine)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: PR-Kommentar (optional)
        if: ${{ steps.cfg.outputs.pr_comment == 'true' && (github.event_name == 'pull_request' || steps.cfg.outputs.issue_number != '') }}
        uses: actions/github-script@v8
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = ["### ðŸ§ª Quality Gate fertig", `**Run:** ${runUrl}`, "", "Artefakte: **Artifacts** & **Run Summary**."].join("\n");
            const override = process.env.ISSUE_NUMBER_OVERRIDE?.trim();
            const parsed = override ? Number(override) : undefined;
            const issue_number = context.payload.pull_request?.number ?? (Number.isFinite(parsed) ? parsed : undefined);
            if (issue_number) await github.rest.issues.createComment({ ...context.repo, issue_number, body });
        env:
          ISSUE_NUMBER_OVERRIDE: ${{ steps.cfg.outputs.issue_number }}
