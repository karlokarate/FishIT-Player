name: Final TDLib – SDK-free Build (API24, matrix, FreeSpace, sccache, SBOM+SLSA, AAR+Maven)

on:
  workflow_dispatch:
    inputs:
      api_level:
        description: "Android API-Level (min 24)"
        required: true
        default: "24"
      td_ref:
        description: "TDLib Ref (leer = master HEAD)"
        required: false
        default: ""
      soft_fail:
        description: "Soft-Fail: weiterbauen trotz Fehler (1/0)"
        required: true
        default: "1"
      final_exit:
        description: "Exitcode 1 bei Fehlern (1=rot, 0=grün)"
        required: true
        default: "1"
      ndk_version:
        description: "NDK Version"
        required: true
        default: "r27c"

permissions:
  contents: write
  actions: read

jobs:
  # --------------------------------------------------------------------------
  # 1) BoringSSL einmal bauen & als Release publizieren
  # --------------------------------------------------------------------------
  boringssl:
    name: Build+Publish BoringSSL
    runs-on: ubuntu-24.04
    env:
      ANDROID_PLATFORM: android-${{ inputs.api_level }}
      NDK_VERSION: ${{ inputs.ndk_version }}
      BORINGSSL_DIR: .third_party/boringssl
      SCCACHE_GHA_ENABLED: "true"
    outputs:
      bssl_tag: ${{ steps.bsslpkg.outputs.tag }}
      bssl_subjects_b64: ${{ steps.bssl_subjects.outputs.base64_subjects }}
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space (initial)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          docker-images: true
          large-packages: true

      - name: Setup Java (JDK 21)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Base deps (CMake/Ninja, jq, zstd)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl git unzip php gperf rsync jq zstd gpg lsb-release software-properties-common
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://apt.kitware.com/keys/kitware-archive-latest.asc | sudo gpg --dearmor -o /etc/apt/keyrings/kitware-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/kitware.list
          sudo apt-get update -y && sudo apt-get install -y cmake ninja-build

      - name: Enable sccache (GHA backend)
        uses: Mozilla-Actions/sccache-action@v0.0.9

      - name: Restore NDK
        id: cache-ndk
        uses: actions/cache/restore@v4
        with:
          path: .ndk/android-ndk-${{ env.NDK_VERSION }}
          key: ndk-${{ runner.os }}-${{ env.NDK_VERSION }}

      - name: Download NDK (if cache miss)
        if: ${{ steps.cache-ndk.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ndk
          url="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
          curl -fSLo .ndk/ndk.zip "$url"
          unzip -q .ndk/ndk.zip -d .ndk
          rm .ndk/ndk.zip

      - name: Set NDK path
        id: ndk
        shell: bash
        run: echo "dir=$(pwd)/.ndk/android-ndk-${NDK_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build BoringSSL (static)
        shell: bash
        env:
          ANDROID_PLATFORM: ${{ env.ANDROID_PLATFORM }}
        run: |
          set -euo pipefail
          NDK="${{ steps.ndk.outputs.dir }}"
          rm -rf boringssl-src
          git clone --depth=1 https://boringssl.googlesource.com/boringssl boringssl-src
          mkdir -p "${BORINGSSL_DIR}"
          for ABI in arm64-v8a armeabi-v7a; do
            BLD="boringssl-build-$ABI"
            INST="${BORINGSSL_DIR}/$ABI"
            rm -rf "$BLD" "$INST"; mkdir -p "$BLD" "$INST/lib" "$INST/include"
            cmake -G Ninja -S boringssl-src -B "$BLD" \
              -DCMAKE_TOOLCHAIN_FILE="$NDK/build/cmake/android.toolchain.cmake" \
              -DANDROID_ABI="$ABI" \
              -DANDROID_PLATFORM="${ANDROID_PLATFORM}" \
              -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF \
              -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
              -DCMAKE_C_COMPILER_LAUNCHER=sccache \
              -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
            cmake --build "$BLD" --target crypto ssl -- -k 0
            cp -f "$(find "$BLD" -name libcrypto.a | head -n1)" "$INST/lib/libcrypto.a"
            cp -f "$(find "$BLD" -name libssl.a | head -n1)" "$INST/lib/libssl.a"
            rsync -a boringssl-src/include/ "$INST/include/"
            printf '{"abi":"%s","android_platform":"%s","ndk":"%s"}\n' "$ABI" "${ANDROID_PLATFORM}" "$(basename "$NDK")" > "$INST/stamp.json"
          done

      - name: Save BoringSSL installs (cache)
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.BORINGSSL_DIR }}/arm64-v8a
            ${{ env.BORINGSSL_DIR }}/armeabi-v7a
          key: >
            bssl-install-${{ runner.os }}-${{ env.NDK_VERSION }}-${{ inputs.api_level }}-v4

      - name: Package BoringSSL tarballs (per ABI)
        id: bsslpkg
        shell: bash
        run: |
          set -euo pipefail
          COMMIT="$(git -C boringssl-src rev-parse --short=12 HEAD 2>/dev/null || echo unknown)"
          TAG="boringssl-${COMMIT}-android${{ inputs.api_level }}-ndk-${{ env.NDK_VERSION }}"
          mkdir -p publish
          for abi in arm64-v8a armeabi-v7a; do
            src="${BORINGSSL_DIR}/${abi}"
            prefix="boringssl-${COMMIT}-android${{ inputs.api_level }}-ndk-${{ env.NDK_VERSION }}-${abi}"
            mkdir -p "publish/${prefix}"
            rsync -a "${src}/include" "publish/${prefix}/"
            mkdir -p "publish/${prefix}/lib"
            cp -f "${src}/lib/libssl.a" "publish/${prefix}/lib/libssl.a"
            cp -f "${src}/lib/libcrypto.a" "publish/${prefix}/lib/libcrypto.a"
            jq -n --arg commit "$COMMIT" --arg abi "$abi" \
                 --arg ndk "android-ndk-${{ env.NDK_VERSION }}" \
                 --arg api "android-${{ inputs.api_level }}" \
                 '{type:"boringssl",commit:$commit,abi:$abi,ndk:$ndk,api:$api}' > "publish/${prefix}/META.json"
            tar -I zstd -cf "publish/${prefix}.tar.zst" -C publish "${prefix}"
            sha256sum "publish/${prefix}.tar.zst" > "publish/${prefix}.sha256"
            rm -rf "publish/${prefix}"
          done
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Generate SBOM (BoringSSL tarballs)
        uses: anchore/sbom-action@v0.20.9
        with:
          path: ./publish
          format: spdx-json
          output-file: ./publish/boringssl-sbom.spdx.json
          upload-artifact: false
          upload-release-assets: false

      - name: Create/Update Release (BoringSSL)
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ steps.bsslpkg.outputs.tag }}
          name: BoringSSL Android ${{ steps.bsslpkg.outputs.tag }}
          draft: false
          prerelease: false
          files: |
            publish/*.tar.zst
            publish/*.sha256
            publish/boringssl-sbom.spdx.json

      - name: Compute SLSA subjects (BoringSSL)
        id: bssl_subjects
        shell: bash
        run: |
          set -euo pipefail
          jq -n '[]' > subjects.json
          for f in publish/*.tar.zst; do
            d="$(sha256sum "$f" | awk '{print $1}')"
            n="$(basename "$f")"
            jq --arg n "$n" --arg d "$d" '. + [{"name":$n,"digest":{"sha256":$d}}]' subjects.json > tmp && mv tmp subjects.json
          done
          b64="$(base64 -w0 < subjects.json || base64 < subjects.json)"
          echo "base64_subjects=$b64" >> "$GITHUB_OUTPUT"

  # --------------------------------------------------------------------------
  # 2) TDLib pro ABI (Matrix) – nutzt BoringSSL (Cache→Release)
  # --------------------------------------------------------------------------
  tdlib:
    name: Build TDLib (${{ matrix.abi }})
    needs: [boringssl]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        abi: [arm64-v8a, armeabi-v7a]
    env:
      ANDROID_PLATFORM: android-${{ inputs.api_level }}
      NDK_VERSION: ${{ inputs.ndk_version }}
      BORINGSSL_DIR: .third_party/boringssl
      TD_BUILD_SCRIPT: scripts/build-tdlib-android2.sh
      OUT_DIR: out
      SCCACHE_GHA_ENABLED: "true"
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space (pre-TDLib)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          docker-images: true
          large-packages: true

      - name: Setup Java (JDK 21)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Base deps (CMake/Ninja, jq, zstd, maven)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl git unzip php gperf rsync jq zstd gpg lsb-release software-properties-common maven
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://apt.kitware.com/keys/kitware-archive-latest.asc | sudo gpg --dearmor -o /etc/apt/keyrings/kitware-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/kitware.list
          sudo apt-get update -y && sudo apt-get install -y cmake ninja-build

      - name: Enable sccache (GHA backend)
        uses: Mozilla-Actions/sccache-action@v0.0.9

      - name: Restore NDK
        id: cache-ndk
        uses: actions/cache/restore@v4
        with:
          path: .ndk/android-ndk-${{ env.NDK_VERSION }}
          key: ndk-${{ runner.os }}-${{ env.NDK_VERSION }}

      - name: Download NDK (if cache miss)
        if: ${{ steps.cache-ndk.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ndk
          url="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
          curl -fSLo .ndk/ndk.zip "$url"
          unzip -q .ndk/ndk.zip -d .ndk
          rm .ndk/ndk.zip

      - name: Set NDK path
        id: ndk
        shell: bash
        run: echo "dir=$(pwd)/.ndk/android-ndk-${NDK_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Resolve TDLib ref (if empty, use master HEAD)
        id: tdref
        shell: bash
        run: |
          set -euo pipefail
          REF="${{ github.event.inputs.td_ref }}"
          if [[ -z "${REF}" ]]; then
            feed_url="https://github.com/tdlib/td/commits/master.atom"
            html="$(curl -fsSL "$feed_url")"
            REF="$(printf '%s' "$html" | grep -oE 'https://github.com/tdlib/td/commit/[0-9a-f]+' | head -n1 | awk -F/ '{print $NF}')"
            [[ -n "$REF" ]] || REF="master"
          fi
          echo "ref=$REF" >> "$GITHUB_OUTPUT"

      - name: Fetch TDLib sources
        shell: bash
        run: |
          set -euo pipefail
          rm -rf td && mkdir -p td
          git init td
          cd td
          git remote add origin https://github.com/tdlib/td.git
          git fetch --depth=1 origin "${{ steps.tdref.outputs.ref }}"
          git checkout -qf FETCH_HEAD
          git rev-parse HEAD | tee .TDLIB_COMMIT.txt
          git describe --tags --always --long --dirty=+ | tee .TDLIB_DESCRIBE.txt

      # BoringSSL je ABI: Cache → Release-Fallback
      - name: Restore BoringSSL install (${{ matrix.abi }})
        id: restore-bssl
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.BORINGSSL_DIR }}/${{ matrix.abi }}
          key: >
            bssl-install-${{ runner.os }}-${{ env.NDK_VERSION }}-${{ inputs.api_level }}-v4

      - name: Download BoringSSL tarball (fallback)
        if: ${{ steps.restore-bssl.outputs.cache-hit != 'true' }}
        uses: robinraju/release-downloader@v1.12
        with:
          repository: ${{ github.repository }}
          tag: ${{ needs.boringssl.outputs.bssl_tag }}
          fileName: "*-${{ matrix.abi }}.tar.zst"
          out-file-path: ${{ github.workspace }}/_bssl
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract BoringSSL tarball
        if: ${{ steps.restore-bssl.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${BORINGSSL_DIR}/${{ matrix.abi }}"
          tar -I zstd -xvf _bssl/*.tar.zst -C "${BORINGSSL_DIR}/${{ matrix.abi }}" --strip-components=1
          rm -rf _bssl
          df -h

      # FreeSpace-Guard
      - name: Disk headroom check (must have ≥12 GiB)
        id: diskcheck
        shell: bash
        run: |
          set -euo pipefail
          avail="$(df --output=avail -B1 / | tail -1)"
          echo "avail_bytes=$avail" >> "$GITHUB_OUTPUT"
          if [ "$avail" -lt 12884901888 ]; then echo "low=1" >> "$GITHUB_OUTPUT"; else echo "low=0" >> "$GITHUB_OUTPUT"; fi

      - name: Free disk space (second pass, conditional)
        if: ${{ steps.diskcheck.outputs.low == '1' }}
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          docker-images: true
          large-packages: true

      # JDK sanity
      - name: Verify Host JDK for JNI (JAVA_HOME/JVM)
        shell: bash
        run: |
          set -euo pipefail
          echo "JAVA_HOME=${JAVA_HOME:-unset}"
          if [[ -z "${JAVA_HOME:-}" || ! -d "$JAVA_HOME" ]]; then
            echo "JAVA_HOME not set or invalid"; exit 1
          fi
          JVM="$( ( [[ -f "$JAVA_HOME/lib/server/libjvm.so" ]] && echo "$JAVA_HOME/lib/server/libjvm.so" ) || find "$JAVA_HOME" -type f -name libjvm.so | head -n1 || true )"
          [[ -f "$JVM" ]] || { echo "libjvm.so not found under JAVA_HOME=$JAVA_HOME"; exit 1; }
          [[ -f "$JAVA_HOME/include/jni.h" ]] || { echo "jni.h not found under JAVA_HOME/include"; exit 1; }

      - name: Make build script executable
        run: chmod +x "${{ env.TD_BUILD_SCRIPT }}"

      - name: Build TDLib (${{ matrix.abi }}) — API 24
        shell: bash
        env:
          TD_REF: ${{ steps.tdref.outputs.ref }}
          API_LEVEL: ${{ inputs.api_level }}
          SOFT_FAIL: ${{ inputs.soft_fail }}
          FINAL_EXIT: ${{ inputs.final_exit }}
        run: |
          set -uo pipefail
          NDK_DIR="${{ steps.ndk.outputs.dir }}"
          export ANDROID_NDK_ROOT="$NDK_DIR"
          export NDK="$NDK_DIR"
          bash "${TD_BUILD_SCRIPT}" \
            --ref "${TD_REF:-}" \
            --abis "${{ matrix.abi }}" \
            --api-level "${API_LEVEL}" \
            --boringssl-dir "${BORINGSSL_DIR}" \
            --ndk "${NDK_DIR}"

      - name: TDLib tag/label
        id: tdmeta
        shell: bash
        run: |
          set -euo pipefail
          DESC="$(cat out/TDLIB_VERSION.txt)"
          TAG="tdlib-${DESC}-android${{ inputs.api_level }}-ndk-${{ inputs.ndk_version }}"
          mkdir -p _meta
          echo "$TAG" > _meta/tag.txt
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Generate SBOM (so for ${{ matrix.abi }})
        uses: anchore/sbom-action@v0.20.9
        with:
          path: ./out/libs/${{ matrix.abi }}/libtdjni.so
          format: spdx-json
          output-file: ./out/tdlib-sbom-${{ matrix.abi }}.spdx.json
          upload-artifact: false
          upload-release-assets: false

      - name: Prepare per-ABI asset filenames
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          cp out/libs/${{ matrix.abi }}/libtdjni.so dist/libtdjni-${{ matrix.abi }}.so

      - name: Ensure Release exists (once)
        if: ${{ matrix.abi == 'arm64-v8a' }}
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ steps.tdmeta.outputs.tag }}
          name: TDLib Android ${{ steps.tdmeta.outputs.tag }}
          draft: false
          prerelease: false
          files: ""

      - name: Upload TDLib assets (per ABI)
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ steps.tdmeta.outputs.tag }}
          files: |
            dist/libtdjni-${{ matrix.abi }}.so
            out/tdlib-sbom-${{ matrix.abi }}.spdx.json

      - name: Upload common TDLib assets (only once)
        if: ${{ matrix.abi == 'arm64-v8a' }}
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ steps.tdmeta.outputs.tag }}
          files: |
            out/*.jar
            out/TDLIB_VERSION.txt
            out/logs/summary.json

      - name: Publish TDLib tag (artifact, for AAR job)
        if: ${{ matrix.abi == 'arm64-v8a' }}
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-tag
          path: _meta/tag.txt
          retention-days: 7

      - name: Compute SLSA subjects (this ABI)
        id: td_subjects
        shell: bash
        run: |
          set -euo pipefail
          jq -n '[]' > subjects.json
          f="dist/libtdjni-${{ matrix.abi }}.so"
          d="$(sha256sum "$f" | awk '{print $1}')"
          n="$(basename "$f")"
          jq --arg n "$n" --arg d "$d" '. + [{"name":$n,"digest":{"sha256":$d}}]' subjects.json > tmp && mv tmp subjects.json
          if [ "${{ matrix.abi }}" = "arm64-v8a" ]; then
            for j in out/*.jar; do
              dj="$(sha256sum "$j" | awk '{print $1}')"
              nj="$(basename "$j")"
              jq --arg n "$nj" --arg d "$dj" '. + [{"name":$n,"digest":{"sha256":$d}}]' subjects.json > tmp && mv tmp subjects.json
            done
          fi
          mkdir -p _subjects && cp subjects.json "_subjects/subjects-${{ matrix.abi }}.json"

      - name: Upload subjects.json (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: td-subjects-${{ matrix.abi }}
          path: _subjects/subjects-${{ matrix.abi }}.json
          retention-days: 7

  # --------------------------------------------------------------------------
  # 3) AAR bauen (Multi-ABI), an TDLib-Release hängen, Maven publish,
  #    und SLSA-Subjects (inkl. AAR) mergen
  # --------------------------------------------------------------------------
  gather-tdlib-subjects:
    name: Build AAR & gather TDLib subjects + Maven publish
    needs: [tdlib]
    runs-on: ubuntu-24.04
    outputs:
      base64_subjects: ${{ steps.merge.outputs.base64_subjects }}
    steps:
      - name: Setup Java (JDK 21)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Install Maven
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y maven jq

      - name: Download all ABI subjects
        uses: actions/download-artifact@v4
        with:
          pattern: td-subjects-*
          merge-multiple: true
          path: _subjects

      - name: Download TDLib tag artifact
        uses: actions/download-artifact@v4
        with:
          name: tdlib-tag
          path: _meta

      - name: Read TDLib tag
        id: tagread
        shell: bash
        run: |
          set -euo pipefail
          TAG="$(cat _meta/tag.txt)"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Download TDLib assets from Release (for AAR)
        uses: robinraju/release-downloader@v1.12
        with:
          repository: ${{ github.repository }}
          tag: ${{ steps.tagread.outputs.tag }}
          fileName: |
            libtdjni-arm64-v8a.so
            libtdjni-armeabi-v7a.so
            *.jar
            TDLIB_VERSION.txt
          out-file-path: _dl
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build AAR (multi-ABI)
        id: buildaar
        shell: bash
        run: |
          set -euo pipefail
          DESC="$(tr -d '\n\r' < _dl/TDLIB_VERSION.txt)"
          AAR="fishit-tdlib-android-${DESC}-android${{ inputs.api_level }}.aar"
          mkdir -p aar/jni/arm64-v8a aar/jni/armeabi-v7a
          cat > aar/AndroidManifest.xml <<'XML'
          <manifest package="org.drinkless.tdlib.aar"/>
          XML
          JAR="$(ls -1 _dl/*.jar | head -n1)"
          cp "$JAR" aar/classes.jar
          cp _dl/libtdjni-arm64-v8a.so aar/jni/arm64-v8a/libtdjni.so
          [ -f _dl/libtdjni-armeabi-v7a.so ] && cp _dl/libtdjni-armeabi-v7a.so aar/jni/armeabi-v7a/libtdjni.so || true
          (cd aar && zip -qr "../$AAR" .)
          echo "aar=$AAR" >> "$GITHUB_OUTPUT"

      - name: Generate SBOM (AAR)
        uses: anchore/sbom-action@v0.20.9
        with:
          path: ./${{ steps.buildaar.outputs.aar }}
          format: spdx-json
          output-file: ./tdlib-android.aar.spdx.json
          upload-artifact: false
          upload-release-assets: false

      - name: Upload AAR to TDLib Release
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ steps.tagread.outputs.tag }}
          files: |
            ${{ steps.buildaar.outputs.aar }}
            tdlib-android.aar.spdx.json

      # Maven Publish (GitHub Packages) mit eigenem POM
      - name: Prepare Maven settings.xml
        shell: bash
        env:
          GH_ACTOR: ${{ github.actor }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<XML
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${GH_ACTOR}</username>
                <password>${GH_TOKEN}</password>
              </server>
            </servers>
          </settings>
          XML
          echo "::add-mask::${GH_TOKEN}"

      - name: Publish AAR to GitHub Packages (Maven, with POM)
        shell: bash
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          TAG="${{ steps.tagread.outputs.tag }}"
          VER="${TAG#tdlib-}"
          AAR="${{ steps.buildaar.outputs.aar }}"
          GROUP_ID="com.github.${OWNER}"
          ARTIFACT_ID="fishit-tdlib-android"

          cat > pom.xml <<POM
          <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>${GROUP_ID}</groupId>
            <artifactId>${ARTIFACT_ID}</artifactId>
            <version>${VER}</version>
            <packaging>aar</packaging>
            <name>FishIT TDLib Android</name>
            <description>Prebuilt TDLib JNI + Java bindings for Android (API 24+, ABIs arm64-v8a/armeabi-v7a).</description>
            <url>https://github.com/${REPO}</url>
            <licenses>
              <license>
                <name>MIT License</name>
                <url>https://opensource.org/licenses/MIT</url>
                <distribution>repo</distribution>
              </license>
            </licenses>
            <scm>
              <url>https://github.com/${REPO}</url>
              <connection>scm:git:https://github.com/${REPO}.git</connection>
              <developerConnection>scm:git:ssh://git@github.com/${REPO}.git</developerConnection>
              <tag>${TAG}</tag>
            </scm>
            <developers>
              <developer>
                <id>${OWNER}</id>
                <name>${OWNER}</name>
                <url>https://github.com/${OWNER}</url>
              </developer>
            </developers>
          </project>
          POM

          mvn -B deploy:deploy-file \
            -Dfile="${AAR}" \
            -DrepositoryId=github \
            -Durl="https://maven.pkg.github.com/${REPO}" \
            -DpomFile=pom.xml \
            -Dpackaging=aar

      - name: Merge subjects (+ AAR)
        id: merge
        shell: bash
        run: |
          set -euo pipefail
          jq -s 'add' _subjects/subjects-*.json > all-subjects.json
          AAR="${{ steps.buildaar.outputs.aar }}"
          DAAR="$(sha256sum "$AAR" | awk '{print $1}')"
          jq --arg n "$(basename "$AAR")" --arg d "$DAAR" '. + [{"name":$n,"digest":{"sha256":$d}}]' all-subjects.json > tmp && mv tmp all-subjects.json
          b64="$(base64 -w0 < all-subjects.json || base64 < all-subjects.json)"
          echo "base64_subjects=$b64" >> "$GITHUB_OUTPUT"

  # --------------------------------------------------------------------------
  # 4) SLSA – Generator erzeugt nur Attestation; Upload an Releases in Attach-Jobs
  # --------------------------------------------------------------------------
  provenance-boringssl:
    name: SLSA provenance (BoringSSL)
    needs: [boringssl]
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.boringssl.outputs.bssl_subjects_b64 }}"
      upload-assets: false

  provenance-tdlib:
    name: SLSA provenance (TDLib incl. AAR)
    needs: [gather-tdlib-subjects]
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.gather-tdlib-subjects.outputs.base64_subjects }}"
      upload-assets: false

  attach-boringssl-provenance:
    name: Attach SLSA attestation to BoringSSL release
    needs: [boringssl, provenance-boringssl]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Download provenance artifacts
        uses: actions/download-artifact@v4
        with:
          path: _prov
          merge-multiple: true

      - name: Keep only BoringSSL attestation
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _prov_bssl
          shopt -s nullglob
          for f in _prov/**.intoto.jsonl; do
            if grep -q 'boringssl-' "$f"; then cp "$f" _prov_bssl/; fi
          done
          ls -l _prov_bssl || true

      - name: Upload attestation to BoringSSL release
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ needs.boringssl.outputs.bssl_tag }}
          files: _prov_bssl/*.intoto.jsonl

  attach-tdlib-provenance:
    name: Attach SLSA attestation to TDLib release
    needs: [gather-tdlib-subjects, provenance-tdlib]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Download provenance artifacts
        uses: actions/download-artifact@v4
        with:
          path: _prov
          merge-multiple: true

      - name: Download TDLib tag artifact
        uses: actions/download-artifact@v4
        with:
          name: tdlib-tag
          path: _meta

      - name: Read tag
        id: tag
        shell: bash
        run: echo "tag=$(cat _meta/tag.txt)" >> "$GITHUB_OUTPUT"

      - name: Keep only TDLib attestation
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _prov_td
          shopt -s nullglob
          for f in _prov/**.intoto.jsonl; do
            if grep -Eq 'libtdjni|\.aar' "$f"; then cp "$f" _prov_td/; fi
          done
          ls -l _prov_td || true

      - name: Upload attestation to TDLib release
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: _prov_td/*.intoto.jsonl