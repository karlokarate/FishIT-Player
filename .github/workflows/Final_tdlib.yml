name: Final TDLib – SDK-free Build (API24, matrix, FreeSpace, sccache, SBOM+SLSA, AAR+Maven)

on:
  workflow_dispatch:
    inputs:
      api_level:
        description: "Android API-Level (min 24)"
        required: true
        default: "24"
      td_ref:
        description: "TDLib Ref (leer = master HEAD)"
        required: false
        default: ""
      soft_fail:
        description: "Soft-Fail: weiterbauen trotz Fehler (1/0)"
        required: true
        default: "1"
      final_exit:
        description: "Exitcode 1 bei Fehlern (1=rot, 0=grün)"
        required: true
        default: "1"
      ndk_version:
        description: "NDK Version"
        required: true
        default: "r27c"

permissions:
  contents: write
  actions: read

jobs:
  boringssl:
    name: Build+Publish BoringSSL
    runs-on: ubuntu-24.04
    env:
      ANDROID_PLATFORM: android-${{ inputs.api_level }}
      NDK_VERSION: ${{ inputs.ndk_version }}
      BORINGSSL_DIR: .third_party/boringssl
      SCCACHE_GHA_ENABLED: "true"
    outputs:
      bssl_tag: ${{ steps.bsslpkg.outputs.tag }}
      bssl_subjects_b64: ${{ steps.bssl_subjects.outputs.base64_subjects }}
    steps:
      - uses: actions/checkout@v4
      - name: Free disk space (initial)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          docker-images: true
          large-packages: true
      - name: Setup Java (JDK 21)
        uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: "21" }
      - name: Base deps (CMake/Ninja, jq, zstd)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl git unzip php gperf rsync jq zstd gpg lsb-release software-properties-common
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://apt.kitware.com/keys/kitware-archive-latest.asc | sudo gpg --dearmor -o /etc/apt/keyrings/kitware-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/kitware.list
          sudo apt-get update -y && sudo apt-get install -y cmake ninja-build
      - name: Enable sccache (GHA backend)
        uses: Mozilla-Actions/sccache-action@v0.0.9
      - name: Restore NDK
        id: cache-ndk
        uses: actions/cache/restore@v4
        with:
          path: .ndk/android-ndk-${{ env.NDK_VERSION }}
          key: ndk-${{ runner.os }}-${{ env.NDK_VERSION }}
      - name: Download NDK (if cache miss)
        if: ${{ steps.cache-ndk.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ndk
          url="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
          curl -fSLo .ndk/ndk.zip "$url"
          unzip -q .ndk/ndk.zip -d .ndk
          rm .ndk/ndk.zip
      - name: Set NDK path
        id: ndk
        shell: bash
        run: echo "dir=$(pwd)/.ndk/android-ndk-${NDK_VERSION}" >> "$GITHUB_OUTPUT"
      - name: Build BoringSSL (static)
        shell: bash
        env:
          ANDROID_PLATFORM: ${{ env.ANDROID_PLATFORM }}
        run: |
          set -euo pipefail
          NDK="${{ steps.ndk.outputs.dir }}"
          rm -rf boringssl-src
          git clone --depth=1 https://boringssl.googlesource.com/boringssl boringssl-src
          mkdir -p "${BORINGSSL_DIR}"
          for ABI in arm64-v8a armeabi-v7a; do
            BLD="boringssl-build-$ABI"
            INST="${BORINGSSL_DIR}/$ABI"
            rm -rf "$BLD" "$INST"; mkdir -p "$BLD" "$INST/lib" "$INST/include"
            cmake -G Ninja -S boringssl-src -B "$BLD" \
              -DCMAKE_TOOLCHAIN_FILE="$NDK/build/cmake/android.toolchain.cmake" \
              -DANDROID_ABI="$ABI" \
              -DANDROID_PLATFORM="${ANDROID_PLATFORM}" \
              -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF \
              -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
              -DCMAKE_C_COMPILER_LAUNCHER=sccache \
              -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
            cmake --build "$BLD" --target crypto ssl -- -k 0
            cp -f "$(find "$BLD" -name libcrypto.a | head -n1)" "$INST/lib/libcrypto.a"
            cp -f "$(find "$BLD" -name libssl.a | head -n1)" "$INST/lib/libssl.a"
            rsync -a boringssl-src/include/ "$INST/include/"
            printf '{"abi":"%s","android_platform":"%s","ndk":"%s"}\n' "$ABI" "${ANDROID_PLATFORM}" "$(basename "$NDK")" > "$INST/stamp.json"
          done
      - name: Save BoringSSL installs (cache)
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.BORINGSSL_DIR }}/arm64-v8a
            ${{ env.BORINGSSL_DIR }}/armeabi-v7a
          key: >
            bssl-install-${{ runner.os }}-${{ env.NDK_VERSION }}-${{ inputs.api_level }}-v4
      - name: Package BoringSSL tarballs (per ABI)
        id: bsslpkg
        shell: bash
        run: |
          set -euo pipefail
          COMMIT="$(git -C boringssl-src rev-parse --short=12 HEAD 2>/dev/null || echo unknown)"
          TAG="boringssl-${COMMIT}-android${{ inputs.api_level }}-ndk-${{ env.NDK_VERSION }}"
          mkdir -p publish
          for abi in arm64-v8a armeabi-v7a; do
            src="${BORINGSSL_DIR}/${abi}"
            prefix="boringssl-${COMMIT}-android${{ inputs.api_level }}-ndk-${{ env.NDK_VERSION }}-${abi}"
            mkdir -p "publish/${prefix}"
            rsync -a "${src}/include" "publish/${prefix}/"
            mkdir -p "publish/${prefix}/lib"
            cp -f "${src}/lib/libssl.a" "publish/${prefix}/lib/libssl.a"
            cp -f "${src}/lib/libcrypto.a" "publish/${prefix}/lib/libcrypto.a"
            jq -n --arg commit "$COMMIT" --arg abi "$abi" \
                 --arg ndk "android-ndk-${{ env.NDK_VERSION }}" \
                 --arg api "android-${{ inputs.api_level }}" \
                 '{type:"boringssl",commit:$commit,abi:$abi,ndk:$ndk,api:$api}' > "publish/${prefix}/META.json"
            tar -I zstd -cf "publish/${prefix}.tar.zst" -C publish "${prefix}"
            sha256sum "publish/${prefix}.tar.zst" > "publish/${prefix}.sha256"
            rm -rf "publish/${prefix}"
          done
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
      - name: Generate SBOM (BoringSSL tarballs)
        uses: anchore/sbom-action@v0.20.9
        with:
          path: ./publish
          format: spdx-json
          output-file: ./publish/boringssl-sbom.spdx.json
          upload-artifact: false
          upload-release-assets: false
      - name: Create/Update Release (BoringSSL)
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ steps.bsslpkg.outputs.tag }}
          name: BoringSSL Android ${{ steps.bsslpkg.outputs.tag }}
          draft: false
          prerelease: false
          files: |
            publish/*.tar.zst
            publish/*.sha256
            publish/boringssl-sbom.spdx.json
      - name: Compute SLSA subjects (BoringSSL)
        id: bssl_subjects
        shell: bash
        run: |
          set -euo pipefail
          jq -n '[]' > subjects.json
          for f in publish/*.tar.zst; do
            d="$(sha256sum "$f" | awk '{print $1}')"
            n="$(basename "$f")"
            jq --arg n "$n" --arg d "$d" '. + [{"name":$n,"digest":{"sha256":$d}}]' subjects.json > tmp && mv tmp subjects.json
          done
          b64="$(base64 -w0 < subjects.json || base64 < subjects.json)"
          echo "base64_subjects=$b64" >> "$GITHUB_OUTPUT"

  tdlib:
    name: Build TDLib (${{ matrix.abi }})
    needs: [boringssl]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix: { abi: [arm64-v8a, armeabi-v7a] }
    env:
      ANDROID_PLATFORM: android-${{ inputs.api_level }}
      NDK_VERSION: ${{ inputs.ndk_version }}
      BORINGSSL_DIR: .third_party/boringssl
      TD_BUILD_SCRIPT: scripts/build-tdlib-android2.sh
      OUT_DIR: out
      SCCACHE_GHA_ENABLED: "true"
    steps:
      # … (unverändert aus deinem letzten Stand; ich kürze hier nicht weiter)
      # ——— Der gesamte TDLib-Job bleibt identisch ———
      # (siehe vorherige Nachricht – ich habe nichts an diesem Job geändert)

      # (Hier steht all dein TDLib-Job wie in deiner Vorlage – gekürzt, um Platz zu sparen)

  gather-tdlib-subjects:
    # … (unverändert; AAR bauen, SBOM, Maven publish, subjects mergen)

  # --------------------------------------------------------------------------
  # 4) SLSA – Generator ohne Auto-Upload; Attach-Jobs hängen intoto.jsonl an Releases
  # --------------------------------------------------------------------------
  provenance-boringssl:
    name: SLSA provenance (BoringSSL)
    needs: [boringssl]
    permissions: { actions: read, id-token: write, contents: write }
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.boringssl.outputs.bssl_subjects_b64 }}"
      upload-assets: false

  provenance-tdlib:
    name: SLSA provenance (TDLib incl. AAR)
    needs: [gather-tdlib-subjects]
    permissions: { actions: read, id-token: write, contents: write }
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.gather-tdlib-subjects.outputs.base64_subjects }}"
      upload-assets: false

  attach-boringssl-provenance:
    name: Attach SLSA attestation to BoringSSL release
    needs: [boringssl, provenance-boringssl]
    runs-on: ubuntu-24.04
    permissions: { contents: write }
    steps:
      - name: Download provenance artifacts
        uses: actions/download-artifact@v4
        with:
          path: _prov
          merge-multiple: true
      - name: Upload attestation to BoringSSL release
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ needs.boringssl.outputs.bssl_tag }}
          files: _prov/**.intoto.jsonl

  attach-tdlib-provenance:
    name: Attach SLSA attestation to TDLib release
    needs: [gather-tdlib-subjects, provenance-tdlib]
    runs-on: ubuntu-24.04
    permissions: { contents: write }
    steps:
      - name: Download provenance artifacts
        uses: actions/download-artifact@v4
        with:
          path: _prov
          merge-multiple: true
      - name: Download TDLib tag artifact
        uses: actions/download-artifact@v4
        with:
          name: tdlib-tag
          path: _meta
      - name: Read tag
        id: tag
        shell: bash
        run: echo "tag=$(cat _meta/tag.txt)" >> "$GITHUB_OUTPUT"
      - name: Upload attestation to TDLib release
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: _prov/**.intoto.jsonl