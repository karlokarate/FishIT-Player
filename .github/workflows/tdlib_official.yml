name: TDLib Android AAR (official, master, OpenSSL, matrix)

on:
  workflow_dispatch:
    inputs:
      android_api:
        description: "Android API-Level (für NDK/zlib)"
        required: true
        default: "21"
      ndk_version:
        description: "NDK Version"
        required: true
        default: "r29"
      openssl_ver:
        description: "OpenSSL Version (z.B. openssl-3.3.5 oder LTS: openssl-3.0.18)"
        required: true
        default: "openssl-3.3.5"
      release_tag:
        description: "Release-Tag"
        required: true
        default: "tdlib-android-${{ github.run_id }}"
      publish_to_gpr:
        description: "Zusätzlich nach GitHub Packages (Maven) veröffentlichen?"
        required: true
        default: "false"

permissions:
  contents: write
  packages: write

defaults:
  run:
    shell: bash

jobs:
  prepare:
    runs-on: ubuntu-24.04
    env:
      ANDROID_API: ${{ github.event.inputs.android_api }}
      NDK_VERSION: ${{ github.event.inputs.ndk_version }}
      OPENSSL_VER: ${{ github.event.inputs.openssl_ver }}
      TD_SRC: ${{ github.workspace }}/td
      OPENSSL_SRC: ${{ github.workspace }}/openssl-src
      OPENSSL_OUT: ${{ github.workspace }}/openssl-out
      OUTDIR: ${{ github.workspace }}/dist
    outputs:
      td_commit: ${{ steps.commit.outputs.td_commit }}
      android_api: ${{ env.ANDROID_API }}
    steps:
      - name: Checkout host repo
        uses: actions/checkout@v5

      - name: Host-Build-Tools (gperf)
        run: |
          sudo apt-get update
          sudo apt-get install -y gperf

      - name: Setup Java (JDK 21)
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup CMake 4.1.2 & Ninja 1.13.1
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: '4.1.2'
          ninjaVersion: '1.13.1'

      - name: Setup Android NDK (r29)
        id: ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: Export NDK to PATH & print tool versions
        run: |
          echo "ANDROID_NDK_ROOT=${{ steps.ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "${{ steps.ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
          cmake --version && ninja --version && javac -version

      - name: Clone TDLib (master)
        run: git clone --depth 1 https://github.com/tdlib/td.git "$TD_SRC"

      - name: Capture TD commit
        id: commit
        working-directory: ${{ env.TD_SRC }}
        run: echo "td_commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      # -------- OpenSSL (statisch) für beide ABIs mit Cache --------
      - name: Download OpenSSL source
        run: |
          mkdir -p "$OPENSSL_SRC"
          curl -fsSL "https://www.openssl.org/source/${OPENSSL_VER}.tar.gz" -o "$OPENSSL_VER.tar.gz"
          tar -xzf "$OPENSSL_VER.tar.gz" -C "$OPENSSL_SRC" --strip-components=1

      - name: Cache OpenSSL arm64-v8a
        id: cache-ssl-arm64
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENSSL_OUT }}/arm64-v8a
          key: ${{ runner.os }}-openssl-${{ env.OPENSSL_VER }}-arm64-v8a-${{ env.NDK_VERSION }}

      - name: Build OpenSSL (arm64-v8a)
        if: steps.cache-ssl-arm64.outputs.cache-hit != 'true'
        run: |
          set -e
          cd "$OPENSSL_SRC"
          make distclean || true
          ./Configure android-arm64 no-shared no-tests \
            --prefix="$OPENSSL_OUT/arm64-v8a" \
            --openssldir="$OPENSSL_OUT/arm64-v8a/ssl"
          make -j"$(nproc)"
          make install_sw

      - name: Cache OpenSSL armeabi-v7a
        id: cache-ssl-v7a
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENSSL_OUT }}/armeabi-v7a
          key: ${{ runner.os }}-openssl-${{ env.OPENSSL_VER }}-armeabi-v7a-${{ env.NDK_VERSION }}

      - name: Build OpenSSL (armeabi-v7a)
        if: steps.cache-ssl-v7a.outputs.cache-hit != 'true'
        run: |
          set -e
          cd "$OPENSSL_SRC"
          make distclean || true
          ./Configure android-arm no-shared no-tests \
            --prefix="$OPENSSL_OUT/armeabi-v7a" \
            --openssldir="$OPENSSL_OUT/armeabi-v7a/ssl"
          make -j"$(nproc)"
          make install_sw

      # -------- Host-Build für offiziellen Java-Generator --------
      - name: Configure TDLib (host generator)
        run: cmake -S "$TD_SRC" -B "$TD_SRC/build-host" -DCMAKE_BUILD_TYPE=Release

      - name: Build td_generate_java_api (Host)
        run: cmake --build "$TD_SRC/build-host" --target td_generate_java_api -- -j"$(nproc)"

      - name: Upload Java sources + schema
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-host-java
          path: |
            ${{ env.TD_SRC }}/example/java/src/main/java/org/drinkless/tdlib/TdApi.java
            ${{ env.TD_SRC }}/example/java/src/main/java/org/drinkless/tdlib/Client.java
            ${{ env.TD_SRC }}/example/java/src/main/java/org/drinkless/tdlib/Log.java
            ${{ env.TD_SRC }}/td/telegram/td_api.tl

  build-abi:
    runs-on: ubuntu-24.04
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        abi: [arm64-v8a, armeabi-v7a]
    env:
      ANDROID_API: ${{ needs.prepare.outputs.android_api }}
      TD_SRC: ${{ github.workspace }}/td
      OPENSSL_OUT: ${{ github.workspace }}/openssl-out
      NDK_VERSION: ${{ github.event.inputs.ndk_version }}
      OPENSSL_VER: ${{ github.event.inputs.openssl_ver }}
    steps:
      - name: Checkout host repo
        uses: actions/checkout@v5

      - name: Setup Java (JDK 21)
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup CMake 4.1.2 & Ninja 1.13.1
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: '4.1.2'
          ninjaVersion: '1.13.1'

      - name: Setup Android NDK (r29)
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.NDK_VERSION }}
        id: ndk

      - name: Export NDK
        run: |
          echo "ANDROID_NDK_ROOT=${{ steps.ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "${{ steps.ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Restore TD sources
        run: git clone --depth 1 https://github.com/tdlib/td.git "$TD_SRC"

      - name: Restore OpenSSL cache (${{ matrix.abi }})
        id: restore-ssl
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENSSL_OUT }}/${{ matrix.abi }}
          key: ${{ runner.os }}-openssl-${{ env.OPENSSL_VER }}-${{ matrix.abi }}-${{ env.NDK_VERSION }}

      - name: Configure TDLib (${{ matrix.abi }}, JNI)
        run: |
          set -e
          if [ "${{ matrix.abi }}" = "arm64-v8a" ]; then
            TRIPLE="aarch64-linux-android"
            SSL_PREFIX="$OPENSSL_OUT/arm64-v8a"
          else
            TRIPLE="arm-linux-androideabi"
            SSL_PREFIX="$OPENSSL_OUT/armeabi-v7a"
          fi
          ZINC="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include"
          ZLIB="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/${TRIPLE}/${ANDROID_API}/libz.a"

          cmake -S "$TD_SRC" -B "$TD_SRC/build-${{ matrix.abi }}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DTD_ENABLE_JNI=ON \
            -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-${ANDROID_API} \
            -DOPENSSL_ROOT_DIR="$SSL_PREFIX" \
            -DOPENSSL_USE_STATIC_LIBS=ON \
            -DOPENSSL_INCLUDE_DIR="$SSL_PREFIX/include" \
            -DOPENSSL_CRYPTO_LIBRARY="$SSL_PREFIX/lib/libcrypto.a" \
            -DOPENSSL_SSL_LIBRARY="$SSL_PREFIX/lib/libssl.a" \
            -DZLIB_ROOT="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr" \
            -DZLIB_INCLUDE_DIR="$ZINC" \
            -DZLIB_LIBRARY="$ZLIB"

      - name: Build TDLib (${{ matrix.abi }}, JNI)
        run: cmake --build "$TD_SRC/build-${{ matrix.abi }}" -- -j"$(nproc)"

      - name: Upload libtdjni.so (${{ matrix.abi }})
        uses: actions/upload-artifact@v4
        with:
          name: libtdjni-${{ matrix.abi }}
          path: ${{ env.TD_SRC }}/build-${{ matrix.abi }}/**/libtdjni.so

  package:
    runs-on: ubuntu-24.04
    needs: [prepare, build-abi]
    env:
      OUTDIR: ${{ github.workspace }}/dist
      RELEASE_TAG: ${{ github.event.inputs.release_tag }}
      ANDROID_API: ${{ github.event.inputs.android_api }}
      TD_COMMIT: ${{ needs.prepare.outputs.td_commit }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare AAR workspace
        run: |
          set -e
          mkdir -p "$OUTDIR/work/src/main/jniLibs/arm64-v8a" \
                   "$OUTDIR/work/src/main/jniLibs/armeabi-v7a" \
                   "$OUTDIR/work/src/main/java/org/drinkless/tdlib" \
                   "$OUTDIR/release"
          # JNI
          find artifacts/libtdjni-arm64-v8a -name libtdjni.so -exec cp {} "$OUTDIR/work/src/main/jniLibs/arm64-v8a/" \;
          find artifacts/libtdjni-armeabi-v7a -name libtdjni.so -exec cp {} "$OUTDIR/work/src/main/jniLibs/armeabi-v7a/" \;
          # Java (offizieller Generator-Output + example/java)
          cp artifacts/tdlib-host-java/TdApi.java "$OUTDIR/work/src/main/java/org/drinkless/tdlib/"
          cp artifacts/tdlib-host-java/Client.java "$OUTDIR/work/src/main/java/org/drinkless/tdlib/"
          cp artifacts/tdlib-host-java/Log.java    "$OUTDIR/work/src/main/java/org/drinkless/tdlib/"
          cp artifacts/tdlib-host-java/td_api.tl   "$OUTDIR/release/td_api.tl"
          # Manifest minimal
          cat > "$OUTDIR/work/AndroidManifest.xml" <<'XML'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="org.drinkless.tdlib">
            <uses-sdk android:minSdkVersion="21" />
          </manifest>
          XML

      - name: Compile Java → classes.jar (Bytecode 8)
        run: |
          set -e
          mkdir -p "$OUTDIR/work/classes"
          find "$OUTDIR/work/src/main/java" -name "*.java" > "$OUTDIR/sources.list"
          javac -source 8 -target 8 -d "$OUTDIR/work/classes" @"$OUTDIR/sources.list"
          (cd "$OUTDIR/work/classes" && jar cf "$OUTDIR/work/classes.jar" .)

      - name: Assemble AAR
        run: |
          set -e
          cd "$OUTDIR/work"
          mkdir -p jni/arm64-v8a jni/armeabi-v7a
          cp src/main/jniLibs/arm64-v8a/libtdjni.so jni/arm64-v8a/
          cp src/main/jniLibs/armeabi-v7a/libtdjni.so jni/armeabi-v7a/
          zip -r "$OUTDIR/release/tdlib-android.aar" AndroidManifest.xml classes.jar jni

      - name: Write BUILD_INFO
        run: |
          {
            echo "TD_COMMIT=${TD_COMMIT}"
            echo "ANDROID_API=${ANDROID_API}"
            echo "OPENSSL=${{ github.event.inputs.openssl_ver }}"
            echo "NDK=${{ github.event.inputs.ndk_version }}"
            echo "CMAKE=4.1.2"
            echo "NINJA=1.13.1"
            echo "JDK=21"
          } | tee "$OUTDIR/release/BUILD_INFO.txt"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-android-aar
          path: dist/release/*
          if-no-files-found: error
          retention-days: 14

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          draft: false
          prerelease: false
          files: |
            dist/release/tdlib-android.aar
            dist/release/td_api.tl
            dist/release/BUILD_INFO.txt

      - name: Publish to GitHub Packages (Maven)
        if: ${{ github.event.inputs.publish_to_gpr == 'true' }}
        env:
          USERNAME: ${{ github.actor }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          GROUP_ID="org.drinkless"
          ARTIFACT_ID="tdlib-android"
          VERSION="${RELEASE_TAG}"
          PKGDIR="$OUTDIR/maven/${GROUP_ID//./\/}/${ARTIFACT_ID}/${VERSION}"
          mkdir -p "$PKGDIR"
          cp "$OUTDIR/release/tdlib-android.aar" "$PKGDIR/${ARTIFACT_ID}-${VERSION}.aar"
          cat > "$PKGDIR/${ARTIFACT_ID}-${VERSION}.pom" <<POM
          <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>${GROUP_ID}</groupId>
            <artifactId>${ARTIFACT_ID}</artifactId>
            <version>${VERSION}</version>
            <packaging>aar</packaging>
            <name>TDLib Android (AAR)</name>
            <description>Official TDLib JNI + Java bindings packaged for Android</description>
          </project>
          POM
          curl -u "${USERNAME}:${TOKEN}" -H "Content-Type: application/octet-stream" --data-binary @"$PKGDIR/${ARTIFACT_ID}-${VERSION}.aar" \
            "https://maven.pkg.github.com/${{ github.repository }}/$(echo ${GROUP_ID} | tr '.' '/')/${ARTIFACT_ID}/${VERSION}/${ARTIFACT_ID}-${VERSION}.aar"
          curl -u "${USERNAME}:${TOKEN}" -H "Content-Type: application/octet-stream" --data-binary @"$PKGDIR/${ARTIFACT_ID}-${VERSION}.pom" \
            "https://maven.pkg.github.com/${{ github.repository }}/$(echo ${GROUP_ID} | tr '.' '/')/${ARTIFACT_ID}/${VERSION}/${ARTIFACT_ID}-${VERSION}.pom"