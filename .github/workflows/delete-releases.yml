name: Delete All Releases

on:
  workflow_dispatch:
    inputs:
      confirm_deletion:
        description: 'Type "DELETE ALL RELEASES" to confirm'
        required: true
        type: string

jobs:
  delete-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Verify confirmation
        run: |
          if [ "${{ inputs.confirm_deletion }}" != "DELETE ALL RELEASES" ]; then
            echo "âŒ Confirmation phrase incorrect. Expected: DELETE ALL RELEASES"
            exit 1
          fi
          echo "âœ… Confirmation verified"
      
      - name: Delete all releases using Python script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          cat > /tmp/delete_releases.py << 'EOFPYTHON'
          #!/usr/bin/env python3
          """Delete all GitHub releases using direct API calls."""
          
          import os
          import sys
          import json
          from urllib.request import Request, urlopen
          from urllib.error import HTTPError, URLError
          
          def delete_all_releases():
              repo = os.environ.get('GITHUB_REPOSITORY')
              token = os.environ.get('GITHUB_TOKEN')
              
              if not token or not repo:
                  print("âŒ Error: Required environment variables not set")
                  sys.exit(1)
              
              headers = {
                  'Authorization': f'Bearer {token}',
                  'Accept': 'application/vnd.github.v3+json',
                  'User-Agent': 'FishIT-Player-Release-Deleter'
              }
              
              print(f"ðŸ“‹ Fetching all releases from {repo}...")
              url = f"https://api.github.com/repos/{repo}/releases"
              
              try:
                  req = Request(url, headers=headers)
                  with urlopen(req) as response:
                      releases = json.loads(response.read().decode('utf-8'))
              except HTTPError as e:
                  print(f"âŒ Failed to fetch releases: {e.code}")
                  sys.exit(1)
              except URLError as e:
                  print(f"âŒ Network error: {e.reason}")
                  sys.exit(1)
              
              if not releases:
                  print("âœ… No releases found in the repository")
                  return
              
              print(f"Found {len(releases)} release(s) to delete\n")
              print("Releases to be deleted:")
              for release in releases:
                  print(f"  - {release['tag_name']}")
              print()
              
              print("ðŸ—‘ï¸  Deleting releases...\n")
              deleted = 0
              failed = 0
              
              for release in releases:
                  tag = release['tag_name']
                  release_id = release['id']
                  print(f"Deleting release: {tag}... ", end='', flush=True)
                  
                  delete_url = f"https://api.github.com/repos/{repo}/releases/{release_id}"
                  
                  try:
                      req = Request(delete_url, headers=headers)
                      req.get_method = lambda: 'DELETE'
                      with urlopen(req) as response:
                          if response.status == 204:
                              print("âœ… Deleted")
                              deleted += 1
                          else:
                              print(f"âŒ Failed (status: {response.status})")
                              failed += 1
                  except HTTPError as e:
                      print(f"âŒ Failed (status: {e.code})")
                      failed += 1
                  except URLError as e:
                      print(f"âŒ Network error: {e.reason}")
                      failed += 1
              
              print()
              print("â”" * 40)
              print("âœ… Deletion complete!")
              print(f"   Deleted: {deleted}")
              print(f"   Failed: {failed}")
              print("â”" * 40)
          
          if __name__ == "__main__":
              delete_all_releases()
          EOFPYTHON
          
          python3 /tmp/delete_releases.py
      
      - name: Summary
        run: |
          echo "## Release Deletion Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All releases have been deleted from the repository." >> $GITHUB_STEP_SUMMARY
          echo "This frees up significant storage space." >> $GITHUB_STEP_SUMMARY
