name: TDLib – SDK-free Build (NDK r27b, BoringSSL static, cached)

on:
  workflow_dispatch:

jobs:
  tdlib:
    runs-on: ubuntu-24.04
    env:
      NDK_VERSION: r27b
      ANDROID_PLATFORM: android-21
      BORINGSSL_DIR: .third_party/boringssl
      TD_BUILD_SCRIPT: scripts/build-tdlib-android.sh   # <— ggf. anpassen
      OUT_DIR: out

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Basis-Tools, bevor wir feeds/refs parsen
      - name: Base tools
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl git

      # 1) Neuesten TDLib-Ref via Atom-Feed bestimmen
      - name: Resolve latest TDLib ref (Atom feed)
        id: tdref
        shell: bash
        run: |
          set -euo pipefail
          feed_url="https://github.com/tdlib/td/commits/master.atom"
          html="$(curl -fsSL "$feed_url")"
          ref="$(printf '%s' "$html" | grep -oE 'https://github.com/tdlib/td/commit/[0-9a-f]+' | head -n1 | awk -F/ '{print $NF}')"
          if [[ -z "${ref:-}" ]]; then
            echo "Feed parse failed. Fallback to master." >&2
            ref="master"
          fi
          echo "ref=$ref" >> "$GITHUB_OUTPUT"
          echo "TD_REF=$ref"

      # 1b) BoringSSL-HEAD ermitteln und für Cache-Keys nutzen
      - name: Resolve latest BoringSSL HEAD
        id: bsslref
        shell: bash
        run: |
          set -euo pipefail
          ref="$(git ls-remote https://boringssl.googlesource.com/boringssl HEAD | awk '{print $1}')"
          if [[ -z "${ref:-}" ]]; then
            echo "Failed to resolve BoringSSL HEAD" >&2
            exit 1
          fi
          echo "ref=$ref" >> "$GITHUB_OUTPUT"
          echo "BSSL_REF=$ref"

      # 2) Java + neuestes CMake/Ninja (Kitware)
      - name: Setup Java (JDK 21)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Install latest CMake & Ninja
        id: tools
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y gpg lsb-release software-properties-common php build-essential
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://apt.kitware.com/keys/kitware-archive-latest.asc | sudo gpg --dearmor -o /etc/apt/keyrings/kitware-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/kitware.list
          sudo apt-get update -y
          sudo apt-get install -y cmake ninja-build
          echo "cmake=$(cmake --version | head -1 | awk '{print $3}')" >> "$GITHUB_OUTPUT"
          echo "ninja=$(ninja --version)" >> "$GITHUB_OUTPUT"
          cmake --version
          ninja --version
          javac -version

      # 3) NDK r27b – Cache + Download (SDK-frei)
      - name: Cache NDK r27b
        uses: actions/cache@v4
        id: cache-ndk
        with:
          path: .ndk/android-ndk-${{ env.NDK_VERSION }}
          key: ndk-${{ runner.os }}-${{ env.NDK_VERSION }}

      - name: Download NDK r27b (if cache miss)
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ndk
          url="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
          echo "Fetching $url"
          curl -fSLo .ndk/ndk.zip "$url"
          unzip -q .ndk/ndk.zip -d .ndk
          rm .ndk/ndk.zip

      - name: Set NDK path output
        id: ndk
        shell: bash
        run: |
          set -euo pipefail
          ndk_dir="$(pwd)/.ndk/android-ndk-${NDK_VERSION}"
          echo "ndk_dir=$ndk_dir" >> "$GITHUB_OUTPUT"
          "$ndk_dir/ndk-build" -version || true

      # 4) TDLib-Quellen – shallow, gewählte Ref
      - name: Fetch TDLib sources
        shell: bash
        run: |
          set -euo pipefail
          rm -rf td && mkdir -p td
          git init td
          cd td
          git remote add origin https://github.com/tdlib/td.git
          git fetch --depth=1 origin "${{ steps.tdref.outputs.ref }}"
          git checkout FETCH_HEAD
          echo "TDLIB_COMMIT=$(git rev-parse --short=12 HEAD)"

      # 5) BoringSSL – Cache (Install + Builds) mit BSSL_REF in Keys
      - name: Cache BoringSSL installs
        uses: actions/cache@v4
        id: cache-bssl-install
        with:
          path: |
            ${{ env.BORINGSSL_DIR }}/arm64-v8a
            ${{ env.BORINGSSL_DIR }}/armeabi-v7a
          key: bssl-install-${{ runner.os }}-${{ steps.bsslref.outputs.ref }}-${{ env.NDK_VERSION }}-${{ steps.tools.outputs.cmake }}-${{ steps.tools.outputs.ninja }}

      - name: Cache BoringSSL build dirs
        uses: actions/cache@v4
        id: cache-bssl-build
        with:
          path: |
            boringssl-build-arm64-v8a
            boringssl-build-armeabi-v7a
          key: bssl-build-${{ runner.os }}-${{ steps.bsslref.outputs.ref }}-${{ env.NDK_VERSION }}-${{ steps.tools.outputs.cmake }}-${{ steps.tools.outputs.ninja }}

      - name: Build BoringSSL (static) if missing
        if: steps.cache-bssl-install.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          NDK="${{ steps.ndk.outputs.ndk_dir }}"

          # Frische Quellen exakt auf BSSL_REF
          rm -rf boringssl-src
          git clone --depth=1 https://boringssl.googlesource.com/boringssl boringssl-src
          (cd boringssl-src && git rev-parse HEAD && test "$(git rev-parse HEAD)" = "${{ steps.bsslref.outputs.ref }}" || true)

          mkdir -p "${BORINGSSL_DIR}"

          for ABI in arm64-v8a armeabi-v7a; do
            case "$ABI" in
              arm64-v8a)  TRIPLE=aarch64-linux-android ;;
              armeabi-v7a) TRIPLE=armv7a-linux-androideabi ;;
            esac

            build_dir="$GITHUB_WORKSPACE/boringssl-build-$ABI"
            install_dir="$GITHUB_WORKSPACE/${BORINGSSL_DIR}/$ABI"

            rm -rf "$build_dir" "$install_dir"
            mkdir -p "$build_dir" "$install_dir/lib" "$install_dir/include"

            cmake -G Ninja -S "$GITHUB_WORKSPACE/boringssl-src" -B "$build_dir" \
              -DCMAKE_TOOLCHAIN_FILE="$NDK/build/cmake/android.toolchain.cmake" \
              -DANDROID_ABI="$ABI" \
              -DANDROID_PLATFORM="${ANDROID_PLATFORM}" \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
              -DBUILD_SHARED_LIBS=OFF

            # Getrennt bauen (robust gegen Race)
            cmake --build "$build_dir" --target crypto
            cmake --build "$build_dir" --target ssl

            # Robust: beide möglichen Layouts akzeptieren (Root oder Unterordner)
            CRYPTO_CANDIDATES=("$build_dir/crypto/libcrypto.a" "$build_dir/libcrypto.a")
            SSL_CANDIDATES=("$build_dir/ssl/libssl.a" "$build_dir/libssl.a")

            pick() { for p in "$@"; do [[ -f "$p" ]] && { echo "$p"; return; }; done; }

            crypto_lib="$(pick "${CRYPTO_CANDIDATES[@]}")"
            ssl_lib="$(pick "${SSL_CANDIDATES[@]}")"

            if [[ -z "${crypto_lib:-}" || -z "${ssl_lib:-}" ]]; then
              echo "❌ Static libs not found in $build_dir" >&2
              echo "Checked:" >&2
              printf ' - %s\n' "${CRYPTO_CANDIDATES[@]}" "${SSL_CANDIDATES[@]}" >&2
              echo "Listing found *.a for debugging:" >&2
              find "$build_dir" -maxdepth 3 -name "*.a" -print || true
              exit 1
            fi

            cp -f "$crypto_lib" "$install_dir/lib/libcrypto.a"
            cp -f "$ssl_lib"    "$install_dir/lib/libssl.a"
            rsync -a "$GITHUB_WORKSPACE/boringssl-src/include/" "$install_dir/include/"
          done

      # 6) TDLib – Cache der Build-Ordner
      - name: Cache TDLib build dirs
        uses: actions/cache@v4
        id: cache-td-build
        with:
          path: |
            td/build-native-java
            td/build-arm64-v8a-jni
            td/build-armeabi-v7a-jni
          key: td-build-${{ runner.os }}-${{ env.NDK_VERSION }}-${{ steps.tdref.outputs.ref }}-${{ steps.tools.outputs.cmake }}-${{ steps.tools.outputs.ninja }}

      # 7) TDLib bauen (JNI + Java + JAR) – SDK-frei
      - name: Build TDLib (JNI + Java) with BoringSSL
        shell: bash
        working-directory: td
        run: |
          set -euo pipefail
          chmod +x "$GITHUB_WORKSPACE/${TD_BUILD_SCRIPT}"
          "$GITHUB_WORKSPACE/${TD_BUILD_SCRIPT}" \
            "${{ steps.ndk.outputs.ndk_dir }}" \
            "$GITHUB_WORKSPACE/${BORINGSSL_DIR}" \
            "c++_static"

          # Reuse-Struktur für APK-Build (Workspace-sichere Pfade)
          mkdir -p "$GITHUB_WORKSPACE/apk_inputs/jniLibs/arm64-v8a" \
                   "$GITHUB_WORKSPACE/apk_inputs/jniLibs/armeabi-v7a" \
                   "$GITHUB_WORKSPACE/apk_inputs/libs"

          cp -f "$GITHUB_WORKSPACE/td/out/libs/arm64-v8a/libtdjni.so"    "$GITHUB_WORKSPACE/apk_inputs/jniLibs/arm64-v8a/"
          cp -f "$GITHUB_WORKSPACE/td/out/libs/armeabi-v7a/libtdjni.so" "$GITHUB_WORKSPACE/apk_inputs/jniLibs/armeabi-v7a/"
          cp -f "$GITHUB_WORKSPACE/td/out/tdlib-"*.jar                  "$GITHUB_WORKSPACE/apk_inputs/libs/"

      # 8) Artefakte hochladen
      - name: Upload TDLib outputs
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-outputs
          path: |
            td/out/**
            apk_inputs/**
          if-no-files-found: error
          retention-days: 14