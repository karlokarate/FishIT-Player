name: TDLib Android Prebuild

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "Quellkanal"
        type: choice
        options: [stable, edge]
        default: stable
      td_ref:
        description: "Fixe TDLib-Ref (Tag/Commit/Branch) – überschreibt channel"
        type: string
        default: ""
      abis:
        description: "ABIs: Komma-getrennt (z.B. arm64-v8a,armeabi-v7a)"
        type: string
        default: "arm64-v8a"
      api_level:
        description: "Android API-Level"
        type: number
        default: 24
      build_type:
        description: "CMake BuildType"
        type: choice
        options: [MinSizeRel, Release]
        default: MinSizeRel
      ssl:
        description: "TLS/Krypto-Basis"
        type: choice
        options: [boringssl, openssl]
        default: boringssl
      use_cache:
        description: "Compiler-Cache"
        type: choice
        options: [auto, sccache, ccache, off]
        default: auto
      make_jar:
        description: "Java-Sources.jar erzeugen?"
        type: boolean
        default: false
      ndk_version:
        description: "Android NDK-Version (SDK-Manager-Notation)"
        type: string
        default: "26.3.11579264"
      advanced:
        description: "JSON: {\"plan\":false,\"jobs\":0,\"out_dir\":\"out\",\"publish_branch\":\"prebuilt/tdlib\",\"retention_days\":30}"
        type: string
        default: ""

permissions:
  contents: write

jobs:
  build:
    name: "Build TDLib Android"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Parse advanced JSON"
        id: adv
        shell: bash
        run: |
          set -euo pipefail
          ADV_RAW="${{ inputs.advanced }}"
          if [ -z "${ADV_RAW}" ]; then ADV_RAW="{}"; fi
          echo "$ADV_RAW" | jq -e '.' >/dev/null 2>&1 || { echo "Invalid JSON for 'advanced'." >&2; exit 1; }
          PLAN=$(echo "$ADV_RAW" | jq -r '.plan // false')
          JOBS=$(echo "$ADV_RAW" | jq -r '.jobs // 0')
          OUT_DIR=$(echo "$ADV_RAW" | jq -r '.out_dir // "out"')
          PUBLISH_BRANCH=$(echo "$ADV_RAW" | jq -r '.publish_branch // "prebuilt/tdlib"')
          RETENTION=$(echo "$ADV_RAW" | jq -r '.retention_days // 30')
          echo "plan=${PLAN}" >> "$GITHUB_OUTPUT"
          echo "jobs=${JOBS}" >> "$GITHUB_OUTPUT"
          echo "out_dir=${OUT_DIR}" >> "$GITHUB_OUTPUT"
          echo "publish_branch=${PUBLISH_BRANCH}" >> "$GITHUB_OUTPUT"
          echo "retention=${RETENTION}" >> "$GITHUB_OUTPUT"

      - name: "Grund-Tools installieren"
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y curl unzip gperf ninja-build pkg-config rsync jq zip

      - name: "Android SDK manuell vorbereiten (cmdline-tools + platform-tools)"
        id: sdk
        shell: bash
        run: |
          set -euo pipefail
          SDK_ROOT="/usr/local/lib/android/sdk"
          mkdir -p "${SDK_ROOT}"
          cd "${SDK_ROOT}"

          # Neueste Commandline-Tools in eigenen Pfad 'cmdline-tools/new' installieren (keine Kollisionen)
          CT_URL="https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
          echo "Lade: ${CT_URL}"
          curl -sSL "${CT_URL}" -o cmdline.zip
          rm -rf cmdline-tools/new
          mkdir -p cmdline-tools/new
          unzip -q cmdline.zip -d cmdline-tools/new
          rm -f cmdline.zip

          export ANDROID_SDK_ROOT="${SDK_ROOT}"
          export PATH="${SDK_ROOT}/cmdline-tools/new/bin:${SDK_ROOT}/platform-tools:${PATH}"

          # BONUS: Paket-Index aktualisieren (stabilisiert nachfolgende Installs)
          yes | "${SDK_ROOT}/cmdline-tools/new/bin/sdkmanager" --sdk_root="${SDK_ROOT}" --update >/dev/null || true

          # Lizenzen + Basispaket
          yes | "${SDK_ROOT}/cmdline-tools/new/bin/sdkmanager" --sdk_root="${SDK_ROOT}" --licenses >/dev/null
          yes | "${SDK_ROOT}/cmdline-tools/new/bin/sdkmanager" --sdk_root="${SDK_ROOT}" "platform-tools"
          adb version

          # Gewünschte Platform + NDK installieren
          yes | "${SDK_ROOT}/cmdline-tools/new/bin/sdkmanager" --sdk_root="${SDK_ROOT}" "platforms;android-${{ inputs.api_level }}"
          yes | "${SDK_ROOT}/cmdline-tools/new/bin/sdkmanager" --sdk_root="${SDK_ROOT}" "ndk;${{ inputs.ndk_version }}"

          # Für Folge-Steps exportieren
          echo "ANDROID_SDK_ROOT=${SDK_ROOT}" >> "$GITHUB_ENV"
          echo "ANDROID_NDK_HOME=${SDK_ROOT}/ndk/${{ inputs.ndk_version }}" >> "$GITHUB_ENV"
          echo "PATH=${SDK_ROOT}/cmdline-tools/new/bin:${SDK_ROOT}/platform-tools:${PATH}" >> "$GITHUB_ENV"

      - name: "Java einrichten (Temurin 17)"
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: "sccache aktivieren (optional)"
        if: ${{ inputs.use_cache == 'sccache' || inputs.use_cache == 'auto' }}
        uses: Mozilla-Actions/sccache-action@v0.0.9

      - name: "ccache aktivieren (optional)"
        if: ${{ inputs.use_cache == 'ccache' }}
        uses: hendrikmuhs/ccache-action@v1.2.19
        with:
          key: "tdlib-${{ inputs.channel }}-${{ inputs.td_ref }}-ndk${{ inputs.ndk_version }}-${{ inputs.abis }}-${{ inputs.build_type }}-${{ inputs.ssl }}"
          max-size: "1G"

      - name: "Build-Skript ausführbar machen"
        shell: bash
        run: |
          set -euo pipefail
          test -f ./build-tdlib-android.sh || { echo "build-tdlib-android.sh fehlt im Repo-Root." >&2; exit 1; }
          chmod +x ./build-tdlib-android.sh

      - name: "Build starten"
        id: build
        shell: bash
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          USE_CCACHE: ${{ inputs.use_cache }}
          CHANNEL: ${{ inputs.channel }}
          TD_REF: ${{ inputs.td_ref }}
          API_LEVEL: ${{ inputs.api_level }}
          ABIS: ${{ inputs.abis }}
          BUILD_TYPE: ${{ inputs.build_type }}
          TD_SSL: ${{ inputs.ssl }}
          OUT_DIR: ${{ steps.adv.outputs.out_dir }}
          JOBS: ${{ steps.adv.outputs.jobs }}
        run: |
          set -euo pipefail
          args=()
          if [ -n "${TD_REF}" ]; then args+=( --ref "${TD_REF}" ); else args+=( --channel "${CHANNEL}" ); fi
          args+=( --abis "${ABIS}" --api-level "${API_LEVEL}" --build-type "${BUILD_TYPE}" --ssl "${TD_SSL}" --out "${OUT_DIR}" )
          if [ "${{ steps.adv.outputs.plan }}" = "true" ]; then args+=( --plan ); fi
          if [ "${{ inputs.make_jar }}" = "true" ]; then args+=( --jar ); fi
          if [ "${{ inputs.use_cache }}" = "off" ]; then args+=( --no-ccache ); fi
          if [ "${{ steps.adv.outputs.jobs }}" != "0" ]; then args+=( --jobs "${{ steps.adv.outputs.jobs }}" ); fi
          echo ">> ./build-tdlib-android.sh ${args[*]}"
          ./build-tdlib-android.sh "${args[@]}"

      - name: "Metadaten extrahieren"
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          TD_DESCRIBE=$(jq -r '.td_describe' "${{ steps.adv.outputs.out_dir }}/meta/report.json")
          TD_COMMIT=$(jq -r '.td_commit'   "${{ steps.adv.outputs.out_dir }}/meta/report.json")
          echo "td_describe=${TD_DESCRIBE}" >> "$GITHUB_OUTPUT"
          echo "td_commit=${TD_COMMIT}"     >> "$GITHUB_OUTPUT"

      - name: "Artefakte hochladen (v4)"
        uses: actions/upload-artifact@v4
        with:
          name: "tdlib-android-${{ steps.meta.outputs.td_describe }}"
          retention-days: ${{ steps.adv.outputs.retention }}
          if-no-files-found: error
          path: |
            ${{ steps.adv.outputs.out_dir }}/android/**
            ${{ steps.adv.outputs.out_dir }}/java/**
            ${{ steps.adv.outputs.out_dir }}/meta/**

      - name: "Prebuilts in Branch publishen (optional)"
        if: ${{ steps.adv.outputs.publish_branch != '' }}
        env:
          PUBLISH_BRANCH: ${{ steps.adv.outputs.publish_branch }}
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "+refs/heads/${PUBLISH_BRANCH}:refs/remotes/origin/${PUBLISH_BRANCH}" || true

          mkdir -p .publish
          cd .publish
          if git ls-remote --exit-code origin "refs/heads/${PUBLISH_BRANCH}" >/dev/null 2>&1; then
            git init
            git remote add origin "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}.git"
            git fetch origin "${PUBLISH_BRANCH}"
            git checkout -B "${PUBLISH_BRANCH}" "origin/${PUBLISH_BRANCH}"
          else
            git init
            git checkout -b "${PUBLISH_BRANCH}"
            git remote add origin "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}.git"
          fi

          TD_DESCRIBE="${{ steps.meta.outputs.td_describe }}"
          DEST="tdlib/${TD_DESCRIBE}"
          rm -rf "${DEST}"
          mkdir -p "${DEST}"
          rsync -a "${GITHUB_WORKSPACE}/${{ steps.adv.outputs.out_dir }}/" "${DEST}/"

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "Nothing to commit."
          else
            git commit -m "Publish TDLib prebuilts ${TD_DESCRIBE}"
            git push --set-upstream origin "${PUBLISH_BRANCH}"
          fi