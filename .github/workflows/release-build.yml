name: Release Build â€“ APK (arm64-v8a & armeabi-v7a)

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: "Version name (e.g., v1.0.0)"
        required: true
        type: string
      version_code:
        description: "Version code (e.g., 1)"
        required: true
        type: string
      create_release:
        description: "Create GitHub Release"
        type: boolean
        default: true
      prerelease:
        description: "Mark as pre-release"
        type: boolean
        default: false
      # Quality Tools - All optional, default to false
      run_ktlint:
        description: "Run KTLint style checker"
        type: boolean
        default: false
      run_kover:
        description: "Run Kover code coverage"
        type: boolean
        default: false
      run_semgrep:
        description: "Run Semgrep SAST"
        type: boolean
        default: false
      run_gradle_doctor:
        description: "Run Gradle build health check"
        type: boolean
        default: false
      run_android_lint:
        description: "Run Android Lint"
        type: boolean
        default: false
      run_leakcanary:
        description: "Run LeakCanary instrumentation"
        type: boolean
        default: false
      run_r8_analysis:
        description: "Run R8 code shrinker analysis"
        type: boolean
        default: false

permissions:
  contents: write
  actions: read

concurrency:
  group: release-build-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 90

    env:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx4g -XX:+UseParallelGC'"
      BUILD_START_TIME: ${{ github.event.repository.updated_at }}

    steps:
      - name: Record workflow start time
        id: start_time
        run: echo "START_TIME=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          lfs: true
          submodules: recursive

      # =========================================================
      # SPEED IMPROVEMENT: Multi-layer Caching
      # =========================================================
      
      - name: Cache Gradle wrapper
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            ~/.gradle/caches
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-wrapper-

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.m2/repository
          key: ${{ runner.os }}-gradle-deps-${{ hashFiles('**/build.gradle*', '**/gradle.properties', '**/settings.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-deps-
            ${{ runner.os }}-gradle-

      - name: Cache Android build outputs
        uses: actions/cache@v4
        with:
          path: |
            **/build/intermediates
            **/build/generated
            **/.gradle
          key: ${{ runner.os }}-android-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-android-build-

      - name: Setup Java 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.2

      - name: Install Android SDK packages
        run: |
          set -euxo pipefail
          echo ">>> Accepting SDK licenses..."
          yes | sdkmanager --licenses >/dev/null 2>&1 || true
          echo ">>> Installing SDK packages..."
          sdkmanager --no_https --update || true
          sdkmanager --install \
            "platform-tools" \
            "platforms;android-36" \
            "build-tools;35.0.0" \
            "ndk;29.0.13846066" || true
          echo "SDK installation completed."

      # =========================================================
      # QUALITY TOOLS: Initialize reports directory
      # =========================================================
      
      - name: Initialize quality reports
        run: |
          mkdir -p reports/ktlint reports/kover reports/leakcanary .github/metrics
          echo "# Quality Report - Build ${{ github.run_number }}" > quality-report.txt
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> quality-report.txt
          echo "Commit: ${{ github.sha }}" >> quality-report.txt
          echo "" >> quality-report.txt

      # =========================================================
      # QUALITY TOOL 1: KTLint
      # =========================================================
      
      - name: Run KTLint
        if: ${{ github.event.inputs.run_ktlint == 'true' }}
        continue-on-error: true
        run: |
          echo "## KTLint Check" >> quality-report.txt
          set +e
          ./gradlew ktlintCheck --no-daemon --stacktrace 2>&1 | tee reports/ktlint/ktlint-output.txt
          KTLINT_EXIT=$?
          if [ $KTLINT_EXIT -eq 0 ]; then
            echo "âœ… KTLint: PASSED - No style violations found" >> quality-report.txt
          else
            VIOLATIONS=$(grep -c "Lint error" reports/ktlint/ktlint-output.txt 2>/dev/null || echo "0")
            echo "âš ï¸ KTLint: FAILED - Found $VIOLATIONS style violations" >> quality-report.txt
          fi
          echo "" >> quality-report.txt
          exit 0

      # =========================================================
      # QUALITY TOOL 2: Kover (Code Coverage)
      # =========================================================
      
      - name: Run Kover Coverage
        if: ${{ github.event.inputs.run_kover == 'true' }}
        continue-on-error: true
        run: |
          echo "## Kover Coverage Report" >> quality-report.txt
          set +e
          ./gradlew koverXmlReport --no-daemon --stacktrace
          KOVER_EXIT=$?
          if [ $KOVER_EXIT -eq 0 ] && [ -f "build/reports/kover/report.xml" ]; then
            # Extract coverage percentage from XML if possible
            if command -v xmllint &> /dev/null; then
              COVERAGE=$(xmllint --xpath "string(//counter[@type='INSTRUCTION']/@covered)" build/reports/kover/report.xml 2>/dev/null || echo "N/A")
              echo "âœ… Kover: Coverage report generated (Coverage: $COVERAGE)" >> quality-report.txt
            else
              echo "âœ… Kover: Coverage report generated" >> quality-report.txt
            fi
            mkdir -p reports/kover
            cp -r build/reports/kover/* reports/kover/ 2>/dev/null || true
          else
            echo "âš ï¸ Kover: Failed to generate coverage report" >> quality-report.txt
          fi
          echo "" >> quality-report.txt
          exit 0

      # =========================================================
      # QUALITY TOOL 3: Semgrep SAST
      # =========================================================
      
      - name: Run Semgrep
        if: ${{ github.event.inputs.run_semgrep == 'true' }}
        continue-on-error: true
        run: |
          echo "## Semgrep SAST Analysis" >> quality-report.txt
          set +e
          # Install semgrep via pip if not available
          if ! command -v semgrep &> /dev/null; then
            pip3 install semgrep
          fi
          semgrep --config auto --json --output reports/semgrep.json . || true
          
          if [ -f "reports/semgrep.json" ]; then
            # Count findings by severity
            CRITICAL=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' reports/semgrep.json 2>/dev/null || echo "0")
            WARNING=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' reports/semgrep.json 2>/dev/null || echo "0")
            INFO=$(jq '[.results[] | select(.extra.severity == "INFO")] | length' reports/semgrep.json 2>/dev/null || echo "0")
            echo "ðŸ” Semgrep: Found $CRITICAL critical, $WARNING warnings, $INFO info" >> quality-report.txt
          else
            echo "âš ï¸ Semgrep: Failed to run analysis" >> quality-report.txt
          fi
          echo "" >> quality-report.txt
          exit 0

      # =========================================================
      # QUALITY TOOL 4: Gradle Doctor
      # =========================================================
      
      - name: Run Gradle Doctor
        if: ${{ github.event.inputs.run_gradle_doctor == 'true' }}
        continue-on-error: true
        run: |
          echo "## Gradle Doctor Health Check" >> quality-report.txt
          set +e
          # Note: Gradle Doctor requires plugin installation in build.gradle
          # For now, we'll run a basic health check
          ./gradlew help --scan --no-daemon 2>&1 | tee reports/gradle-doctor.txt || true
          
          if [ -f "reports/gradle-doctor.txt" ]; then
            # Look for common issues
            DEPRECATIONS=$(grep -ci "deprecated" reports/gradle-doctor.txt 2>/dev/null || echo "0")
            echo "â„¹ï¸ Gradle Doctor: Found $DEPRECATIONS deprecation warnings" >> quality-report.txt
            echo "   Full report available in gradle-doctor.txt" >> quality-report.txt
          else
            echo "âš ï¸ Gradle Doctor: No report generated" >> quality-report.txt
          fi
          echo "" >> quality-report.txt
          exit 0

      # =========================================================
      # QUALITY TOOL 5: Android Lint
      # =========================================================
      
      - name: Run Android Lint
        if: ${{ github.event.inputs.run_android_lint == 'true' }}
        continue-on-error: true
        run: |
          echo "## Android Lint Analysis" >> quality-report.txt
          set +e
          ./gradlew lintVitalRelease --no-daemon --stacktrace
          LINT_EXIT=$?
          
          # Find and summarize lint results
          LINT_HTML=$(find app/build/reports -name "lint-results-*.html" 2>/dev/null | head -1)
          LINT_XML=$(find app/build/reports -name "lint-results-*.xml" 2>/dev/null | head -1)
          
          if [ -n "$LINT_XML" ] && [ -f "$LINT_XML" ]; then
            ERRORS=$(grep -c 'severity="Error"' "$LINT_XML" 2>/dev/null || echo "0")
            WARNINGS=$(grep -c 'severity="Warning"' "$LINT_XML" 2>/dev/null || echo "0")
            INFO=$(grep -c 'severity="Information"' "$LINT_XML" 2>/dev/null || echo "0")
            echo "ðŸ”Ž Android Lint: $ERRORS errors, $WARNINGS warnings, $INFO info" >> quality-report.txt
          else
            echo "âœ… Android Lint: Analysis completed" >> quality-report.txt
          fi
          echo "" >> quality-report.txt
          exit 0

      # =========================================================
      # QUALITY TOOL 6: LeakCanary (Stub - requires emulator)
      # =========================================================
      
      - name: Run LeakCanary Tests
        if: ${{ github.event.inputs.run_leakcanary == 'true' }}
        continue-on-error: true
        run: |
          echo "## LeakCanary Leak Detection" >> quality-report.txt
          # TODO: This requires an emulator setup which is resource-intensive
          # For now, we'll create a placeholder
          echo "âš ï¸ LeakCanary: Emulator-based testing not yet implemented" >> quality-report.txt
          echo "   This requires Android emulator setup for instrumentation tests" >> quality-report.txt
          echo "" >> quality-report.txt
          # Future implementation:
          # - Start emulator
          # - ./gradlew connectedDebugAndroidTest
          # - Pull LeakCanary reports from device
          exit 0

      # =========================================================
      # Build step (before R8 analysis)
      # =========================================================


      - name: Decode signing keystore
        env:
          KS_B64: ${{ secrets.ANDROID_SIGNING_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
          if [[ -z "${KS_B64:-}" ]]; then
            echo "::warning::Keystore secret is empty - build will be unsigned"
            exit 0
          fi
          
          val="${KS_B64#base64:}"; val="${val#base64,}"
          val="$(printf '%s' "$val" | tr -d ' \n\r\t')"
          
          if printf '%s' "$val" | base64 -d > release.keystore 2>/dev/null; then
            echo "Keystore decoded successfully"
          else
            echo "::error::Invalid Base64 in keystore secret"
            exit 1
          fi
          
          if [[ -f release.keystore ]]; then
            {
              echo "MYAPP_UPLOAD_STORE_FILE=$PWD/release.keystore"
              echo "MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.ANDROID_SIGNING_KEYSTORE_PASSWORD }}"
              echo "MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.ANDROID_SIGN_KEY_ALIAS || secrets.ANDROID_SIGNING_KEY_ALIAS }}"
              echo "MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}"
            } >> "$GITHUB_ENV"
          else
            echo "::warning::Keystore file not found - build will be unsigned"
          fi

      - name: Build release APK for BOTH ARM ABIs
        id: build_apk
        run: |
          echo "BUILD_CONFIG_START=$(date +%s)" >> $GITHUB_OUTPUT
          
          # Build for arm64-v8a
          echo "Building for arm64-v8a..."
          ./gradlew :app:assembleRelease \
            -PabiFilters=arm64-v8a \
            -PuseSplits=true \
            -PuniversalApk=false \
            -PversionCode=${{ github.event.inputs.version_code }} \
            -PversionName=${{ github.event.inputs.version_name }} \
            --build-cache \
            --parallel \
            --stacktrace \
            --warning-mode all \
            -x test
          
          # Build for armeabi-v7a
          echo "Building for armeabi-v7a..."
          ./gradlew :app:assembleRelease \
            -PabiFilters=armeabi-v7a \
            -PuseSplits=true \
            -PuniversalApk=false \
            -PversionCode=${{ github.event.inputs.version_code }} \
            -PversionName=${{ github.event.inputs.version_name }} \
            --build-cache \
            --parallel \
            --stacktrace \
            --warning-mode all \
            -x test
          
          echo "BUILD_CONFIG_END=$(date +%s)" >> $GITHUB_OUTPUT
        env:
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}

      # =========================================================
      # QUALITY TOOL 7: R8 Analysis
      # =========================================================
      
      - name: Run R8 Analysis
        if: ${{ github.event.inputs.run_r8_analysis == 'true' }}
        continue-on-error: true
        run: |
          echo "## R8 Code Shrinker Analysis" >> quality-report.txt
          
          # Collect R8/ProGuard mapping files
          if [ -f "app/build/outputs/mapping/release/mapping.txt" ]; then
            MAPPING_SIZE=$(wc -l < app/build/outputs/mapping/release/mapping.txt)
            echo "ðŸ“Š R8: ProGuard mapping has $MAPPING_SIZE lines" >> quality-report.txt
            
            # Try to estimate classes kept/removed
            if [ -f "app/build/outputs/mapping/release/usage.txt" ]; then
              echo "   R8 usage report available" >> quality-report.txt
            fi
            
            # Copy reports for artifact
            mkdir -p reports/r8
            cp app/build/outputs/mapping/release/* reports/r8/ 2>/dev/null || true
            echo "   Full R8 reports available in artifact" >> quality-report.txt
          else
            echo "âš ï¸ R8: No mapping file found (R8 may be disabled)" >> quality-report.txt
          fi
          echo "" >> quality-report.txt
          exit 0

      - name: Verify APK signature
        run: |
          find app/build/outputs/apk/release -type f -name "*.apk" -print0 | \
            xargs -0 -I{} bash -c 'apksigner verify --verbose "{}" || true'

      - name: Calculate checksums
        run: |
          find app/build/outputs/apk/release -type f -name "*.apk" -print0 | \
            xargs -0 sha256sum > checksums-all.txt
          cat checksums-all.txt

      # =========================================================
      # SPEED METRICS: Measure and record build times
      # =========================================================
      
      - name: Calculate build metrics
        id: metrics
        run: |
          END_TIME=$(date +%s)
          START_TIME=${{ steps.start_time.outputs.START_TIME }}
          TOTAL_TIME=$((END_TIME - START_TIME))
          
          BUILD_START=${{ steps.build_apk.outputs.BUILD_CONFIG_START || '0' }}
          BUILD_END=${{ steps.build_apk.outputs.BUILD_CONFIG_END || '0' }}
          BUILD_TIME=$((BUILD_END - BUILD_START))
          
          # Create metrics JSON
          cat > .github/metrics/build_speed.json <<EOF
          {
            "workflow_run": "${{ github.run_number }}",
            "total_time_seconds": $TOTAL_TIME,
            "build_time_seconds": $BUILD_TIME,
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "runner": "${{ runner.os }}"
          }
          EOF
          
          echo "TOTAL_TIME=$TOTAL_TIME" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
          
          cat .github/metrics/build_speed.json

      # =========================================================
      # SPEED COACHING: Generate summary
      # =========================================================
      
      - name: Generate Speed Coaching Summary
        run: |
          TOTAL_TIME=${{ steps.metrics.outputs.TOTAL_TIME }}
          BUILD_TIME=${{ steps.metrics.outputs.BUILD_TIME }}
          
          # Estimate cache effectiveness (simplified)
          CACHE_HINT="Using multi-layer caching (Gradle, Maven, Android build)"
          ESTIMATED_SAVING="First run establishes cache. Subsequent runs should be 30-50% faster."
          
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âš¡ Speed Coaching Summary
          
          ### Build Performance
          - **Total CI Time**: ${TOTAL_TIME}s ($(($TOTAL_TIME / 60))m $(($TOTAL_TIME % 60))s)
          - **Build Time**: ${BUILD_TIME}s ($(($BUILD_TIME / 60))m $(($BUILD_TIME % 60))s)
          - **Workflow Run**: #${{ github.run_number }}
          
          ### Caching Strategy
          $CACHE_HINT
          
          ### Performance Notes
          $ESTIMATED_SAVING
          
          **Tip**: Enable quality tools selectively to balance speed vs. coverage.
          EOF

      # =========================================================
      # QUALITY SUMMARY: Add to GitHub Step Summary
      # =========================================================
      
      - name: Generate Quality Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          
          ## ðŸ” Quality Tools Summary
          
          ### Tools Enabled This Run
          - KTLint: ${{ github.event.inputs.run_ktlint }}
          - Kover: ${{ github.event.inputs.run_kover }}
          - Semgrep: ${{ github.event.inputs.run_semgrep }}
          - Gradle Doctor: ${{ github.event.inputs.run_gradle_doctor }}
          - Android Lint: ${{ github.event.inputs.run_android_lint }}
          - LeakCanary: ${{ github.event.inputs.run_leakcanary }}
          - R8 Analysis: ${{ github.event.inputs.run_r8_analysis }}
          
          ### Detailed Results
          See the \`quality-report.txt\` in the \`quality-artifacts\` for detailed findings.
          EOF
          
          # Append quality report content if any tools ran
          if [ -f "quality-report.txt" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Quick Summary" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat quality-report.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apks
          path: |
            app/build/outputs/apk/release/*.apk
            checksums-all.txt
          retention-days: 30
          if-no-files-found: error

      - name: Upload ProGuard mapping
        uses: actions/upload-artifact@v4
        with:
          name: proguard-mapping
          path: app/build/outputs/mapping/release/mapping.txt
          retention-days: 90
          if-no-files-found: warn

      - name: Upload build speed report
        uses: actions/upload-artifact@v4
        with:
          name: build-speed-report
          path: .github/metrics/build_speed.json
          retention-days: 90
          if-no-files-found: warn

      - name: Upload quality artifacts
        uses: actions/upload-artifact@v4
        if: |
          github.event.inputs.run_ktlint == 'true' || 
          github.event.inputs.run_kover == 'true' || 
          github.event.inputs.run_semgrep == 'true' || 
          github.event.inputs.run_gradle_doctor == 'true' || 
          github.event.inputs.run_android_lint == 'true' || 
          github.event.inputs.run_leakcanary == 'true' || 
          github.event.inputs.run_r8_analysis == 'true'
        with:
          name: quality-artifacts
          path: |
            quality-report.txt
            reports/ktlint/**
            reports/kover/**
            reports/semgrep.json
            reports/gradle-doctor.txt
            app/build/reports/lint-results*
            reports/leakcanary/**
            reports/r8/**
          retention-days: 30
          if-no-files-found: ignore

  create-release:
    needs: build
    if: ${{ github.event.inputs.create_release == 'true' }}
    runs-on: ubuntu-24.04
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Find and rename APKs with ABI suffix
          # Since both ABIs are now in app-release-apks artifact
          cd artifacts/app-release-apks
          for apk in *.apk; do
            # Extract ABI from filename if present, otherwise copy as-is
            if [[ "$apk" =~ arm64-v8a ]]; then
              cp "$apk" "../../release-assets/FishIT-Player-${{ github.event.inputs.version_name }}-arm64-v8a.apk"
            elif [[ "$apk" =~ armeabi-v7a ]]; then
              cp "$apk" "../../release-assets/FishIT-Player-${{ github.event.inputs.version_name }}-armeabi-v7a.apk"
            fi
          done
          cd ../..
          
          # Copy checksums
          cp artifacts/app-release-apks/checksums-all.txt release-assets/checksums.txt 2>/dev/null || true
          
          # List release assets
          ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version_name }}
          name: FishIT Player ${{ github.event.inputs.version_name }}
          body: |
            ## FishIT Player ${{ github.event.inputs.version_name }}
            
            ### Downloads
            - **arm64-v8a**: For modern 64-bit ARM devices (recommended)
            - **armeabi-v7a**: For older 32-bit ARM devices
            
            ### Build Information
            - Version: ${{ github.event.inputs.version_name }}
            - Version Code: ${{ github.event.inputs.version_code }}
            - Built from: ${{ github.sha }}
            - Build Date: ${{ github.event.repository.updated_at }}
            
            ### Dependencies
            - TDLib: Using `dev.g000sha256:tdl-coroutines-android:5.0.0` from Maven Central
            
            ### Installation
            1. Download the appropriate APK for your device architecture
            2. Enable "Install from unknown sources" in your device settings
            3. Install the APK
            
            ### Checksums
            See `checksums.txt` for SHA256 hashes of all APKs.
          files: |
            release-assets/*.apk
            release-assets/checksums.txt
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          fail_on_unmatched_files: true
